/**
 * åœ¨è©¦ç®—è¡¨æ‰“é–‹æ™‚å‰µå»ºæ‰€æœ‰è‡ªå®šç¾©èœå–®ï¼ˆæ•´åˆç‰ˆï¼‰
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  
  // ä¸»åŠŸèƒ½é¸å–®ç¾¤çµ„
  ui.createMenu('ğŸ‘¤ å€‹åˆ¥è«®å•†')
    .addItem('ğŸ†• åˆæ¬¡é ç´„', 'showFirstAppointmentDialog')
    .addItem('ğŸ”„ å€‹æ¡ˆçºŒç´„', 'showClientRenewalDialog')
    .addItem('â±ï¸ èª¿æ•´é ç´„æ™‚é–“', 'showRescheduleDialog')
    .addItem('ğŸšª èª¿æ•´è«®å•†ç©ºé–“', 'showChangeRoomDialog')
    .addItem('âŒ å–æ¶ˆé ç´„', 'showCancelDialog')
    .addItem('ğŸ’° ç¹³äº¤ä¿è­‰é‡‘', 'showDepositPaymentDialog')
    .addToUi();
  
  ui.createMenu('ğŸ‘¥ åœ˜é«”è«®å•†')
    .addItem('ğŸ“… é ç´„åœ˜é«”', 'showGroupReservationDialog')
    .addItem('ğŸ“… é ç´„è¬›åº§', 'showWorkshopReservationDialog')
    .addItem('âŒ å–æ¶ˆåœ˜é«”', 'showCancelGroupDialog')
    .addToUi();

  ui.createMenu('âœï¸ å€‹æ¡ˆç®¡ç†')
    .addItem('ğŸ‘©â€ğŸ‘¦ å€‹æ¡ˆå¾…è¾¦äº‹é …', 'viewClientTodos')
    .addItem('ğŸ’° ä¿è­‰é‡‘æª¢æ ¸', 'showDepositCheck')
    .addItem('ğŸ“ˆ æŸ¥çœ‹ç³»çµ±æ—¥èªŒ', 'showSystemLogDialog')
    .addToUi();

  ui.createMenu('âš™ï¸ ç³»çµ±è¨­å®š')
    .addItem('ğŸ’² ä¿è­‰é‡‘æ¢ä»¶è¨­å®š', 'showDepositConditionsDialog')
    .addItem('ğŸ“ å¢åŠ å€‹æ¡ˆæœå‹™æ¬¡æ•¸', 'showAddClientServiceRecord')
    .addItem('ğŸ“‹ è¨Šæ¯æ­·å²è¨˜éŒ„', 'showMessageHistory')
    .addToUi();
  // å‚™ä»½ç³»çµ±ï¼ˆæœ€å¾Œæ·»åŠ ï¼‰
  ui.createMenu('ğŸ”§ å‚™ä»½ç³»çµ±')
    .addItem('ç«‹å³å‚™ä»½', 'manualBackup')
    .addItem('å‚™ä»½è¨­å®š', 'showBackupSettingsDialog')
    .addItem('å‚™ä»½ç‹€æ…‹', 'showBackupStatusDialog')
    .addSeparator()
    .addItem('å®‰è£å‚™ä»½è§¸ç™¼å™¨', 'installBackupTriggers')
    .addItem('ç§»é™¤å‚™ä»½è§¸ç™¼å™¨', 'deleteAllBackupTriggers')
    .addToUi();
}

/**
 * é¡¯ç¤ºåœ˜é«”é ç´„å°è©±æ¡†
 */
function showGroupReservationDialog() {
  // ç²å–å„é …ä¸‹æ‹‰é¸å–®çš„é¸é …
  const counselors = getCounselorList();
  const rooms = getRoomList();
  
  const counselorOptions = counselors.map(counselor => 
    `<option value="${counselor}">${counselor}</option>`).join('');
  const roomOptions = rooms.map(room => 
    `<option value="${room}">${room}</option>`).join('');
  
  var html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">é ç´„åœ˜é«”</h2>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">åœ˜é«”åç¨±ï¼š</label><br>
        <input type="text" id="groupName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥åœ˜é«”åç¨±">
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">å¸¶é ˜è€…ï¼š</label><br>
        <select id="counselor" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡å¸¶é ˜è€…</option>
          ${counselorOptions}
        </select>
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">è«®å•†å®¤ï¼š</label><br>
        <select id="room" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡è«®å•†å®¤</option>
          ${roomOptions}
        </select>
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">æ˜¯å¦ç‚ºå¸¶ç‹€åœ˜é«”ï¼š</label><br>
        <input type="checkbox" id="isSeriesGroup" style="margin-top: 8px;"> æ˜¯
      </div>
      
      <div id="sessionsContainer">
        <h3 style="color: #4285f4; margin-top: 20px;">åœ˜é«”å ´æ¬¡</h3>
        <div id="sessionsList">
          <div class="session-item" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
            <div style="margin: 10px 0;">
              <label style="font-weight: bold;">æ—¥æœŸï¼š</label><br>
              <input type="date" class="session-date" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 10px 0; display: flex; justify-content: space-between;">
              <div style="width: 48%;">
                <label style="font-weight: bold;">é–‹å§‹æ™‚é–“ï¼š</label><br>
                <select class="session-start-hour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  ${generateHourOptions()}
                </select>
                <select class="session-start-minute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="00">00</option>
                  <option value="30">30</option>
                </select>
              </div>
              <div style="width: 48%;">
                <label style="font-weight: bold;">çµæŸæ™‚é–“ï¼š</label><br>
                <select class="session-end-hour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  ${generateHourOptions()}
                </select>
                <select class="session-end-minute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="00">00</option>
                  <option value="30">30</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div style="margin: 15px 0; text-align: center;">
          <button onclick="addNewSession()" style="background-color: #34a853; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
            + æ–°å¢å ´æ¬¡
          </button>
        </div>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitGroupReservation()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªé ç´„</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      let sessionCount = 1;
      
      function addNewSession() {
        sessionCount++;
        const sessionItem = document.createElement('div');
        sessionItem.className = 'session-item';
        sessionItem.style = 'border: 1px solid #ddd; padding: 10px; border-radius: 4px; margin-bottom: 10px; position: relative;';
        
        sessionItem.innerHTML = \`
          <div style="position: absolute; top: 5px; right: 5px;">
            <button onclick="removeSession(this)" style="background-color: #db4437; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
          </div>
          <div style="margin: 10px 0;">
            <label style="font-weight: bold;">æ—¥æœŸï¼š</label><br>
            <input type="date" class="session-date" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin: 10px 0; display: flex; justify-content: space-between;">
            <div style="width: 48%;">
              <label style="font-weight: bold;">é–‹å§‹æ™‚é–“ï¼š</label><br>
              <select class="session-start-hour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                ${generateHourOptions()}
              </select>
              <select class="session-start-minute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="00">00</option>
                <option value="30">30</option>
              </select>
            </div>
            <div style="width: 48%;">
              <label style="font-weight: bold;">çµæŸæ™‚é–“ï¼š</label><br>
              <select class="session-end-hour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                ${generateHourOptions()}
              </select>
              <select class="session-end-minute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="00">00</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
        \`;
        
        document.getElementById('sessionsList').appendChild(sessionItem);
      }
      
      function removeSession(button) {
        const sessionItem = button.closest('.session-item');
        sessionItem.remove();
      }
      
      function submitGroupReservation() {
        const groupName = document.getElementById('groupName').value;
        const counselor = document.getElementById('counselor').value;
        const room = document.getElementById('room').value;
        const isSeriesGroup = document.getElementById('isSeriesGroup').checked;
        
        if (!groupName || !counselor || !room) {
          showMessage('è«‹å¡«å¯«åœ˜é«”åç¨±ã€å¸¶é ˜è€…å’Œè«®å•†å®¤', 'error');
          return;
        }
        
        // æ”¶é›†æ‰€æœ‰å ´æ¬¡è³‡æ–™
        const sessionItems = document.querySelectorAll('.session-item');
        const sessions = [];
        
        for (let i = 0; i < sessionItems.length; i++) {
          const item = sessionItems[i];
          const date = item.querySelector('.session-date').value;
          const startHour = item.querySelector('.session-start-hour').value;
          const startMinute = item.querySelector('.session-start-minute').value;
          const endHour = item.querySelector('.session-end-hour').value;
          const endMinute = item.querySelector('.session-end-minute').value;
          
          if (!date || !startHour || !endHour) {
            showMessage(\`è«‹å¡«å¯«ç¬¬ \${i+1} å ´æ¬¡çš„æ‰€æœ‰æ™‚é–“è³‡è¨Š\`, 'error');
            return;
          }
          
          // æª¢æŸ¥çµæŸæ™‚é–“æ˜¯å¦æ™šæ–¼é–‹å§‹æ™‚é–“
          const startTime = parseInt(startHour) * 60 + parseInt(startMinute);
          const endTime = parseInt(endHour) * 60 + parseInt(endMinute);
          
          if (endTime <= startTime) {
            showMessage(\`ç¬¬ \${i+1} å ´æ¬¡çš„çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“\`, 'error');
            return;
          }
          
          sessions.push({
            date: date,
            startTime: startHour + ':' + startMinute,
            endTime: endHour + ':' + endMinute,
            sessionNumber: i + 1
          });
        }
        
        if (sessions.length === 0) {
          showMessage('è«‹è‡³å°‘æ–°å¢ä¸€å€‹åœ˜é«”å ´æ¬¡', 'error');
          return;
        }
        
        document.getElementById('message').style.display = 'none';
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        showLoading();
        
        google.script.run
          .withSuccessHandler(function(result) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            if (result.success) {
              showMessage('åœ˜é«”é ç´„å·²æˆåŠŸå»ºç«‹ï¼', 'success');
              setTimeout(function() {
                google.script.host.close();
              }, 2000);
            } else {
              showMessage(result.message || 'é ç´„å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .processGroupReservation(groupName, counselor, room, isSeriesGroup, sessions);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(450)
    .setHeight(650);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'é ç´„åœ˜é«”');
}

/**
 * è™•ç†åœ˜é«”é ç´„è«‹æ±‚
 * @param {string} groupName - åœ˜é«”åç¨±
 * @param {string} counselor - å¸¶é ˜è€…å§“å
 * @param {string} room - è«®å•†å®¤
 * @param {boolean} isSeriesGroup - æ˜¯å¦ç‚ºå¸¶ç‹€åœ˜é«”
 * @param {Array} sessions - åœ˜é«”å ´æ¬¡è³‡æ–™
 * @return {Object} è™•ç†çµæœ
 */
function processGroupReservation(groupName, counselor, room, isSeriesGroup, sessions) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const now = new Date();
    
    // æª¢æŸ¥æ‰€æœ‰å ´æ¬¡çš„æ™‚é–“è¡çª
    for (let i = 0; i < sessions.length; i++) {
      const session = sessions[i];
      const sessionDate = new Date(session.date);
      const startTime = session.startTime;
      const endTime = session.endTime;
      
      // æª¢æŸ¥è«®å•†å®¤åœ¨è©²æ™‚æ®µæ˜¯å¦å¯ç”¨
      const roomAvailable = checkRoomAvailabilityForGroup(sessionDate, startTime, endTime, room);
      if (!roomAvailable) {
        // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
        logSystemActivity(
          "åœ˜é«”é ç´„",
          groupName,
          `åœ˜é«”é ç´„å¤±æ•—: ç¬¬ ${i+1} å ´æ¬¡æ™‚æ®µè¡çª`,
          "å¤±æ•—",
          counselor,
          `è¡çªå ´æ¬¡: ${session.date} ${startTime}-${endTime}, è«®å•†å®¤: ${room}`
        );
        return { 
          success: false, 
          message: `ç¬¬ ${i+1} å ´æ¬¡ (${session.date} ${startTime}-${endTime}) è«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“æˆ–è«®å•†å®¤` 
        };
      }
    }
    
    // æ‰€æœ‰å ´æ¬¡éƒ½ç„¡è¡çªï¼Œé–‹å§‹å»ºç«‹é ç´„
    for (let i = 0; i < sessions.length; i++) {
      const session = sessions[i];
      const sessionDate = new Date(session.date);
      const startTime = session.startTime;
      const endTime = session.endTime;
      const sessionNumber = session.sessionNumber;
      
      // ä½¿ç”¨ appendRow æ·»åŠ è³‡æ–™
      sheet.appendRow([
        now,                // æ™‚é–“æˆ³è¨˜
        groupName,          // åœ˜é«”åç¨±
        sessionDate,        // è«®å•†æ—¥æœŸ
        counselor,          // å¸¶é ˜è€…
        "åœ˜é«”è«®å•†",          // æœå‹™æ–¹æ¡ˆ
        startTime + "-" + endTime, // æ™‚é–“ç¯„åœ
        room,               // è«®å•†å®¤
        "åœ˜é«”",              // æ¨™è¨˜ç‚ºåœ˜é«”
        isSeriesGroup ? "å¸¶ç‹€åœ˜é«”" : "å–®æ¬¡åœ˜é«”", // åœ˜é«”é¡å‹
        sessionNumber       // å ´æ¬¡ç·¨è™Ÿ
      ]);
      
      // å‰µå»ºæ—¥æ›†äº‹ä»¶
      createGroupCalendarEvent(
        groupName, 
        sessionDate, 
        startTime, 
        endTime, 
        counselor, 
        room, 
        isSeriesGroup,
        sessionNumber
      );
    }
    
    // æ ¹æ“šæ™‚é–“æˆ³è¨˜å°è³‡æ–™é€²è¡Œæ’åº
    sortDataByTimestamp(sheet);
    
    // æ›´æ–°çµ±è¨ˆå ±è¡¨
    updateStatistics();
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
    const sessionDetails = sessions.map(session => 
      `${session.date} ${session.startTime}-${session.endTime}`).join(', ');
    
    logSystemActivity(
      "åœ˜é«”é ç´„",
      groupName,
      `å¸¶é ˜è€…: ${counselor}, è«®å•†å®¤: ${room}, å ´æ¬¡: ${sessionDetails}`,
      "æˆåŠŸ",
      counselor,
      `åœ˜é«”é¡å‹: ${isSeriesGroup ? 'å¸¶ç‹€åœ˜é«”' : 'å–®æ¬¡åœ˜é«”'}, å…±${sessions.length}å ´æ¬¡`
    );

    return { success: true };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "åœ˜é«”é ç´„",
      groupName,
      `åœ˜é«”é ç´„å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    // ã€æ–°å¢ã€‘åœ˜é«”é ç´„æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
    sessions.forEach(session => {
      createHelperTodoItem(
        OPERATION_TYPES.GROUP_RESERVATION,
        groupName,
        {
          date: session.date,
          time: session.startTime,
          therapist: counselor,
          room: room,
          serviceType: "åœ˜é«”è«®å•†",
          additionalInfo: `åœ˜é«”åç¨±ï¼š${groupName}, å ´æ¬¡ï¼š${session.sessionNumber}`
        }
      );
    }); 
    Logger.log("è™•ç†åœ˜é«”é ç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†é ç´„æ™‚å‡ºç¾éŒ¯èª¤: ' + error.toString() };
  }
}

/**
 * æª¢æŸ¥è«®å•†å®¤åœ¨æŒ‡å®šæ™‚æ®µæ˜¯å¦å¯ç”¨ï¼ˆåœ˜é«”é ç´„ï¼‰
 * @param {Date} date - é ç´„æ—¥æœŸ
 * @param {string} startTimeString - é–‹å§‹æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} endTimeString - çµæŸæ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} room - è«®å•†å®¤åç¨±
 * @return {boolean} è«®å•†å®¤æ˜¯å¦å¯ç”¨
 */
function checkRoomAvailabilityForGroup(date, startTimeString, endTimeString, room) {
  try {
    // å¾ç³»çµ±è¨­å®šç²å–æ—¥æ›†ID
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [startHours, startMinutes] = startTimeString.split(':').map(Number);
    const [endHours, endMinutes] = endTimeString.split(':').map(Number);
    
    // è¨­å®šè«®å•†çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
    const startTime = new Date(date);
    startTime.setHours(startHours);
    startTime.setMinutes(startMinutes);
    startTime.setSeconds(0);
    
    const endTime = new Date(date);
    endTime.setHours(endHours);
    endTime.setMinutes(endMinutes);
    endTime.setSeconds(0);
    
    // å®šç¾©æª¢æŸ¥ç¯„åœï¼šåŒ…æ‹¬å‰å¾Œå¯èƒ½é‡ç–Šçš„æ™‚é–“
    // é–‹å§‹æª¢æŸ¥ç¯„åœï¼šç•¶å¤©0é»
    const dayStart = new Date(date);
    dayStart.setHours(0, 0, 0, 0);
    
    // çµæŸæª¢æŸ¥ç¯„åœï¼šç•¶å¤©23:59
    const dayEnd = new Date(date);
    dayEnd.setHours(23, 59, 59, 999);
    
    // ç²å–ç•¶å¤©æ‰€æœ‰äº‹ä»¶
    const events = calendar.getEvents(dayStart, dayEnd);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èˆ‡ç•¶å‰æ™‚æ®µé‡ç–Šçš„åŒä¸€è«®å•†å®¤çš„é ç´„
    for (let event of events) {
      const title = event.getTitle();
      const desc = event.getDescription();
      
      // åªæª¢æŸ¥æœªå–æ¶ˆå’Œæœªæ”¹æœŸçš„äº‹ä»¶
      if (!title.includes("ã€å–æ¶ˆã€‘") && !title.includes("ã€æ”¹æœŸã€‘")) {
        // æª¢æŸ¥è«®å•†å®¤æ˜¯å¦ç›¸åŒ
        if (title.includes(`- ${room}`) || desc.includes(`è«®å•†å®¤: ${room}`)) {
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦é‡ç–Š
          const eventStart = event.getStartTime();
          const eventEnd = event.getEndTime();
          
          // æª¢æŸ¥é‡ç–Šçš„æƒ…æ³ï¼š
          // 1. æ–°é ç´„çš„é–‹å§‹æ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 2. æ–°é ç´„çš„çµæŸæ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 3. æ–°é ç´„æ©«è·¨ç¾æœ‰é ç´„ï¼ˆæ–°é ç´„é–‹å§‹æ™‚é–“æ—©æ–¼ç¾æœ‰é ç´„ï¼ŒçµæŸæ™‚é–“æ™šæ–¼ç¾æœ‰é ç´„ï¼‰
          if ((startTime >= eventStart && startTime < eventEnd) || 
              (endTime > eventStart && endTime <= eventEnd) ||
              (startTime <= eventStart && endTime >= eventEnd)) {
            return false; // æ™‚æ®µé‡ç–Šï¼Œè«®å•†å®¤ä¸å¯ç”¨
          }
        }
      }
    }
    
    return true; // è«®å•†å®¤å¯ç”¨
  } catch (error) {
    Logger.log("æª¢æŸ¥åœ˜é«”è«®å•†å®¤å¯ç”¨æ€§æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    // å‡ºéŒ¯æ™‚è¿”å›falseä¿å®ˆè™•ç†
    return false;
  }
}

/**
 * å‰µå»ºåœ˜é«”æ—¥æ›†äº‹ä»¶ (å¼·åˆ¶è¨­å®šé¡è‰²ç‰ˆ)
 * @param {string} groupName - åœ˜é«”åç¨±
 * @param {Date} date - è«®å•†æ—¥æœŸ
 * @param {string} startTimeString - é–‹å§‹æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} endTimeString - çµæŸæ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} counselor - å¸¶é ˜è€…å§“å
 * @param {string} room - è«®å•†å®¤
 * @param {boolean} isSeriesGroup - æ˜¯å¦ç‚ºå¸¶ç‹€åœ˜é«”
 * @param {number} sessionNumber - å ´æ¬¡ç·¨è™Ÿ
 * @return {CalendarEvent|null} å‰µå»ºçš„æ—¥æ›†äº‹ä»¶
 */
function createGroupCalendarEvent(groupName, date, startTimeString, endTimeString, counselor, room, isSeriesGroup, sessionNumber) {
  try {
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    const [startHours, startMinutes] = startTimeString.split(':').map(Number);
    const [endHours, endMinutes] = endTimeString.split(':').map(Number);
    
    const startTime = new Date(date);
    startTime.setHours(startHours, startMinutes, 0);
    
    const endTime = new Date(date);
    endTime.setHours(endHours, endMinutes, 0);
    
    const sessionLabel = isSeriesGroup ? `-${sessionNumber}` : '';
    const title = `ã€åœ˜é«”ã€‘${groupName}${sessionLabel}ï¼ˆ${counselor}ï¼‰- ${room}`;
    
    const description = `åœ˜é«”åç¨±: ${groupName}\nå¸¶é ˜è€…: ${counselor}\nè«®å•†å®¤: ${room}\nåœ˜é«”é¡å‹: ${isSeriesGroup ? 'å¸¶çŠ¶åœ˜é«”' : 'å–®æ¬¡åœ˜é«”'}\nå ´æ¬¡: ${sessionNumber}`;
    
    // ã€ä¿®æ”¹è™•ã€‘å…ˆå»ºç«‹äº‹ä»¶ï¼Œä½†ä¸æŒ‡å®šé¡è‰²
    const event = calendar.createEvent(title, startTime, endTime, {
      description: description,
      location: room
    });
    
    // ã€æ–°å¢è™•ã€‘å¦‚æœäº‹ä»¶æˆåŠŸå»ºç«‹ï¼Œç«‹åˆ»å¼·åˆ¶è¨­å®šé¡è‰²ç‚ºç´«è‰²
    if (event) {
      event.setColor(CalendarApp.EventColor.MAUVE); 
      Logger.log("åœ˜é«”äº‹ä»¶å‰µå»ºä¸¦æˆåŠŸè¨­å®šé¡è‰²ç‚ºç´«è‰²ï¼");
    }
    
    return event;
  } catch (error) {
    Logger.log("å‰µå»ºåœ˜é«”æ—¥æ›†äº‹ä»¶éŒ¯èª¤ï¼š" + error.toString());
    return null;
  }
}

/**
 * é¡¯ç¤ºå–æ¶ˆåœ˜é«”å°è©±æ¡†
 */
function showCancelGroupDialog() {
  var html = `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 20px;
        }
        .form-group {
          margin-bottom: 15px;
        }
        label {
          font-weight: bold;
          display: block;
          margin-bottom: 5px;
        }
        input[type="text"], 
        input[type="date"], 
        textarea {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          box-sizing: border-box;
        }
        textarea {
          height: 80px;
          resize: vertical;
        }
        .radio-group {
          margin-top: 5px;
        }
        .button-group {
          margin-top: 20px;
          text-align: center;
        }
        .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 10px;
        }
        .btn-danger {
          background-color: #db4437;
          color: white;
        }
        .btn-default {
          background-color: #f1f1f1;
        }
        #message {
          margin-top: 15px;
          padding: 10px;
          border-radius: 4px;
          display: none;
        }
        .message-error {
          background-color: #ffebee;
          color: #c62828;
        }
        .message-success {
          background-color: #e8f5e9;
          color: #2e7d32;
        }
        .loading {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.8);
          z-index: 1000;
          text-align: center;
          padding-top: 200px;
        }
        .spinner {
          border: 5px solid #f3f3f3;
          border-top: 5px solid #3498db;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          animation: spin 1s linear infinite;
          margin: 0 auto;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    </head>
    <body>
      <h2 style="color: #4285f4;">å–æ¶ˆåœ˜é«”é ç´„</h2>
      
      <div class="form-group">
        <label for="groupName">åœ˜é«”åç¨±ï¼š</label>
        <input type="text" id="groupName" placeholder="è«‹è¼¸å…¥åœ˜é«”åç¨±">
      </div>
      
      <div class="form-group">
        <label for="counselor">å¸¶é ˜è€…ï¼š</label>
        <input type="text" id="counselor" placeholder="è«‹è¼¸å…¥å¸¶é ˜è€…å§“å">
      </div>
      
      <div class="form-group">
        <label for="appointmentDate">é ç´„æ—¥æœŸï¼š</label>
        <input type="date" id="appointmentDate">
      </div>
      
      <div class="form-group">
        <label>å–æ¶ˆé¸é …ï¼š</label>
        <div class="radio-group">
          <input type="radio" id="cancelSingle" name="cancelOption" value="single" checked>
          <label for="cancelSingle" style="font-weight: normal; display: inline;">åªå–æ¶ˆæŒ‡å®šæ—¥æœŸçš„å ´æ¬¡</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="cancelAll" name="cancelOption" value="all">
          <label for="cancelAll" style="font-weight: normal; display: inline;">å–æ¶ˆæ­¤åœ˜é«”çš„æ‰€æœ‰å ´æ¬¡</label>
        </div>
      </div>
      
      <div class="form-group">
        <label for="cancelReason">å–æ¶ˆåŸå› ï¼š</label>
        <textarea id="cancelReason" placeholder="è«‹è¼¸å…¥å–æ¶ˆåŸå› "></textarea>
      </div>
      
      <div class="button-group">
        <button class="btn btn-danger" onclick="submitCancelGroup()">å–æ¶ˆé ç´„</button>
        <button class="btn btn-default" onclick="google.script.host.close()">é—œé–‰</button>
      </div>
      
      <div id="message"></div>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
      </div>
      
      <script>
        function submitCancelGroup() {
          var groupName = document.getElementById('groupName').value.trim();
          var counselor = document.getElementById('counselor').value.trim();
          var appointmentDate = document.getElementById('appointmentDate').value;
          var cancelOption = document.querySelector('input[name="cancelOption"]:checked').value;
          var reason = document.getElementById('cancelReason').value.trim();
          
          // é©—è­‰è¼¸å…¥
          if (!groupName) {
            showMessage('è«‹è¼¸å…¥åœ˜é«”åç¨±', 'error');
            return;
          }
          
          if (!counselor) {
            showMessage('è«‹è¼¸å…¥å¸¶é ˜è€…å§“å', 'error');
            return;
          }
          
          if (cancelOption === 'single' && !appointmentDate) {
            showMessage('è«‹é¸æ“‡é ç´„æ—¥æœŸ', 'error');
            return;
          }
          
          if (!reason) {
            showMessage('è«‹è¼¸å…¥å–æ¶ˆåŸå› ', 'error');
            return;
          }
          
          // ç¢ºèªæ˜¯å¦è¦å–æ¶ˆ
          var confirmMessage = cancelOption === 'all' 
            ? 'ç¢ºå®šè¦å–æ¶ˆæ­¤åœ˜é«”çš„æ‰€æœ‰å ´æ¬¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚' 
            : 'ç¢ºå®šè¦å–æ¶ˆæ­¤åœ˜é«”åœ¨æŒ‡å®šæ—¥æœŸçš„å ´æ¬¡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚';
            
          if (!confirm(confirmMessage)) {
            return;
          }
          
          // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
          document.getElementById('loading').style.display = 'block';
          
          // å‘¼å«å¾Œç«¯è™•ç†å–æ¶ˆ
          if (cancelOption === 'all') {
            google.script.run
              .withSuccessHandler(handleCancelSuccess)
              .withFailureHandler(handleCancelError)
              .cancelGroupByNameAndCounselor(groupName, counselor, reason);
          } else {
            google.script.run
              .withSuccessHandler(handleCancelSuccess)
              .withFailureHandler(handleCancelError)
              .cancelGroupByNameCounselorAndDate(groupName, counselor, appointmentDate, reason);
          }
        }
        
        function handleCancelSuccess(result) {
          // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
          document.getElementById('loading').style.display = 'none';
          
          if (result.success) {
            var message = '';
            if (result.cancelCount) {
              message = 'å·²æˆåŠŸå–æ¶ˆ ' + result.cancelCount + ' å€‹åœ˜é«”å ´æ¬¡ï¼';
            } else {
              message = 'å·²æˆåŠŸå–æ¶ˆåœ˜é«”å ´æ¬¡ï¼';
            }
              
            showMessage(message, 'success');
            
            // 2ç§’å¾Œé—œé–‰å°è©±æ¡†
            setTimeout(function() {
              google.script.host.close();
            }, 2000);
          } else {
            showMessage(result.message || 'å–æ¶ˆåœ˜é«”å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          }
        }
        
        function handleCancelError(error) {
          // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
          document.getElementById('loading').style.display = 'none';
          showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
        }
        
        function showMessage(message, type) {
          var messageDiv = document.getElementById('message');
          messageDiv.innerHTML = message;
          messageDiv.style.display = 'block';
          
          if (type === 'error') {
            messageDiv.className = 'message-error';
          } else {
            messageDiv.className = 'message-success';
          }
          
          // æ»¾å‹•åˆ°è¨Šæ¯
          messageDiv.scrollIntoView({ behavior: 'smooth' });
        }
      </script>
    </body>
    </html>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(450)
    .setHeight(600);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'å–æ¶ˆåœ˜é«”é ç´„');
}

/**
 * æ ¹æ“šåœ˜é«”åç¨±ã€å¸¶é ˜è€…å’Œæ—¥æœŸå–æ¶ˆå–®æ¬¡åœ˜é«”å ´æ¬¡
 */
function cancelGroupByNameCounselorAndDate(groupName, counselor, dateStr, reason) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ç™»éŒ„è³‡æ–™');
    if (!sheet) {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç™»éŒ„è³‡æ–™è¡¨å–®' };
    }
    
    var data = sheet.getDataRange().getValues();
    
    // è§£ææ—¥æœŸ
    var targetDate = new Date(dateStr);
    var cancelCount = 0;
    var calendarUpdateCount = 0;
    
    // æ—¥æ›†ç›¸é—œ
    var calendar;
    try {
      calendar = CalendarApp.getDefaultCalendar();
    } catch (e) {
      Logger.log("ç²å–æ—¥æ›†å¤±æ•—ï¼š" + e.toString());
      calendar = null;
    }
    
    // å…ˆæ‰¾å‡ºæ‰€æœ‰è¦åˆªé™¤çš„è¡Œï¼Œé¿å…åœ¨å¾ªç’°ä¸­åˆªé™¤å°è‡´ç´¢å¼•éŒ¯äº‚
    var rowsToDelete = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var rowClientName = row[1]; // Båˆ— - å€‹æ¡ˆå§“å/åœ˜é«”åç¨±
      var rowDate = row[2];       // Cåˆ— - æ—¥æœŸ
      var rowCounselor = row[3];  // Dåˆ— - å¿ƒç†å¸«/å¸¶é ˜è€…
      var rowTime = row[5];       // Fåˆ— - æ™‚é–“
      var rowRoom = row[6];       // Gåˆ— - è«®å•†å®¤
      
      // æª¢æŸ¥æ˜¯å¦åŒ¹é…
      if (rowClientName === groupName && 
          rowCounselor === counselor && 
          isSameDay(rowDate, targetDate)) {
        
        // å–æ¶ˆæ—¥æ›†äº‹ä»¶ï¼ˆå¦‚æœæ—¥æ›†å¯ç”¨ï¼‰
        if (calendar) {
          var calendarUpdated = cancelCalendarEvent(calendar, rowDate, rowTime, rowCounselor, rowRoom, rowClientName);
          if (calendarUpdated) {
            calendarUpdateCount++;
          }
        }
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è¡Œ
        rowsToDelete.push(i + 1);
        cancelCount++;
      }
    }
    
    // å¾å¾Œå¾€å‰åˆªé™¤è¡Œï¼Œé¿å…ç´¢å¼•è®ŠåŒ–
    rowsToDelete.sort(function(a, b) { return b - a; });
    for (var j = 0; j < rowsToDelete.length; j++) {
      sheet.deleteRow(rowsToDelete[j]);
    }
    
    if (cancelCount > 0) {
      var message = 'å·²æˆåŠŸåˆªé™¤ ' + cancelCount + ' å€‹åœ˜é«”å ´æ¬¡è¨˜éŒ„';
      if (calendar) {
        message += 'ï¼Œå…¶ä¸­ ' + calendarUpdateCount + ' å€‹æ—¥æ›†äº‹ä»¶å·²æ¨™è¨˜ç‚ºå–æ¶ˆ';
      }
      
      // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
      logSystemActivity(
        "å–æ¶ˆåœ˜é«”",
        groupName,
        `å–æ¶ˆå–®æ¬¡åœ˜é«”å ´æ¬¡: ${dateStr}, å¸¶é ˜è€…: ${counselor}`,
        "æˆåŠŸ",
        counselor,
        `å–æ¶ˆåŸå› : ${reason}, å–æ¶ˆå ´æ¬¡æ•¸: ${cancelCount}`
      );
      
      return { success: true, cancelCount: cancelCount, message: message };
    } else {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "å–æ¶ˆåœ˜é«”",
        groupName,
        `å–æ¶ˆåœ˜é«”å¤±æ•—: æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡`,
        "å¤±æ•—",
        counselor,
        `å˜—è©¦å–æ¶ˆæ—¥æœŸ: ${dateStr}, å–æ¶ˆåŸå› : ${reason}`
      );
      return { success: false, message: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡' };
    }
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å–æ¶ˆåœ˜é«”",
      groupName,
      `å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    
    Logger.log('å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ' + error);
    return { success: false, message: 'ç™¼ç”ŸéŒ¯èª¤: ' + error };
  }
}


/**
 * æ ¹æ“šåœ˜é«”åç¨±å’Œå¸¶é ˜è€…å–æ¶ˆæ‰€æœ‰åœ˜é«”å ´æ¬¡
 */
function cancelGroupByNameAndCounselor(groupName, counselor, reason) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ç™»éŒ„è³‡æ–™');
    if (!sheet) {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç™»éŒ„è³‡æ–™è¡¨å–®' };
    }
    
    var data = sheet.getDataRange().getValues();
    
    var cancelCount = 0;
    var calendarUpdateCount = 0;
    
    // æ—¥æ›†ç›¸é—œ
    var calendar;
    try {
      calendar = CalendarApp.getDefaultCalendar();
    } catch (e) {
      Logger.log("ç²å–æ—¥æ›†å¤±æ•—ï¼š" + e.toString());
      calendar = null;
    }
    
    // å…ˆæ‰¾å‡ºæ‰€æœ‰è¦åˆªé™¤çš„è¡Œï¼Œé¿å…åœ¨å¾ªç’°ä¸­åˆªé™¤å°è‡´ç´¢å¼•éŒ¯äº‚
    var rowsToDelete = [];
    var calendarEvents = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var rowClientName = row[1]; // Båˆ— - å€‹æ¡ˆå§“å/åœ˜é«”åç¨±
      var rowDate = row[2];       // Cåˆ— - æ—¥æœŸ
      var rowCounselor = row[3];  // Dåˆ— - å¿ƒç†å¸«/å¸¶é ˜è€…
      var rowTime = row[5];       // Fåˆ— - æ™‚é–“
      var rowRoom = row[6];       // Gåˆ— - è«®å•†å®¤
      
      // æª¢æŸ¥æ˜¯å¦åŒ¹é…
      if (rowClientName === groupName && rowCounselor === counselor) {
        // è¨˜éŒ„è¦åˆªé™¤çš„è¡Œ
        rowsToDelete.push(i + 1);
        
        // è¨˜éŒ„è¦å–æ¶ˆçš„æ—¥æ›†äº‹ä»¶
        if (calendar) {
          calendarEvents.push({
            date: rowDate,
            time: rowTime,
            counselor: rowCounselor,
            room: rowRoom,
            clientName: rowClientName
          });
        }
        
        cancelCount++;
      }
    }
    
    // å¾å¾Œå¾€å‰åˆªé™¤è¡Œï¼Œé¿å…ç´¢å¼•è®ŠåŒ–
    rowsToDelete.sort(function(a, b) { return b - a; });
    for (var j = 0; j < rowsToDelete.length; j++) {
      sheet.deleteRow(rowsToDelete[j]);
    }
    
    // è™•ç†æ—¥æ›†äº‹ä»¶å–æ¶ˆ
    if (calendar) {
      for (var k = 0; k < calendarEvents.length; k++) {
        var event = calendarEvents[k];
        var calendarUpdated = cancelCalendarEvent(
          calendar, 
          event.date, 
          event.time, 
          event.counselor, 
          event.room, 
          event.clientName
        );
        
        if (calendarUpdated) {
          calendarUpdateCount++;
        }
        
        // æ·»åŠ çŸ­æš«å»¶é²ï¼Œé¿å… Google æ—¥æ›† API é™åˆ¶
        Utilities.sleep(100);
      }
    }
    
    if (cancelCount > 0) {
      var message = 'å·²æˆåŠŸåˆªé™¤ ' + cancelCount + ' å€‹åœ˜é«”å ´æ¬¡è¨˜éŒ„';
      if (calendar) {
        message += 'ï¼Œå…¶ä¸­ ' + calendarUpdateCount + ' å€‹æ—¥æ›†äº‹ä»¶å·²æ¨™è¨˜ç‚ºå–æ¶ˆ';
      }
      
      // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
      logSystemActivity(
        "å–æ¶ˆåœ˜é«”",
        groupName,
        `å–æ¶ˆæ‰€æœ‰åœ˜é«”å ´æ¬¡, å¸¶é ˜è€…: ${counselor}`,
        "æˆåŠŸ",
        counselor,
        `å–æ¶ˆåŸå› : ${reason}, å–æ¶ˆå ´æ¬¡æ•¸: ${cancelCount}`
      );
      
      return { success: true, cancelCount: cancelCount, message: message };
    } else {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "å–æ¶ˆåœ˜é«”",
        groupName,
        `å–æ¶ˆåœ˜é«”å¤±æ•—: æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡`,
        "å¤±æ•—",
        counselor,
        `å–æ¶ˆåŸå› : ${reason}`
      );
      return { success: false, message: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡' };
    }
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å–æ¶ˆåœ˜é«”",
      groupName,
      `å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    
    Logger.log('å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ' + error);
    return { success: false, message: 'ç™¼ç”ŸéŒ¯èª¤: ' + error };
  }
}

/**
 * æª¢æŸ¥å…©å€‹æ—¥æœŸæ˜¯å¦ç‚ºåŒä¸€å¤©
 */
function isSameDay(date1, date2) {
  if (!(date1 instanceof Date)) date1 = new Date(date1);
  if (!(date2 instanceof Date)) date2 = new Date(date2);
  
  return date1.getFullYear() === date2.getFullYear() &&
         date1.getMonth() === date2.getMonth() &&
         date1.getDate() === date2.getDate();
}

/**
 * å–æ¶ˆæ—¥æ›†äº‹ä»¶
 */
function cancelCalendarEvent(calendar, date, timeRange, counselor, room, groupName) {
  try {
    // è§£ææ™‚é–“ç¯„åœ
    var timeParts = timeRange.split('-').map(function(t) { return t.trim(); });
    var startTimeStr = timeParts[0];
    var endTimeStr = timeParts.length > 1 ? timeParts[1] : null;
    
    // è¨­å®šäº‹ä»¶é–‹å§‹å’ŒçµæŸæ™‚é–“
    var startTime = new Date(date);
    try {
      var startHourMin = startTimeStr.split(':');
      startTime.setHours(parseInt(startHourMin[0]), parseInt(startHourMin[1]), 0, 0);
    } catch (e) {
      Logger.log("è§£æé–‹å§‹æ™‚é–“éŒ¯èª¤ï¼š" + e.toString() + ", ä½¿ç”¨é è¨­æ™‚é–“");
      startTime.setHours(9, 0, 0, 0); // ä½¿ç”¨é è¨­æ™‚é–“
    }
    
    var endTime = new Date(date);
    if (endTimeStr) {
      try {
        var endHourMin = endTimeStr.split(':');
        endTime.setHours(parseInt(endHourMin[0]), parseInt(endHourMin[1]), 0, 0);
      } catch (e) {
        Logger.log("è§£æçµæŸæ™‚é–“éŒ¯èª¤ï¼š" + e.toString() + ", ä½¿ç”¨é è¨­çµæŸæ™‚é–“");
        endTime.setHours(startTime.getHours() + 1, startTime.getMinutes(), 0, 0);
      }
    } else {
      // å¦‚æœæ²’æœ‰çµæŸæ™‚é–“ï¼Œå‡è¨­æŒçºŒ1å°æ™‚
      endTime.setHours(startTime.getHours() + 1, startTime.getMinutes(), 0, 0);
    }
    
    // è¨­å®šæœå°‹ç¯„åœï¼ˆç•¶å¤©ï¼‰
    var dayStart = new Date(date);
    dayStart.setHours(0, 0, 0, 0);
    
    var dayEnd = new Date(date);
    dayEnd.setHours(23, 59, 59, 999);
    
    // ç²å–ç•¶å¤©æ‰€æœ‰äº‹ä»¶
    var events;
    try {
      events = calendar.getEvents(dayStart, dayEnd);
    } catch (e) {
      Logger.log("ç²å–æ—¥æ›†äº‹ä»¶éŒ¯èª¤ï¼š" + e.toString());
      return false; // ç²å–äº‹ä»¶å¤±æ•—ï¼Œè¿”å›å¤±æ•—
    }
    
    // æ‰¾åˆ°ä¸¦å–æ¶ˆåŒ¹é…çš„äº‹ä»¶
    var eventFound = false;
    
    for (var i = 0; i < events.length; i++) {
      try {
        var event = events[i];
        var title = event.getTitle();
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç›®æ¨™äº‹ä»¶ï¼ˆåœ˜é«”åç¨±ã€å¸¶é ˜è€…ã€è«®å•†å®¤éƒ½åŒ¹é…ï¼‰
        if (title.indexOf(groupName) !== -1 && 
            title.indexOf(counselor) !== -1 && 
            (title.indexOf(room) !== -1 || room === "") && 
            title.indexOf("ã€å–æ¶ˆã€‘") === -1) {
          
          // æ›´æ–°äº‹ä»¶æ¨™é¡Œï¼Œæ¨™è¨˜ç‚ºå–æ¶ˆ
          event.setTitle("ã€å–æ¶ˆã€‘" + title);
          
          // å°‡äº‹ä»¶è¨­ç‚ºç°è‰²
          event.setColor(CalendarApp.EventColor.GRAY);
          
          Logger.log("å·²å–æ¶ˆæ—¥æ›†äº‹ä»¶ï¼š" + title);
          eventFound = true;
          break;
        }
      } catch (e) {
        Logger.log("è™•ç†äº‹ä»¶æ™‚å‡ºéŒ¯ï¼š" + e.toString());
        continue; // è·³éé€™å€‹äº‹ä»¶ï¼Œç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹
      }
    }
    
    if (!eventFound) {
      Logger.log("æœªæ‰¾åˆ°åŒ¹é…çš„æ—¥æ›†äº‹ä»¶ï¼šåœ˜é«”=" + groupName + ", å¸¶é ˜è€…=" + counselor + ", æ—¥æœŸ=" + Utilities.formatDate(date, "GMT+8", "yyyy-MM-dd"));
    }
    
    return eventFound;
  } catch (error) {
    Logger.log("å–æ¶ˆæ—¥æ›†äº‹ä»¶éŒ¯èª¤ï¼š" + error.toString());
    return false; // ç™¼ç”ŸéŒ¯èª¤ï¼Œè¿”å›å¤±æ•—
  }
}

/**
 * æ ¹æ“šåœ˜é«”åç¨±ã€å¸¶é ˜è€…å’Œæ—¥æœŸå–æ¶ˆå–®æ¬¡åœ˜é«”å ´æ¬¡
 */
function cancelGroupByNameCounselorAndDate(groupName, counselor, dateStr, reason) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ç™»éŒ„è³‡æ–™');
    if (!sheet) {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç™»éŒ„è³‡æ–™è¡¨å–®' };
    }
    
    var data = sheet.getDataRange().getValues();
    
    // è§£ææ—¥æœŸ
    var targetDate = new Date(dateStr);
    var cancelCount = 0;
    var calendarUpdateCount = 0;
    
    // æ—¥æ›†ç›¸é—œ
    var calendar;
    try {
      calendar = CalendarApp.getDefaultCalendar();
    } catch (e) {
      Logger.log("ç²å–æ—¥æ›†å¤±æ•—ï¼š" + e.toString());
      calendar = null;
    }
    
    // å…ˆæ‰¾å‡ºæ‰€æœ‰è¦åˆªé™¤çš„è¡Œï¼Œé¿å…åœ¨å¾ªç’°ä¸­åˆªé™¤å°è‡´ç´¢å¼•éŒ¯äº‚
    var rowsToDelete = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var rowClientName = row[1]; // Båˆ— - å€‹æ¡ˆå§“å/åœ˜é«”åç¨±
      var rowDate = row[2];       // Cåˆ— - æ—¥æœŸ
      var rowCounselor = row[3];  // Dåˆ— - å¿ƒç†å¸«/å¸¶é ˜è€…
      var rowTime = row[5];       // Fåˆ— - æ™‚é–“
      var rowRoom = row[6];       // Gåˆ— - è«®å•†å®¤
      
      // æª¢æŸ¥æ˜¯å¦åŒ¹é…
      if (rowClientName === groupName && 
          rowCounselor === counselor && 
          isSameDay(rowDate, targetDate)) {
        
        // å–æ¶ˆæ—¥æ›†äº‹ä»¶ï¼ˆå¦‚æœæ—¥æ›†å¯ç”¨ï¼‰
        if (calendar) {
          var calendarUpdated = cancelCalendarEvent(calendar, rowDate, rowTime, rowCounselor, rowRoom, rowClientName);
          if (calendarUpdated) {
            calendarUpdateCount++;
          }
        }
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è¡Œ
        rowsToDelete.push(i + 1);
        cancelCount++;
      }
    }
    
    // å¾å¾Œå¾€å‰åˆªé™¤è¡Œï¼Œé¿å…ç´¢å¼•è®ŠåŒ–
    rowsToDelete.sort(function(a, b) { return b - a; });
    for (var j = 0; j < rowsToDelete.length; j++) {
      sheet.deleteRow(rowsToDelete[j]);
    }
    
    if (cancelCount > 0) {
      var message = 'å·²æˆåŠŸåˆªé™¤ ' + cancelCount + ' å€‹åœ˜é«”å ´æ¬¡è¨˜éŒ„';
      if (calendar) {
        message += 'ï¼Œå…¶ä¸­ ' + calendarUpdateCount + ' å€‹æ—¥æ›†äº‹ä»¶å·²æ¨™è¨˜ç‚ºå–æ¶ˆ';
      }
      return { success: true, cancelCount: cancelCount, message: message };
    } else {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡' };
    }
  } catch (error) {
    Logger.log('å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ' + error);
    return { success: false, message: 'ç™¼ç”ŸéŒ¯èª¤: ' + error };
  }
}

/**
 * æ ¹æ“šåœ˜é«”åç¨±å’Œå¸¶é ˜è€…å–æ¶ˆæ‰€æœ‰åœ˜é«”å ´æ¬¡
 */
function cancelGroupByNameAndCounselor(groupName, counselor, reason) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('ç™»éŒ„è³‡æ–™');
    if (!sheet) {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç™»éŒ„è³‡æ–™è¡¨å–®' };
    }
    
    var data = sheet.getDataRange().getValues();
    
    var cancelCount = 0;
    var calendarUpdateCount = 0;
    
    // æ—¥æ›†ç›¸é—œ
    var calendar;
    try {
      calendar = CalendarApp.getDefaultCalendar();
    } catch (e) {
      Logger.log("ç²å–æ—¥æ›†å¤±æ•—ï¼š" + e.toString());
      calendar = null;
    }
    
    // å…ˆæ‰¾å‡ºæ‰€æœ‰è¦åˆªé™¤çš„è¡Œï¼Œé¿å…åœ¨å¾ªç’°ä¸­åˆªé™¤å°è‡´ç´¢å¼•éŒ¯äº‚
    var rowsToDelete = [];
    var calendarEvents = [];
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      var rowClientName = row[1]; // Båˆ— - å€‹æ¡ˆå§“å/åœ˜é«”åç¨±
      var rowDate = row[2];       // Cåˆ— - æ—¥æœŸ
      var rowCounselor = row[3];  // Dåˆ— - å¿ƒç†å¸«/å¸¶é ˜è€…
      var rowTime = row[5];       // Fåˆ— - æ™‚é–“
      var rowRoom = row[6];       // Gåˆ— - è«®å•†å®¤
      
      // æª¢æŸ¥æ˜¯å¦åŒ¹é…
      if (rowClientName === groupName && rowCounselor === counselor) {
        // è¨˜éŒ„è¦åˆªé™¤çš„è¡Œ
        rowsToDelete.push(i + 1);
        
        // è¨˜éŒ„è¦å–æ¶ˆçš„æ—¥æ›†äº‹ä»¶
        if (calendar) {
          calendarEvents.push({
            date: rowDate,
            time: rowTime,
            counselor: rowCounselor,
            room: rowRoom,
            clientName: rowClientName
          });
        }
        
        cancelCount++;
      }
    }
    
    // å¾å¾Œå¾€å‰åˆªé™¤è¡Œï¼Œé¿å…ç´¢å¼•è®ŠåŒ–
    rowsToDelete.sort(function(a, b) { return b - a; });
    for (var j = 0; j < rowsToDelete.length; j++) {
      sheet.deleteRow(rowsToDelete[j]);
    }
    
    // è™•ç†æ—¥æ›†äº‹ä»¶å–æ¶ˆ
    if (calendar) {
      for (var k = 0; k < calendarEvents.length; k++) {
        var event = calendarEvents[k];
        var calendarUpdated = cancelCalendarEvent(
          calendar, 
          event.date, 
          event.time, 
          event.counselor, 
          event.room, 
          event.clientName
        );
        
        if (calendarUpdated) {
          calendarUpdateCount++;
        }
        
        // æ·»åŠ çŸ­æš«å»¶é²ï¼Œé¿å… Google æ—¥æ›† API é™åˆ¶
        Utilities.sleep(100);
      }
    }
    
    if (cancelCount > 0) {
      var message = 'å·²æˆåŠŸåˆªé™¤ ' + cancelCount + ' å€‹åœ˜é«”å ´æ¬¡è¨˜éŒ„';
      if (calendar) {
        message += 'ï¼Œå…¶ä¸­ ' + calendarUpdateCount + ' å€‹æ—¥æ›†äº‹ä»¶å·²æ¨™è¨˜ç‚ºå–æ¶ˆ';
      }
      return { success: true, cancelCount: cancelCount, message: message };
    } else {
      return { success: false, message: 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åœ˜é«”å ´æ¬¡' };
    }
  } catch (error) {
    Logger.log('å–æ¶ˆåœ˜é«”å ´æ¬¡éŒ¯èª¤: ' + error);
    return { success: false, message: 'ç™¼ç”ŸéŒ¯èª¤: ' + error };
  }
}

/**
 * è™•ç†èª¿æ•´è«®å•†ç©ºé–“çš„è«‹æ±‚
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} appointmentDate - é ç´„æ—¥æœŸå­—ä¸²
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} newRoom - æ–°è«®å•†ç©ºé–“
 * @return {Object} è™•ç†çµæœ
 */
function processChangeRoomRequest(clientName, appointmentDate, counselor, newRoom) {
  try {
    var date = new Date(appointmentDate);
    const result = changeAppointmentRoom(clientName, date, counselor, newRoom);
    
    if (result.success) {
      // æ·»åŠ æˆåŠŸæ—¥èªŒ
      logSystemActivity(
        "èª¿æ•´è«®å•†ç©ºé–“",
        clientName,
        `é ç´„æ—¥æœŸ: ${appointmentDate}, æ–°è«®å•†å®¤: ${newRoom}`,
        "æˆåŠŸ",
        counselor,
        "è«®å•†ç©ºé–“èª¿æ•´å®Œæˆ"
      );
        // ã€æ–°å¢ã€‘èª¿æ•´ç©ºé–“æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
        createHelperTodoItem(
          "èª¿æ•´è«®å•†ç©ºé–“",
          clientName,
          {
            date: appointmentDate,
            time: appointmentInfo.time,
            therapist: counselor,
            room: newRoom,
            serviceType: appointmentInfo.serviceType,
            additionalInfo: `åŸè«®å•†å®¤ï¼š${appointmentInfo.room} â†’ æ–°è«®å•†å®¤ï¼š${newRoom}`
          }
        );
    } else {
      // æ·»åŠ å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "èª¿æ•´è«®å•†ç©ºé–“",
        clientName,
        `èª¿æ•´è«®å•†ç©ºé–“å¤±æ•—: ${result.message}`,
        "å¤±æ•—",
        counselor
      );
    }
    
    return result;
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "èª¿æ•´è«®å•†ç©ºé–“",
      clientName,
      `èª¿æ•´è«®å•†ç©ºé–“å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    
    Logger.log("è™•ç†èª¿æ•´è«®å•†ç©ºé–“è«‹æ±‚æ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, message: "è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + error.toString() };
  }
}


/**
 * èª¿æ•´è«®å•†ç©ºé–“çš„æ ¸å¿ƒåŠŸèƒ½
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} appointmentDate - é ç´„æ—¥æœŸ
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} newRoom - æ–°è«®å•†ç©ºé–“
 * @return {Object} è™•ç†çµæœ
 */
function changeAppointmentRoom(clientName, appointmentDate, counselor, newRoom) {
  try {
    // 1. æª¢æŸ¥æ–°è«®å•†å®¤åœ¨è©²æ™‚æ®µæ˜¯å¦å¯ç”¨
    // é¦–å…ˆéœ€è¦ç²å–é ç´„çš„æ™‚é–“
    const appointmentInfo = findAppointmentInfo(clientName, appointmentDate, counselor);
    if (!appointmentInfo) {
      return { success: false, message: "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é ç´„è¨˜éŒ„" };
    }
    
    const appointmentTime = appointmentInfo.time;
    
    // æª¢æŸ¥æ–°è«®å•†å®¤æ˜¯å¦å¯ç”¨ï¼ˆæ’é™¤åŸé ç´„ï¼‰
    const roomAvailable = checkRoomAvailabilityExcludingCurrent(
      appointmentDate, 
      appointmentTime, 
      newRoom, 
      clientName, 
      counselor
    );
    
    if (!roomAvailable) {
      return { success: false, message: "è©²æ™‚æ®µæ–°è«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–è«®å•†å®¤" };
    }
    
    // 2. ä¿®æ”¹è©¦ç®—è¡¨ä¸­çš„è«®å•†å®¤è³‡æ–™
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    let updated = false;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === clientName && 
          isSameDay(new Date(data[i][2]), appointmentDate) &&
          data[i][3] === counselor) {
        // æ›´æ–°è«®å•†å®¤
        sheet.getRange(i + 1, 7).setValue(newRoom);
        Logger.log("å·²åœ¨è©¦ç®—è¡¨ä¸­æ›´æ–°è«®å•†å®¤");
        updated = true;
        break;
      }
    }
    
    if (!updated) {
      return { success: false, message: "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é ç´„è¨˜éŒ„" };
    }
    
    // 3. ä¿®æ”¹Googleæ—¥æ›†äº‹ä»¶
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    const events = calendar.getEventsForDay(appointmentDate);
    let eventUpdated = false;
    
    for (let event of events) {
      const title = event.getTitle();
      const description = event.getDescription();
      
      if (title.includes(clientName) && title.includes(counselor)) {
        // æ›´æ–°äº‹ä»¶æ¨™é¡Œä¸­çš„è«®å•†å®¤
        const newTitle = title.replace(/- .*$/, `- ${newRoom}`);
        event.setTitle(newTitle);
        
        // æ›´æ–°äº‹ä»¶æè¿°ä¸­çš„è«®å•†å®¤
        const newDescription = description.replace(/è«®å•†å®¤: .*(\n|$)/, `è«®å•†å®¤: ${newRoom}\n`);
        event.setDescription(newDescription);
        
        Logger.log("å·²æ›´æ–°Googleæ—¥æ›†äº‹ä»¶");
        eventUpdated = true;
        break;
      }
    }
    
    if (!eventUpdated) {
      Logger.log("è­¦å‘Šï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„Googleæ—¥æ›†äº‹ä»¶");
    }
    
    return { success: true };
  } catch (error) {
    Logger.log("èª¿æ•´è«®å•†ç©ºé–“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: "è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + error.toString() };
  }
}

/**
 * æª¢æŸ¥å…©å€‹æ—¥æœŸæ˜¯å¦ç‚ºåŒä¸€å¤©
 * @param {Date} date1 - ç¬¬ä¸€å€‹æ—¥æœŸ
 * @param {Date} date2 - ç¬¬äºŒå€‹æ—¥æœŸ
 * @return {boolean} æ˜¯å¦ç‚ºåŒä¸€å¤©
 */
function isSameDay(date1, date2) {
  return date1.getFullYear() === date2.getFullYear() &&
         date1.getMonth() === date2.getMonth() &&
         date1.getDate() === date2.getDate();
}

/**
 * æŸ¥æ‰¾é ç´„è³‡è¨Š
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} appointmentDate - é ç´„æ—¥æœŸ
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @return {Object|null} é ç´„è³‡è¨Š
 */
function findAppointmentInfo(clientName, appointmentDate, counselor) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === clientName && 
          isSameDay(new Date(data[i][2]), appointmentDate) &&
          data[i][3] === counselor) {
        
        return {
          clientName: data[i][1],
          date: new Date(data[i][2]),
          counselor: data[i][3],
          serviceType: data[i][4],
          time: data[i][5],
          room: data[i][6]
        };
      }
    }
    
    return null;
  } catch (error) {
    Logger.log("æŸ¥æ‰¾é ç´„è³‡è¨Šæ™‚å‡ºéŒ¯: " + error.toString());
    return null;
  }
}

/**
 * æª¢æŸ¥è«®å•†å®¤åœ¨æŒ‡å®šæ™‚æ®µæ˜¯å¦å¯ç”¨ï¼ˆæ’é™¤ç•¶å‰é ç´„ï¼‰
 * @param {Date} date - é ç´„æ—¥æœŸ
 * @param {string} timeString - é ç´„æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} room - è«®å•†å®¤åç¨±
 * @param {string} currentClientName - ç•¶å‰é ç´„çš„å€‹æ¡ˆå§“å
 * @param {string} currentCounselor - ç•¶å‰é ç´„çš„å¿ƒç†å¸«
 * @return {boolean} è«®å•†å®¤æ˜¯å¦å¯ç”¨
 */
function checkRoomAvailabilityExcludingCurrent(date, timeString, room, currentClientName, currentCounselor) {
  try {
    // å¾ç³»çµ±è¨­å®šç²å–æ—¥æ›†ID
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [hours, minutes] = timeString.split(':').map(Number);
    
    // è¨­å®šè«®å•†çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
    const startTime = new Date(date);
    startTime.setHours(hours);
    startTime.setMinutes(minutes);
    startTime.setSeconds(0);
    
    const endTime = new Date(startTime);
    endTime.setMinutes(startTime.getMinutes() + config.counselingDuration); // è«®å•†æ™‚é•·
    
    // å®šç¾©æª¢æŸ¥ç¯„åœï¼šåŒ…æ‹¬å‰å¾Œå¯èƒ½é‡ç–Šçš„æ™‚é–“
    // é–‹å§‹æª¢æŸ¥ç¯„åœï¼šç•¶å¤©0é»
    const dayStart = new Date(date);
    dayStart.setHours(0, 0, 0, 0);
    
    // çµæŸæª¢æŸ¥ç¯„åœï¼šç•¶å¤©23:59
    const dayEnd = new Date(date);
    dayEnd.setHours(23, 59, 59, 999);
    
    // ç²å–ç•¶å¤©æ‰€æœ‰äº‹ä»¶
    const events = calendar.getEvents(dayStart, dayEnd);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èˆ‡ç•¶å‰æ™‚æ®µé‡ç–Šçš„åŒä¸€è«®å•†å®¤çš„é ç´„
    for (let event of events) {
      const title = event.getTitle();
      const desc = event.getDescription();
      
      // æ’é™¤ç•¶å‰é ç´„
      if (title.includes(currentClientName) && title.includes(currentCounselor)) {
        continue;
      }
      
      // åªæª¢æŸ¥æœªå–æ¶ˆå’Œæœªæ”¹æœŸçš„äº‹ä»¶
      if (!title.includes("ã€å–æ¶ˆã€‘") && !title.includes("ã€æ”¹æœŸã€‘")) {
        // æª¢æŸ¥è«®å•†å®¤æ˜¯å¦ç›¸åŒ
        if (title.includes(`- ${room}`) || desc.includes(`è«®å•†å®¤: ${room}`)) {
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦é‡ç–Š
          const eventStart = event.getStartTime();
          const eventEnd = event.getEndTime();
          
          // æª¢æŸ¥é‡ç–Šçš„æƒ…æ³ï¼š
          // 1. æ–°é ç´„çš„é–‹å§‹æ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 2. æ–°é ç´„çš„çµæŸæ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 3. æ–°é ç´„æ©«è·¨ç¾æœ‰é ç´„ï¼ˆæ–°é ç´„é–‹å§‹æ™‚é–“æ—©æ–¼ç¾æœ‰é ç´„ï¼ŒçµæŸæ™‚é–“æ™šæ–¼ç¾æœ‰é ç´„ï¼‰
          if ((startTime >= eventStart && startTime < eventEnd) || 
              (endTime > eventStart && endTime <= eventEnd) ||
              (startTime <= eventStart && endTime >= eventEnd)) {
            return false; // æ™‚æ®µé‡ç–Šï¼Œè«®å•†å®¤ä¸å¯ç”¨
          }
        }
      }
    }
    
    return true; // è«®å•†å®¤å¯ç”¨
  } catch (error) {
    Logger.log("æª¢æŸ¥è«®å•†å®¤å¯ç”¨æ€§æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    // å‡ºéŒ¯æ™‚è¿”å›falseä¿å®ˆè™•ç†
    return false;
  }
}

/**
 * ç³»çµ±è¨­å®šç®¡ç†
 * é›†ä¸­ç®¡ç†ç³»çµ±ä¸­ä½¿ç”¨çš„å¸¸æ•¸å’Œè¨­å®š
 */
function getSystemConfig() {
  return {
    calendarId: 'outhearter@gmail.com',
    counselingDuration: 50, // è«®å•†æ™‚é•·(åˆ†é˜)
    timeZone: 'Asia/Taipei',
    systemName: 'æµªå¿ƒäººå¿ƒç†è«®å•†æ‰€é ç´„ç³»çµ±'
  };
}

/**
 * ç”ŸæˆåŠ è¼‰æŒ‡ç¤ºå™¨çš„ HTML å’Œ JavaScript
 * @return {string} åŠ è¼‰æŒ‡ç¤ºå™¨çš„ HTML å’Œ JavaScript
 */
function generateLoadingIndicatorHTML() {
  return `
    <style>
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      
      .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4285f4;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <div>è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>
    <script>
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    </script>
  `;
}

/**
 * ç•¶è¡¨å–®æäº¤æ™‚è§¸ç™¼
 * @param {Object} e - è¡¨å–®æäº¤äº‹ä»¶ç‰©ä»¶
 */
function onFormSubmit(e) {
  try {
    Logger.log("è§¸ç™¼äº†onFormSubmitå‡½æ•¸ï¼Œé–‹å§‹è™•ç†...");
    
    // è®Šæ•¸é è¨­å€¼
    let clientName, counselingDate, counselor, serviceType, time, room, deposit;
    
    // æª¢æŸ¥æ˜¯å¾è¡¨å–®é‚„æ˜¯å¾è©¦ç®—è¡¨è§¸ç™¼
    if (e && e.response) {
      // å¾è¡¨å–®å›æ‡‰ä¸­ç²å–æ•¸æ“š
      Logger.log("å¾è¡¨å–®æäº¤è§¸ç™¼");
      const itemResponses = e.response.getItemResponses();
      
      // ç²å–æ¯å€‹å•é¡Œçš„å›ç­”
      for (let i = 0; i < itemResponses.length; i++) {
        const response = itemResponses[i];
        const title = response.getItem().getTitle();
        const answer = response.getResponse();
        Logger.log(`è¡¨å–®å•é¡Œ: ${title}, ç­”æ¡ˆ: ${answer}`);
        
        // æ ¹æ“šå•é¡Œæ¨™é¡Œæ˜ å°„åˆ°å°æ‡‰è®Šæ•¸
        if (title.includes("å€‹æ¡ˆå§“å")) clientName = answer;
        else if (title.includes("è«®å•†æ—¥æœŸ")) counselingDate = new Date(answer);
        else if (title.includes("å¿ƒç†å¸«")) counselor = answer;
        else if (title.includes("æœå‹™æ–¹æ¡ˆ")) serviceType = answer;
        else if (title.includes("æ™‚é–“")) time = answer;
        else if (title.includes("è«®å•†å®¤")) room = answer;
        else if (title.includes("ä¿è­‰é‡‘")) deposit = answer;
      }
    } else {
      // å¾è©¦ç®—è¡¨ä¸­ç²å–æ•¸æ“š
      Logger.log("å¾è©¦ç®—è¡¨è§¸ç™¼");
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
      const lastRow = sheet.getLastRow();
      
      if (lastRow > 1) {
        const rowData = sheet.getRange(lastRow, 1, 1, 7).getValues()[0];
        clientName = rowData[1];
        counselingDate = rowData[2];
        counselor = rowData[3];
        serviceType = rowData[4];
        time = rowData[5];
        room = rowData[6];
      } else {
        Logger.log("è©¦ç®—è¡¨ä¸­ç„¡è³‡æ–™");
        return;
      }
    }
    
    // å¿…è¦åƒæ•¸æª¢æŸ¥
    if (!clientName || !counselingDate || !counselor || !serviceType || !time) {
      Logger.log("å¿…è¦åƒæ•¸ç¼ºå¤±ï¼Œç„¡æ³•è™•ç†");
      return;
    }
    
    Logger.log(`æº–å‚™è™•ç†é ç´„: å®¢æˆ¶=${clientName}, å¿ƒç†å¸«=${counselor}, æ—¥æœŸ=${counselingDate}, æ™‚é–“=${time}`);
    
    // å‰µå»ºæ—¥æ›†äº‹ä»¶
    createCalendarEvent(clientName, serviceType, counselingDate, time, counselor, room);
    
    // å°è³‡æ–™é€²è¡Œæ’åºï¼Œç¢ºä¿æœ€æ–°çš„è¨˜éŒ„åœ¨æœ€ä¸‹æ–¹
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    sortDataByTimestamp(sheet);
    
    // æ›´æ–°çµ±è¨ˆå ±è¡¨
    updateStatistics();
    
    // é€šçŸ¥å¿ƒç†å¸«
    const emailResult = notifyCounselor(clientName, serviceType, counselingDate, time, counselor, room);
    Logger.log(`éƒµä»¶ç™¼é€çµæœ: ${emailResult ? "æˆåŠŸ" : "å¤±æ•—"}`);
    
    Logger.log("è¡¨å–®è™•ç†å®Œæˆ");
  } catch (error) {
    Logger.log(`è™•ç†è¡¨å–®æäº¤æ™‚å‡ºéŒ¯: ${error.toString()}`);
  }
}

/**
 * ä¿ç•™ processForm ä½œç‚ºå…¼å®¹
 */
function processForm(e) {
  onFormSubmit(e);
}

/**
 * å®‰è£è¡¨å–®æäº¤è§¸ç™¼å™¨
 */
function setupFormTriggers() {
  // åˆªé™¤ç¾æœ‰çš„è§¸ç™¼å™¨ä»¥é¿å…é‡è¤‡
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'onFormSubmit') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // è¨­å®šè©¦ç®—è¡¨æäº¤è§¸ç™¼å™¨
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  ScriptApp.newTrigger('onFormSubmit')
    .forSpreadsheet(ss)
    .onFormSubmit()
    .create();
  
  Logger.log("å·²æˆåŠŸè¨­ç½®è¡¨å–®æäº¤è§¸ç™¼å™¨");
}

/**
 * é‡è¨­æ‰€æœ‰è§¸ç™¼å™¨
 */
function resetAllTriggers() {
  // åˆªé™¤æ‰€æœ‰å·²å­˜åœ¨çš„è§¸ç™¼å™¨
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
  
  // é‡æ–°è¨­å®šè¡¨å–®æäº¤è§¸ç™¼å™¨
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  ScriptApp.newTrigger('onFormSubmit')
    .forSpreadsheet(ss)
    .onFormSubmit()
    .create();
  
  Logger.log("å·²é‡è¨­æ‰€æœ‰è§¸ç™¼å™¨");
}

/**
 * æŒ‰æ™‚é–“æˆ³è¨˜æ’åºè³‡æ–™
 * @param {Sheet} sheet - è¦æ’åºçš„å·¥ä½œè¡¨
 */
function sortDataByTimestamp(sheet) {
  try {
    // ç²å–è³‡æ–™ç¯„åœ
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    
    // å¦‚æœåªæœ‰æ¨™é¡Œè¡Œæˆ–æ²’æœ‰è³‡æ–™ï¼Œå‰‡ä¸éœ€è¦æ’åº
    if (data.length <= 1) return;
    
    // åˆ†é›¢æ¨™é¡Œè¡Œå’Œè³‡æ–™
    const headerRow = data[0];
    const dataRows = data.slice(1);
    
    // æŒ‰æ™‚é–“æˆ³è¨˜æ’åºï¼ˆç¬¬ä¸€åˆ—ï¼Œç´¢å¼•0ï¼‰
    dataRows.sort((a, b) => {
      const dateA = new Date(a[0]);
      const dateB = new Date(b[0]);
      return dateA - dateB; // å‡åºæ’åº
    });
    
    // é‡æ–°çµ„åˆè³‡æ–™
    const sortedData = [headerRow].concat(dataRows);
    
    // å°‡æ’åºå¾Œçš„è³‡æ–™å¯«å›å·¥ä½œè¡¨
    dataRange.setValues(sortedData);
    
    Logger.log("è³‡æ–™å·²æŒ‰æ™‚é–“æˆ³è¨˜æ’åº");
  } catch (error) {
    Logger.log(`æ’åºè³‡æ–™æ™‚å‡ºéŒ¯: ${error.toString()}`);
  }
}

/**
 * é¡¯ç¤ºç¬¬ä¸€æ¬¡é ç´„å°è©±æ¡†
 */
function showFirstAppointmentDialog() {
  // ç¢ºä¿ç³»çµ±è¨­å®šè¡¨æ ¼å·²æ›´æ–°
  updateSystemSettingsForDeposit();
  
  // ç²å–å„é …ä¸‹æ‹‰é¸å–®çš„é¸é …
  const counselors = getCounselorList();
  const serviceTypes = getServiceTypeList();
  const rooms = getRoomList();
  
  const counselorOptions = counselors.map(counselor => 
    '<option value="' + counselor + '">' + counselor + '</option>').join('');
  const serviceTypeOptions = serviceTypes.map(type => 
    '<option value="' + type + '">' + type + '</option>').join('');
  const roomOptions = rooms.map(room => 
    '<option value="' + room + '">' + room + '</option>').join('');
  
  // ç²å–ä¿è­‰é‡‘æ¢ä»¶
  const depositConditions = getDepositConditions();
  const depositConditionsJson = JSON.stringify(depositConditions);
  
  var html = '<div id="form-container" style="padding: 20px; font-family: Arial, sans-serif;">' +
    '<h2 style="color: #4285f4;">ç¬¬ä¸€æ¬¡é ç´„</h2>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>' +
      '<input type="text" id="clientName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥å€‹æ¡ˆå§“å">' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">é ç´„æ—¥æœŸï¼š</label><br>' +
      '<input type="date" id="appointmentDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">é ç´„æ™‚é–“ï¼š</label><br>' +
      '<select id="appointmentHour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        generateHourOptions() +
      '</select>' +
      '<select id="appointmentMinute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="00">00</option>' +
        '<option value="30">30</option>' +
      '</select>' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">æœå‹™å¿ƒç†å¸«ï¼š</label><br>' +
      '<select id="counselor" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="">è«‹é¸æ“‡å¿ƒç†å¸«</option>' +
        counselorOptions +
      '</select>' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">æœå‹™æ–¹æ¡ˆï¼š</label><br>' +
      '<select id="serviceType" onchange="updateDepositStatus()" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="">è«‹é¸æ“‡æœå‹™æ–¹æ¡ˆ</option>' +
        serviceTypeOptions +
      '</select>' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">è«®å•†å®¤ï¼š</label><br>' +
      '<select id="room" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="">è«‹é¸æ“‡è«®å•†å®¤</option>' +
        roomOptions +
      '</select>' +
    '</div>' +
    '<div style="margin: 10px 0;">' +
      '<label style="font-weight: bold;">ä¿è­‰é‡‘ï¼š</label><br>' +
      '<select id="deposit" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">' +
        '<option value="æœªç¹³ç´">æœªç¹³ç´</option>' +
        '<option value="å·²ç¹³ç´">å·²ç¹³ç´</option>' +
        '<option value="å…æ”¶">å…æ”¶</option>' +
      '</select>' +
      '<div id="depositNote" style="margin-top: 5px; font-size: 13px; color: #666;"></div>' +
    '</div>' +
    '<div style="margin: 20px 0; text-align: center;">' +
      '<button onclick="submitFirstAppointment()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªé ç´„</button>' +
      '<button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>' +
    '</div>' +
    '<div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>' +
  '</div>' +
    
  generateLoadingIndicatorHTML() +
  '<script>' +
    '// ä¿è­‰é‡‘æ¢ä»¶è¨­å®š\n' +
    'const depositConditions = ' + depositConditionsJson + ';\n' +
    
    '// é é¢è¼‰å…¥å¾Œè‡ªå‹•è¨­å®šä»Šå¤©æ—¥æœŸ\n' +
    'document.addEventListener("DOMContentLoaded", function() {\n' +
    '  const today = new Date();\n' +
    '  const year = today.getFullYear();\n' +
    '  const month = String(today.getMonth() + 1).padStart(2, "0");\n' +
    '  const day = String(today.getDate()).padStart(2, "0");\n' +
    '  document.getElementById("appointmentDate").value = year + "-" + month + "-" + day;\n' +
    '});\n' +
    
    '// æ ¹æ“šæœå‹™æ–¹æ¡ˆæ›´æ–°ä¿è­‰é‡‘ç‹€æ…‹\n' +
    'function updateDepositStatus() {\n' +
    '  const serviceType = document.getElementById("serviceType").value;\n' +
    '  const depositSelect = document.getElementById("deposit");\n' +
    '  const depositNote = document.getElementById("depositNote");\n' +
    '  \n' +
    '  if (serviceType && depositConditions[serviceType]) {\n' +
    '    const condition = depositConditions[serviceType];\n' +
    '    \n' +
    '    // è¨­å®šä¿è­‰é‡‘ç‹€æ…‹\n' +
    '    depositSelect.value = condition.status;\n' +
    '    \n' +
    '    // å¦‚æœæ˜¯å…æ”¶ï¼Œé¡¯ç¤ºå‚™è¨»\n' +
    '    if (condition.status === "å…æ”¶" && condition.note) {\n' +
    '      depositNote.textContent = "å‚™è¨»: " + condition.note;\n' +
    '      depositNote.style.display = "block";\n' +
    '    } else {\n' +
    '      depositNote.style.display = "none";\n' +
    '    }\n' +
    '    \n' +
    '    // å¦‚æœæ˜¯å…æ”¶ï¼Œç¦ç”¨é¸æ“‡\n' +
    '    depositSelect.disabled = (condition.status === "å…æ”¶");\n' +
    '  } else {\n' +
    '    // é è¨­ç‚ºæœªç¹³ç´ï¼Œä¸”å¯é¸æ“‡\n' +
    '    depositSelect.value = "æœªç¹³ç´";\n' +
    '    depositSelect.disabled = false;\n' +
    '    depositNote.style.display = "none";\n' +
    '  }\n' +
    '}\n' +
    
    'function submitFirstAppointment() {\n' +
    '  var clientName = document.getElementById("clientName").value;\n' +
    '  var appointmentDate = document.getElementById("appointmentDate").value;\n' +
    '  var appointmentHour = document.getElementById("appointmentHour").value;\n' +
    '  var appointmentMinute = document.getElementById("appointmentMinute").value;\n' +
    '  var counselor = document.getElementById("counselor").value;\n' +
    '  var serviceType = document.getElementById("serviceType").value;\n' +
    '  var room = document.getElementById("room").value;\n' +
    '  var deposit = document.getElementById("deposit").value;\n' +
    '  \n' +
    '  // çµ„åˆæ™‚é–“å­—ä¸²\n' +
    '  var appointmentTime = appointmentHour + ":" + appointmentMinute;\n' +
    '  \n' +
    '  if (!clientName || !appointmentDate || !counselor || !serviceType || !room) {\n' +
    '    showMessage("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½", "error");\n' +
    '    return;\n' +
    '  }\n' +
    '  \n' +
    '  // æª¢æŸ¥ä¿è­‰é‡‘ç‹€æ…‹\n' +
    '  if (serviceType && depositConditions[serviceType] && \n' +
    '      depositConditions[serviceType].status === "éœ€æ”¶" && \n' +
    '      deposit === "æœªç¹³ç´") {\n' +
    '    if (!confirm("æ­¤æœå‹™æ–¹æ¡ˆéœ€è¦æ”¶å–ä¿è­‰é‡‘ï¼Œç¢ºå®šè¦åœ¨æœªç¹³ç´ä¿è­‰é‡‘çš„æƒ…æ³ä¸‹é ç´„å—ï¼Ÿ")) {\n' +
    '      return;\n' +
    '    }\n' +
    '  }\n' +
    '  \n' +
    '  document.getElementById("message").style.display = "none";\n' +
    '  \n' +
    '  // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨\n' +
    '  showLoading();\n' +
    '  \n' +
    '  google.script.run\n' +
    '    .withSuccessHandler(function(result) {\n' +
    '      // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨\n' +
    '      hideLoading();\n' +
    '      \n' +
    '      if (result.success) {\n' +
    '        if (result.notificationMessage) {\n' +
    '          // é¡¯ç¤ºåˆæ¬¡é ç´„è¨Šæ¯æ¡†\n' +
    '          document.getElementById("message").style.display = "none";\n' +
    '          document.getElementById("form-container").innerHTML = result.notificationMessage;\n' +
    '        } else {\n' +
    '          showMessage("é ç´„å·²æˆåŠŸå»ºç«‹ï¼", "success");\n' +
    '          setTimeout(function() {\n' +
    '            google.script.host.close();\n' +
    '          }, 2000);\n' +
    '        }\n' +
    '      } else {\n' +
    '        showMessage(result.message || "é ç´„å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");\n' +
    '      }\n' +
    '    })\n' +
    '    .withFailureHandler(function(error) {\n' +
    '      // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨\n' +
    '      hideLoading();\n' +
    '      \n' +
    '      showMessage("ç™¼ç”ŸéŒ¯èª¤ï¼š" + error, "error");\n' +
    '    })\n' +
    '    .processFirstAppointment(clientName, appointmentDate, appointmentTime, counselor, serviceType, room, deposit);\n' +
    '}\n' +
    
    'function showMessage(message, type) {\n' +
    '  var messageDiv = document.getElementById("message");\n' +
    '  messageDiv.innerHTML = message;\n' +
    '  messageDiv.style.display = "block";\n' +
    '  \n' +
    '  if (type === "error") {\n' +
    '    messageDiv.style.backgroundColor = "#ffebee";\n' +
    '    messageDiv.style.color = "#c62828";\n' +
    '  } else {\n' +
    '    messageDiv.style.backgroundColor = "#e8f5e9";\n' +
    '    messageDiv.style.color = "#2e7d32";\n' +
    '  }\n' +
    '}\n' +
  '</script>';

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(650);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ç¬¬ä¸€æ¬¡é ç´„');
}


/**
 * è™•ç†ç¬¬ä¸€æ¬¡é ç´„è«‹æ±‚
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} appointmentDate - é ç´„æ—¥æœŸå­—ä¸²
 * @param {string} appointmentTime - é ç´„æ™‚é–“å­—ä¸²
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {string} room - è«®å•†å®¤
 * @param {string} deposit - ä¿è­‰é‡‘ç‹€æ…‹
 * @return {Object} è™•ç†çµæœ
 */
function processFirstAppointment(clientName, appointmentDate, appointmentTime, counselor, serviceType, room, deposit) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const now = new Date();
    const appointmentDateObj = new Date(appointmentDate);
    
    // æª¢æŸ¥è«®å•†å®¤åœ¨è©²æ™‚æ®µæ˜¯å¦å¯ç”¨
    const roomAvailable = checkRoomAvailability(appointmentDateObj, appointmentTime, room);
    if (!roomAvailable) {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "ç¬¬ä¸€æ¬¡é ç´„",
        clientName,
        `é ç´„å¤±æ•—: è©²æ™‚æ®µè«®å•†å®¤å·²è¢«é ç´„`,
        "å¤±æ•—",
        counselor,
        `å˜—è©¦é ç´„æ™‚é–“: ${appointmentDate} ${appointmentTime}, è«®å•†å®¤: ${room}`
      );
      return { success: false, message: 'è©²æ™‚æ®µè«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“æˆ–è«®å•†å®¤' };
    }
    
    // ä½¿ç”¨ appendRow æ·»åŠ è³‡æ–™
    sheet.appendRow([
      now,                // æ™‚é–“æˆ³è¨˜
      clientName,         // å€‹æ¡ˆå§“å
      appointmentDateObj, // è«®å•†æ—¥æœŸ
      counselor,          // è«®å•†å¸«
      serviceType,        // æœå‹™æ–¹æ¡ˆ
      appointmentTime,    // æ™‚é–“
      room,               // è«®å•†å®¤
      deposit             // ä¿è­‰é‡‘ç‹€æ…‹
    ]);
    
    // æ ¹æ“šæ™‚é–“æˆ³è¨˜å°è³‡æ–™é€²è¡Œæ’åº
    sortDataByTimestamp(sheet);
    
    // å‰µå»ºæ—¥æ›†äº‹ä»¶
    createCalendarEvent(clientName, serviceType, appointmentDateObj, appointmentTime, counselor, room);
    
    // æ›´æ–°çµ±è¨ˆå ±è¡¨
    updateStatistics();
    
    // é€šçŸ¥å¿ƒç†å¸«
    notifyCounselor(clientName, serviceType, appointmentDateObj, appointmentTime, counselor, room);
    
    // ç”Ÿæˆåˆæ¬¡é ç´„è¨Šæ¯
    const notificationMessage = generateNotificationMessage('firstAppointment', {
      clientName: clientName,
      appointmentDate: appointmentDateObj,
      appointmentTime: appointmentTime,
      counselor: counselor,
      serviceType: serviceType,
      room: room
    });
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
    logSystemActivity(
      "ç¬¬ä¸€æ¬¡é ç´„",
      clientName,
      `é ç´„æ—¥æœŸ: ${appointmentDate}, æ™‚é–“: ${appointmentTime}, å¿ƒç†å¸«: ${counselor}, æœå‹™: ${serviceType}, è«®å•†å®¤: ${room}`,
      "æˆåŠŸ",
      counselor,
      `ä¿è­‰é‡‘ç‹€æ…‹: ${deposit}`
    );

    // ã€æ–°å¢ã€‘é ç´„æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
    createHelperTodoItem(
      OPERATION_TYPES.FIRST_APPOINTMENT,
      clientName,
      {
        date: appointmentDate,
        time: appointmentTime,
        therapist: counselor,
        room: room,
        serviceType: "å€‹åˆ¥è«®å•†",
        additionalInfo: "é¦–æ¬¡é ç´„"
      }
    );

    return { 
      success: true,
      notificationMessage: notificationMessage
    };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "ç¬¬ä¸€æ¬¡é ç´„",
      clientName,
      `é ç´„å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    
    Logger.log("è™•ç†ç¬¬ä¸€æ¬¡é ç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†é ç´„æ™‚å‡ºç¾éŒ¯èª¤' };
  }
}

/**
 * è™•ç†å€‹æ¡ˆçºŒç´„è«‹æ±‚ (å·²æ–°å¢æ›´æ›æ–¹æ¡ˆåŠŸèƒ½)
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} renewalDate - çºŒç´„æ—¥æœŸ (YYYY-MM-DDæ ¼å¼)
 * @param {string} renewalTime - çºŒç´„æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {boolean} changeRoom - æ˜¯å¦æ›´æ›è«®å•†ç©ºé–“
 * @param {string} newRoom - æ–°çš„è«®å•†ç©ºé–“
 * @param {boolean} changeService - æ˜¯å¦æ›´æ›æœå‹™æ–¹æ¡ˆ
 * @param {string} newServiceType - æ–°çš„æœå‹™æ–¹æ¡ˆ
 * @return {Object} è™•ç†çµæœ
 */
function processClientRenewal(clientName, renewalDate, renewalTime, changeRoom, newRoom, changeService, newServiceType) {
  try {
    const latestInfo = getLatestClientInfo(clientName);
    if (!latestInfo) {
      logSystemActivity("å€‹æ¡ˆçºŒç´„", clientName, `çºŒç´„å¤±æ•—: æ‰¾ä¸åˆ°è©²å€‹æ¡ˆçš„è¨˜éŒ„`, "å¤±æ•—");
      return { success: false, message: 'æ‰¾ä¸åˆ°è©²å€‹æ¡ˆçš„è¨˜éŒ„ï¼Œè«‹å…ˆæ–°å¢å€‹æ¡ˆè³‡æ–™' };
    }
    
    const newDate = new Date(renewalDate);
    
    // ã€ä¿®æ”¹è™•ã€‘æ±ºå®šæœ€çµ‚è¦ä½¿ç”¨çš„è«®å•†å®¤å’Œæœå‹™æ–¹æ¡ˆ
    const roomToUse = changeRoom && newRoom ? newRoom : latestInfo.room;
    const serviceTypeToUse = changeService && newServiceType ? newServiceType : latestInfo.serviceType;
    
    const roomAvailable = checkRoomAvailability(newDate, renewalTime, roomToUse);
    if (!roomAvailable) {
      // (æ­¤è™•çš„æˆ¿é–“è¡çªé‚è¼¯ä¸è®Š)
      const allRooms = getRoomList();
      const availableRooms = [];
      for (let i = 0; i < Math.min(allRooms.length, 5); i++) {
        if (checkRoomAvailability(newDate, renewalTime, allRooms[i])) {
          availableRooms.push(allRooms[i]);
        }
      }
      if (availableRooms.length === 0) {
        logSystemActivity("å€‹æ¡ˆçºŒç´„", clientName, `çºŒç´„å¤±æ•—: è©²æ™‚æ®µæ‰€æœ‰è«®å•†å®¤éƒ½å·²è¢«é ç´„`, "å¤±æ•—", latestInfo.counselor);
        return { success: false, message: 'è©²æ™‚æ®µæ‰€æœ‰è«®å•†å®¤éƒ½å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“', noRoomsAvailable: true };
      }
      return {
        success: false,
        message: 'é¸æ“‡çš„è«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–è«®å•†å®¤',
        needRoomChange: true,
        availableRooms: availableRooms,
        originalInfo: { clientName: clientName, date: renewalDate, time: renewalTime, counselor: latestInfo.counselor, serviceType: serviceTypeToUse }
      };
    }
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const now = new Date();
    
    sheet.appendRow([
      now,
      clientName,
      newDate,
      latestInfo.counselor,
      serviceTypeToUse, // ã€ä¿®æ”¹è™•ã€‘ä½¿ç”¨æœ€çµ‚æ±ºå®šçš„æœå‹™æ–¹æ¡ˆ
      renewalTime,
      roomToUse,
      latestInfo.deposit
    ]);
    
    sortDataByTimestamp(sheet);
    
    // ã€ä¿®æ”¹è™•ã€‘ä½¿ç”¨æœ€çµ‚æ±ºå®šçš„æœå‹™æ–¹æ¡ˆä¾†å»ºç«‹äº‹ä»¶å’Œç™¼é€é€šçŸ¥
    createCalendarEvent(clientName, serviceTypeToUse, newDate, renewalTime, latestInfo.counselor, roomToUse);
    updateStatistics();
    notifyCounselor(clientName, serviceTypeToUse, newDate, renewalTime, latestInfo.counselor, roomToUse);

    const notificationMessage = generateNotificationMessage('renewal', {
      clientName: clientName,
      renewalDate: newDate,
      renewalTime: renewalTime,
      counselor: latestInfo.counselor,
      serviceType: serviceTypeToUse, // ã€ä¿®æ”¹è™•ã€‘
      room: roomToUse
    });
    
    createHelperTodoItem(
      OPERATION_TYPES.RENEWAL,
      clientName,
      {
        clientName: clientName,
        date: renewalDate,
        time: renewalTime,
        therapist: latestInfo.counselor,
        room: roomToUse,
        serviceType: serviceTypeToUse, // ã€ä¿®æ”¹è™•ã€‘
        additionalInfo: `çºŒç´„` + (changeService ? ` (æ›´æ›æ–¹æ¡ˆè‡³: ${newServiceType})` : '')
      }
    );
    
    let logNotes = changeRoom ? `æ›´æ›è«®å•†å®¤è‡³: ${newRoom}` : "";
    if (changeService) {
        logNotes += (logNotes ? ", " : "") + `æ›´æ›æ–¹æ¡ˆè‡³: ${newServiceType}`;
    }

    logSystemActivity("å€‹æ¡ˆçºŒç´„", clientName, `çºŒç´„æ—¥æœŸ: ${renewalDate}, æ™‚é–“: ${renewalTime}, è«®å•†å®¤: ${roomToUse}`, "æˆåŠŸ", latestInfo.counselor, logNotes);
    
    return { 
      success: true,
      notificationMessage: notificationMessage
    };
  } catch (error) {
    Logger.log("è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤: ' + error.toString() };
  }
}


/**
 * å‰µå»ºæˆ–ç¢ºä¿ç³»çµ±è¨­å®šè¡¨æ ¼å­˜åœ¨
 */
function ensureSystemSettingsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
  
  if (!sheet) {
    sheet = ss.insertSheet("ç³»çµ±è¨­å®š");
    
    // è¨­å®šæ¨™é¡Œ
    sheet.appendRow(["è¨­å®šé¡å‹", "é¸é …"]);
    sheet.getRange("A1:B1").setFontWeight("bold");
    
    // è¨­å®šå¿ƒç†å¸«å€åŸŸ
    sheet.appendRow(["å¿ƒç†å¸«", ""]);
    sheet.getRange(2, 1).setFontWeight("bold");
    sheet.appendRow(["", "ç‹é†«å¸«"]);
    sheet.appendRow(["", "æé†«å¸«"]);
    sheet.appendRow(["", "å¼µé†«å¸«"]);
    
    // è¨­å®šæœå‹™æ–¹æ¡ˆå€åŸŸ
    sheet.appendRow(["æœå‹™æ–¹æ¡ˆ", ""]);
    sheet.getRange(6, 1).setFontWeight("bold");
    sheet.appendRow(["", "å€‹åˆ¥è«®å•†"]);
    sheet.appendRow(["", "ä¼´ä¾¶è«®å•†"]);
    sheet.appendRow(["", "å®¶æ—è«®å•†"]);
    
    // è¨­å®šè«®å•†å®¤å€åŸŸ
    sheet.appendRow(["è«®å•†å®¤", ""]);
    sheet.getRange(10, 1).setFontWeight("bold");
    sheet.appendRow(["", "è«®å•†å®¤A"]);
    sheet.appendRow(["", "è«®å•†å®¤B"]);
    sheet.appendRow(["", "è«®å•†å®¤C"]);
    
    // ç¾åŒ–è¡¨æ ¼
    sheet.setColumnWidth(1, 150);
    sheet.setColumnWidth(2, 200);
  }
  
  return sheet;
}

/**
 * é¡¯ç¤ºå€‹æ¡ˆçºŒç´„å°è©±æ¡† (å·²æ–°å¢æ›´æ›æ–¹æ¡ˆåŠŸèƒ½)
 */
function showClientRenewalDialog() {
  // ã€ä¿®æ”¹è™•ã€‘åŒæ™‚ç²å–è«®å•†å®¤å’Œæœå‹™æ–¹æ¡ˆåˆ—è¡¨
  const rooms = getRoomList();
  const roomOptions = rooms.map(room => `<option value="${room}">${room}</option>`).join('');
  
  const serviceTypes = getServiceTypeList();
  const serviceTypeOptions = serviceTypes.map(type => `<option value="${type}">${type}</option>`).join('');
    
  const clients = getClientList();
  const clientOptions = clients.map(client => `<option value="${client}">${client}</option>`).join('');

  var html = `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <meta charset="UTF-8">
    </head>
    <body>
    <div class="renewal-container" style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">å€‹æ¡ˆçºŒç´„</h2>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>
        <div style="position: relative; width: 100%;">
          <input type="text" id="clientName" list="clientList" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡å€‹æ¡ˆå§“å" autocomplete="off">
          <datalist id="clientList">${clientOptions}</datalist>
          <div id="clientNameError" style="color: #c62828; font-size: 12px; margin-top: 3px; display: none;">æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º</div>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">çºŒç´„è«®å•†æ—¥æœŸï¼š</label><br>
        <input type="date" id="renewalDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">çºŒç´„è«®å•†æ™‚é–“ï¼š</label><br>
        <select id="renewalHour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          ${generateHourOptions()}
        </select>
        <select id="renewalMinute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="00">00</option>
          <option value="30">30</option>
        </select>
      </div>
      
      <div style="margin: 15px 0;">
        <div style="display: flex; align-items: center;">
          <input type="checkbox" id="changeRoom" style="margin-right: 8px;" onchange="toggleRoomSelection()">
          <label for="changeRoom" style="font-weight: bold;">èª¿æ•´è«®å•†ç©ºé–“</label>
        </div>
      </div>
      
      <div id="roomSelectionDiv" style="margin: 15px 0; display: none;">
        <label style="font-weight: bold;">é¸æ“‡è«®å•†ç©ºé–“ï¼š</label><br>
        <select id="newRoom" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡è«®å•†ç©ºé–“</option>
          ${roomOptions}
        </select>
      </div>

      <div style="margin: 15px 0;">
        <div style="display: flex; align-items: center;">
          <input type="checkbox" id="changeService" style="margin-right: 8px;" onchange="toggleServiceSelection()">
          <label for="changeService" style="font-weight: bold;">æ›´æ›æœå‹™æ–¹æ¡ˆ</label>
        </div>
      </div>
      
      <div id="serviceSelectionDiv" style="margin: 15px 0; display: none;">
        <label style="font-weight: bold;">é¸æ“‡æ–°æœå‹™æ–¹æ¡ˆï¼š</label><br>
        <select id="newServiceType" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡æœå‹™æ–¹æ¡ˆ</option>
          ${serviceTypeOptions}
        </select>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="processRenewal()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªçºŒç´„</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>

      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      let originalInfo = null;
      
      document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        document.getElementById("renewalDate").value = year + "-" + month + "-" + day;
        setupClientNameInputFilter();
      });
      
      function setupClientNameInputFilter() { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
      
      function toggleRoomSelection() {
        document.getElementById('roomSelectionDiv').style.display = document.getElementById('changeRoom').checked ? 'block' : 'none';
      }
      
      // ã€æ–°å¢ã€‘æ§åˆ¶æœå‹™æ–¹æ¡ˆé¸å–®é¡¯ç¤º/éš±è—çš„å‡½å¼
      function toggleServiceSelection() {
        document.getElementById('serviceSelectionDiv').style.display = document.getElementById('changeService').checked ? 'block' : 'none';
      }
      
      function processRenewal() {
        const clientName = document.getElementById('clientName').value;
        const renewalDate = document.getElementById('renewalDate').value;
        const renewalTime = document.getElementById('renewalHour').value + ':' + document.getElementById('renewalMinute').value;
        
        // ã€ä¿®æ”¹è™•ã€‘ç²å–æ‰€æœ‰æ–°é¸é …çš„å€¼
        const changeRoom = document.getElementById('changeRoom').checked;
        const newRoom = changeRoom ? document.getElementById('newRoom').value : '';
        
        const changeService = document.getElementById('changeService').checked;
        const newServiceType = changeService ? document.getElementById('newServiceType').value : '';
        
        if (!clientName || !renewalDate) { /* ... é©—è­‰é‚è¼¯ä¸è®Š ... */ }
        if (changeRoom && !newRoom) { showMessage('è«‹é¸æ“‡æ–°çš„è«®å•†ç©ºé–“', 'error'); return; }
        if (changeService && !newServiceType) { showMessage('è«‹é¸æ“‡æ–°çš„æœå‹™æ–¹æ¡ˆ', 'error'); return; }

        const clientList = document.getElementById('clientList');
        const clients = Array.from(clientList.options).map(opt => opt.value);
        if (!clients.includes(clientName)) { showMessage('æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º', 'error'); return; }
        
        document.getElementById('message').style.display = 'none';
        showLoading();
        
        // ã€ä¿®æ”¹è™•ã€‘å°‡æ–°åƒæ•¸å‚³éçµ¦å¾Œç«¯
        google.script.run
          .withSuccessHandler(function(result) {
              hideLoading();
              if (result.success) {
                  document.querySelector('.renewal-container').innerHTML = result.notificationMessage;
              } else if (result.needRoomChange) {
                  originalInfo = result.originalInfo;
                  showRoomSelection(result.availableRooms);
                  showMessage(result.message, 'warning');
              } else {
                  showMessage(result.message || 'çºŒç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
              }
          })
          .withFailureHandler(function(error) {
              hideLoading();
              showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .processClientRenewal(clientName, renewalDate, renewalTime, changeRoom, newRoom, changeService, newServiceType);
      }
      
      function showRoomSelection(availableRooms) { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
      function showMessage(message, type) { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
      function showLoading() { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
      function hideLoading() { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
    </script>
    </body>
    </html>`;

  var userInterface = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(650) // ç¨å¾®å¢åŠ é«˜åº¦ä»¥é©æ‡‰æ–°é¸é …
    .setTitle('å€‹æ¡ˆçºŒç´„');

  SpreadsheetApp.getUi().showModelessDialog(userInterface, 'å€‹æ¡ˆçºŒç´„');
}

/**
 * ä½¿ç”¨æ–°è«®å•†å®¤è™•ç†çºŒç´„
 * @param {Object} originalInfo - åŸé ç´„è³‡è¨Š
 * @param {string} newRoom - æ–°è«®å•†å®¤
 * @return {Object} è™•ç†çµæœ
 */
function processRenewalWithNewRoom(originalInfo, newRoom) {
  try {
    const newDateObj = new Date(originalInfo.date);
    
    // ã€ä¿®æ­£ã€‘ä½¿ç”¨æ­£ç¢ºçš„æˆ¿é–“å¯ç”¨æ€§æª¢æŸ¥å‡½æ•¸ï¼ˆçºŒç´„æ˜¯æ–°é ç´„ï¼Œä¸éœ€è¦æ’é™¤ç¾æœ‰é ç´„ï¼‰
    if (!checkRoomAvailability(newDateObj, originalInfo.time, newRoom)) {
      return { success: false, message: 'é¸æ“‡çš„è«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é‡æ–°é¸æ“‡' };
    }
    
    // æ·»åŠ æ–°é ç´„è¨˜éŒ„
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const now = new Date();
    
    sheet.appendRow([
      now,                    // æ™‚é–“æˆ³è¨˜
      originalInfo.clientName, // å€‹æ¡ˆå§“å
      newDateObj,             // è«®å•†æ—¥æœŸ
      originalInfo.counselor, // è«®å•†å¸«
      originalInfo.serviceType, // æœå‹™æ–¹æ¡ˆ
      originalInfo.time,      // æ™‚é–“
      newRoom,                // è«®å•†å®¤
      "å·²ç¹³ç´"                // ä¿è­‰é‡‘ç‹€æ…‹ï¼ˆçºŒç´„é€šå¸¸å·²ç¹³ç´ï¼‰
    ]);
    
    // æ’åºè³‡æ–™
    sortDataByTimestamp(sheet);
    
    // å‰µå»ºæ—¥æ›†äº‹ä»¶
    createCalendarEvent(originalInfo.clientName, originalInfo.serviceType, newDateObj, originalInfo.time, originalInfo.counselor, newRoom);
    
    // æ›´æ–°çµ±è¨ˆå ±è¡¨
    updateStatistics();
    
    // é€šçŸ¥å¿ƒç†å¸«
    notifyCounselor(originalInfo.clientName, originalInfo.serviceType, newDateObj, originalInfo.time, originalInfo.counselor, newRoom);
    
    // ç”ŸæˆçºŒç´„è¨Šæ¯
    const notificationMessage = generateNotificationMessage('renewal', {
      clientName: originalInfo.clientName,
      renewalDate: newDateObj,
      renewalTime: originalInfo.time,
      counselor: originalInfo.counselor,
      serviceType: originalInfo.serviceType,
      room: newRoom
    });
    
    // ã€æ–°å¢ã€‘çºŒç´„æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
    createHelperTodoItem(
      OPERATION_TYPES.RENEWAL,
      originalInfo.clientName,
      {
        clientName: originalInfo.clientName,
        date: originalInfo.date,
        time: originalInfo.time,
        therapist: originalInfo.counselor,
        room: newRoom,
        serviceType: originalInfo.serviceType,
        additionalInfo: "çºŒç´„ï¼ˆæ›´æ›è«®å•†å®¤ï¼‰"
      }
    );
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒ
    logSystemActivity(
      "å€‹æ¡ˆçºŒç´„",
      originalInfo.clientName,
      `çºŒç´„æ—¥æœŸ: ${originalInfo.date}, æ™‚é–“: ${originalInfo.time}, è«®å•†å®¤: ${newRoom}`,
      "æˆåŠŸ",
      originalInfo.counselor,
      "çºŒç´„å®Œæˆï¼ˆæ›´æ›è«®å•†å®¤ï¼‰"
    );
    
    return { 
      success: true,
      notificationMessage: notificationMessage 
    };
  } catch (error) {
    Logger.log("ä½¿ç”¨æ–°è«®å•†å®¤è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤' };
  }
}


/**
 * ç”Ÿæˆå°æ™‚é¸é …çš„HTML
 */
function generateHourOptions() {
  var options = '';
  for (var i = 8; i <= 21; i++) {
    var hour = i < 10 ? '0' + i : '' + i;
    options += `<option value="${hour}">${hour}</option>`;
  }
  return options;
}

/**
 * ç²å–å€‹æ¡ˆçš„æœ€æ–°æœå‹™è¨˜éŒ„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @return {Object|null} å€‹æ¡ˆæœ€æ–°æœå‹™è¨˜éŒ„
 */
function getLatestClientInfo(clientName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    // éæ¿¾å‡ºç¬¦åˆå®¢æˆ¶åç¨±çš„æ‰€æœ‰è¨˜éŒ„
    const clientRecords = data.filter((row, index) => {
      // è·³éæ¨™é¡Œè¡Œ
      if (index === 0) return false;
      // æª¢æŸ¥åå­—æ˜¯å¦ç›¸ç¬¦ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
      return row[1] && (row[1].includes(clientName) || clientName.includes(row[1]));
    });
    
    if (clientRecords.length === 0) {
      return null;
    }
    
    // ä¾æ™‚é–“æˆ³è¨˜æ’åºï¼Œå–å¾—æœ€æ–°çš„ä¸€ç­†è¨˜éŒ„
    clientRecords.sort((a, b) => new Date(b[0]) - new Date(a[0]));
    const latest = clientRecords[0];
    
    return {
      timestamp: latest[0],
      clientName: latest[1],
      date: latest[2],
      counselor: latest[3],
      serviceType: latest[4],
      time: latest[5],
      room: latest[6],
      deposit: latest[7] || 'å¦' // ä¿è­‰é‡‘ç‹€æ…‹ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡é è¨­ç‚º'å¦'
    };
  } catch (error) {
    Logger.log("ç²å–å€‹æ¡ˆè³‡è¨Šæ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return null;
  }
}

/**
 * æª¢æŸ¥è«®å•†å®¤åœ¨æŒ‡å®šæ™‚æ®µæ˜¯å¦å¯ç”¨
 * @param {Date} date - é ç´„æ—¥æœŸ
 * @param {string} timeString - é ç´„æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} room - è«®å•†å®¤åç¨±
 * @return {boolean} è«®å•†å®¤æ˜¯å¦å¯ç”¨
 */
function checkRoomAvailability(date, timeString, room) {
  try {
    // å¾ç³»çµ±è¨­å®šç²å–æ—¥æ›†ID
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [hours, minutes] = timeString.split(':').map(Number);
    
    // è¨­å®šè«®å•†çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
    const startTime = new Date(date);
    startTime.setHours(hours);
    startTime.setMinutes(minutes);
    startTime.setSeconds(0);
    
    const endTime = new Date(startTime);
    endTime.setMinutes(startTime.getMinutes() + config.counselingDuration); // è«®å•†æ™‚é•·
    
    // å®šç¾©æª¢æŸ¥ç¯„åœï¼šåŒ…æ‹¬å‰å¾Œå¯èƒ½é‡ç–Šçš„æ™‚é–“
    // é–‹å§‹æª¢æŸ¥ç¯„åœï¼šç•¶å¤©0é»
    const dayStart = new Date(date);
    dayStart.setHours(0, 0, 0, 0);
    
    // çµæŸæª¢æŸ¥ç¯„åœï¼šç•¶å¤©23:59
    const dayEnd = new Date(date);
    dayEnd.setHours(23, 59, 59, 999);
    
    // ç²å–ç•¶å¤©æ‰€æœ‰äº‹ä»¶
    const events = calendar.getEvents(dayStart, dayEnd);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èˆ‡ç•¶å‰æ™‚æ®µé‡ç–Šçš„åŒä¸€è«®å•†å®¤çš„é ç´„
    for (let event of events) {
      const title = event.getTitle();
      const desc = event.getDescription();
      
      // åªæª¢æŸ¥æœªå–æ¶ˆå’Œæœªæ”¹æœŸçš„äº‹ä»¶
      if (!title.includes("ã€å–æ¶ˆã€‘") && !title.includes("ã€æ”¹æœŸã€‘")) {
        // æª¢æŸ¥è«®å•†å®¤æ˜¯å¦ç›¸åŒ
        if (title.includes(`- ${room}`) || desc.includes(`è«®å•†å®¤: ${room}`)) {
          // æª¢æŸ¥æ™‚é–“æ˜¯å¦é‡ç–Š
          const eventStart = event.getStartTime();
          const eventEnd = event.getEndTime();
          
          // æª¢æŸ¥é‡ç–Šçš„æƒ…æ³ï¼š
          // 1. æ–°é ç´„çš„é–‹å§‹æ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 2. æ–°é ç´„çš„çµæŸæ™‚é–“åœ¨ç¾æœ‰é ç´„çš„æ™‚æ®µå…§
          // 3. æ–°é ç´„æ©«è·¨ç¾æœ‰é ç´„ï¼ˆæ–°é ç´„é–‹å§‹æ™‚é–“æ—©æ–¼ç¾æœ‰é ç´„ï¼ŒçµæŸæ™‚é–“æ™šæ–¼ç¾æœ‰é ç´„ï¼‰
          if ((startTime >= eventStart && startTime < eventEnd) || 
              (endTime > eventStart && endTime <= eventEnd) ||
              (startTime <= eventStart && endTime >= eventEnd)) {
            return false; // æ™‚æ®µé‡ç–Šï¼Œè«®å•†å®¤ä¸å¯ç”¨
          }
        }
      }
    }
    
    return true; // è«®å•†å®¤å¯ç”¨
  } catch (error) {
    Logger.log("æª¢æŸ¥è«®å•†å®¤å¯ç”¨æ€§æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    // å‡ºéŒ¯æ™‚è¿”å›falseä¿å®ˆè™•ç†
    return false;
  }
}

/**
 * é¡¯ç¤ºç¹³äº¤ä¿è­‰é‡‘å°è©±æ¡†
 */
function showDepositPaymentDialog() {
  // ç²å–å®¢æˆ¶åå–®ä¾›ä¸‹æ‹‰é¸æ“‡
  const clients = getClientList();
  const clientOptions = clients.map(client => 
    `<option value="${client}">${client}</option>`).join('');
    
  var html = `
    <div id="deposit-container" style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">ç¹³äº¤ä¿è­‰é‡‘</h2>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>
        <div style="position: relative; width: 100%;">
          <input type="text" id="clientName" list="clientList" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡å€‹æ¡ˆå§“å" autocomplete="off">
          <datalist id="clientList">
            ${clientOptions}
          </datalist>
          <div id="clientNameError" style="color: #c62828; font-size: 12px; margin-top: 3px; display: none;">æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º</div>
        </div>
      </div>
      
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">ç¹³è²»æ–¹å¼ï¼š</label><br>
        <div style="margin-top: 8px;">
          <input type="radio" id="paymentTransfer" name="paymentMethod" value="transfer" checked onchange="togglePaymentFields()">
          <label for="paymentTransfer" style="margin-left: 5px; margin-right: 20px;">è½‰å¸³</label>
          
          <input type="radio" id="paymentCash" name="paymentMethod" value="cash" onchange="togglePaymentFields()">
          <label for="paymentCash" style="margin-left: 5px;">ç¾å ´ç¹³ç´</label>
        </div>
      </div>
      
      <div id="transferFields" style="margin: 15px 0;">
        <label style="font-weight: bold;">è½‰å¸³æœ«äº”ç¢¼ï¼š</label><br>
        <input type="text" id="transferLastDigits" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" maxlength="5" placeholder="è«‹è¼¸å…¥è½‰å¸³æœ«äº”ç¢¼">
      </div>
      
      <div id="cashFields" style="margin: 15px 0; display: none;">
        <label style="font-weight: bold;">ç¾å ´ç¹³ç´æ—¥æœŸï¼š</label><br>
        <input type="date" id="cashPaymentDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">ç¬¬ä¸€æ¬¡è«®å•†æ—¥æœŸï¼š</label><br>
        <input type="date" id="firstCounselingDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="processDeposit()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªç¹³ç´</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      // åˆå§‹åŒ–é é¢æ™‚è¨­å®šä»Šå¤©æ—¥æœŸ
      document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        const todayString = year + "-" + month + "-" + day;
        
        document.getElementById("firstCounselingDate").value = todayString;
        document.getElementById("cashPaymentDate").value = todayString;
        
        // è¨­ç½®åå­—è¼¸å…¥æ¡†çš„äº‹ä»¶ç›£è½
        setupClientNameInputFilter();
      });
      
      // åˆ‡æ›ç¹³è²»æ–¹å¼æ™‚é¡¯ç¤º/éš±è—å°æ‡‰æ¬„ä½
      function togglePaymentFields() {
        const isTransfer = document.getElementById('paymentTransfer').checked;
        const transferFields = document.getElementById('transferFields');
        const cashFields = document.getElementById('cashFields');
        
        if (isTransfer) {
          transferFields.style.display = 'block';
          cashFields.style.display = 'none';
          // æ¸…ç©ºç¾å ´ç¹³ç´æ¬„ä½
          document.getElementById('cashPaymentDate').value = '';
        } else {
          transferFields.style.display = 'none';
          cashFields.style.display = 'block';
          // æ¸…ç©ºè½‰å¸³æ¬„ä½
          document.getElementById('transferLastDigits').value = '';
          // è¨­å®šç¾å ´ç¹³ç´æ—¥æœŸç‚ºä»Šå¤©
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, "0");
          const day = String(today.getDate()).padStart(2, "0");
          document.getElementById('cashPaymentDate').value = year + "-" + month + "-" + day;
        }
      }
      
      // è¨­ç½®å€‹æ¡ˆåç¨±çš„éæ¿¾åŠŸèƒ½
      function setupClientNameInputFilter() {
        const clientNameInput = document.getElementById('clientName');
        const clientList = document.getElementById('clientList');
        const originalOptions = Array.from(clientList.options).map(opt => opt.value);
        
        clientNameInput.addEventListener('input', function() {
          const searchValue = this.value.toLowerCase();
          const errorElement = document.getElementById('clientNameError');
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…çš„åå­—
          const exactMatch = originalOptions.some(option => option === this.value);
          if (this.value && !exactMatch) {
            errorElement.style.display = 'block';
          } else {
            errorElement.style.display = 'none';
          }
        });
      }
      
      function processDeposit() {
        var clientName = document.getElementById('clientName').value;
        var paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        var transferLastDigits = document.getElementById('transferLastDigits').value;
        var cashPaymentDate = document.getElementById('cashPaymentDate').value;
        var firstCounselingDate = document.getElementById('firstCounselingDate').value;
        
        if (!clientName || !firstCounselingDate) {
          showMessage('è«‹å¡«å¯«å€‹æ¡ˆå§“åå’Œç¬¬ä¸€æ¬¡è«®å•†æ—¥æœŸ', 'error');
          return;
        }
        
        // æ ¹æ“šç¹³è²»æ–¹å¼é©—è­‰å¿…è¦æ¬„ä½
        if (paymentMethod === 'transfer') {
          if (!transferLastDigits) {
            showMessage('è«‹è¼¸å…¥è½‰å¸³æœ«äº”ç¢¼', 'error');
            return;
          }
          if (transferLastDigits.length !== 5 || !/^\\d+$/.test(transferLastDigits)) {
            showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„è½‰å¸³æœ«äº”ç¢¼ï¼ˆ5ä½æ•¸å­—ï¼‰', 'error');
            return;
          }
        } else if (paymentMethod === 'cash') {
          if (!cashPaymentDate) {
            showMessage('è«‹é¸æ“‡ç¾å ´ç¹³ç´æ—¥æœŸ', 'error');
            return;
          }
        }
        
        // åš´æ ¼é©—è­‰å®¢æˆ¶åç¨±æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
        const clientList = document.getElementById('clientList');
        const clients = Array.from(clientList.options).map(opt => opt.value);
        if (!clients.includes(clientName)) {
          showMessage('æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º', 'error');
          return;
        }
        
        document.getElementById('message').style.display = 'none';
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        showLoading();
        
        google.script.run
          .withSuccessHandler(function(result) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            if (result.success) {
              if (result.notificationMessage) {
                // é¡¯ç¤ºä¿è­‰é‡‘å·²ç¹³ç´è¨Šæ¯æ¡†
                document.getElementById('message').style.display = "none";
                document.getElementById('deposit-container').innerHTML = result.notificationMessage;
              } else {
                showMessage('ä¿è­‰é‡‘å·²æˆåŠŸç¹³ç´ï¼', 'success');
                setTimeout(function() {
                  google.script.host.close();
                }, 2000);
              }
            } else {
              showMessage(result.message || 'ç¹³ç´å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .processDepositPayment(clientName, paymentMethod, transferLastDigits, cashPaymentDate, firstCounselingDate);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(550);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ç¹³äº¤ä¿è­‰é‡‘');
}

/**
 * è™•ç†ä¿è­‰é‡‘ç¹³ç´è«‹æ±‚ï¼ˆæ”¯æ´è½‰å¸³å’Œç¾å ´ç¹³ç´ï¼‰
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} paymentMethod - ç¹³è²»æ–¹å¼ ('transfer' æˆ– 'cash')
 * @param {string} transferLastDigits - è½‰å¸³æœ«äº”ç¢¼ï¼ˆè½‰å¸³æ™‚ä½¿ç”¨ï¼‰
 * @param {string} cashPaymentDate - ç¾å ´ç¹³ç´æ—¥æœŸï¼ˆç¾å ´ç¹³ç´æ™‚ä½¿ç”¨ï¼‰
 * @param {string} firstCounselingDate - ç¬¬ä¸€æ¬¡è«®å•†æ—¥æœŸ
 * @return {Object} è™•ç†çµæœ
 */
function processDepositPayment(clientName, paymentMethod, transferLastDigits, cashPaymentDate, firstCounselingDate) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    const firstCounselingDateObj = new Date(firstCounselingDate);
    let recordFound = false;
    let counselor = "";
    let serviceType = "";
    
    // æœå°‹ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„ä¸¦æ›´æ–°ä¿è­‰é‡‘ç‹€æ…‹
    for (let i = 1; i < data.length; i++) {
      const name = data[i][1];
      const date = new Date(data[i][2]);
      
      if (name && name === clientName && 
          date.getFullYear() === firstCounselingDateObj.getFullYear() && 
          date.getMonth() === firstCounselingDateObj.getMonth() && 
          date.getDate() === firstCounselingDateObj.getDate()) {
        
        // æ”¶é›†æ›´å¤šä¿¡æ¯ç”¨æ–¼é€šçŸ¥
        counselor = data[i][3];
        serviceType = data[i][4];
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰Håˆ—ï¼ˆä¿è­‰é‡‘æ¬„ä½ï¼‰
        let depositCol = 8; // Håˆ—çš„ç´¢å¼•ç‚º7ï¼Œä½†Google Sheetsç´¢å¼•å¾1é–‹å§‹
        
        // æ ¹æ“šç¹³è²»æ–¹å¼è¨­å®šä¸åŒçš„ä¿è­‰é‡‘ç‹€æ…‹
        let depositStatus = '';
        if (paymentMethod === 'transfer') {
          depositStatus = `å·²ç¹³ç´ (${transferLastDigits})`;
        } else if (paymentMethod === 'cash') {
          const cashDate = Utilities.formatDate(new Date(cashPaymentDate), "Asia/Taipei", "MM/dd");
          depositStatus = `å·²ç¹³ç´ (ç¾å ´ ${cashDate})`;
        }
        
        // æ›´æ–°ä¿è­‰é‡‘ç‹€æ…‹
        sheet.getRange(i + 1, depositCol).setValue(depositStatus);
        recordFound = true;
        
        break;
      }
    }
    
    if (!recordFound) {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      const paymentInfo = paymentMethod === 'transfer' ? 
        `è½‰å¸³æœ«äº”ç¢¼: ${transferLastDigits}` : 
        `ç¾å ´ç¹³ç´æ—¥æœŸ: ${cashPaymentDate}`;
      
      logSystemActivity(
        "ç¹³äº¤ä¿è­‰é‡‘",
        clientName,
        `ä¿è­‰é‡‘ç¹³ç´å¤±æ•—: æ‰¾ä¸åˆ°åŒ¹é…çš„è«®å•†è¨˜éŒ„`,
        "å¤±æ•—",
        "",
        `å˜—è©¦åŒ¹é…æ—¥æœŸ: ${firstCounselingDate}, ${paymentInfo}`
      );
      return { success: false, message: 'æ‰¾ä¸åˆ°åŒ¹é…çš„è«®å•†è¨˜éŒ„ï¼Œè«‹ç¢ºèªå€‹æ¡ˆåç¨±å’Œè«®å•†æ—¥æœŸ' };
    }
    
    // ç”Ÿæˆä¿è­‰é‡‘å·²ç¹³ç´é€šçŸ¥
    const notificationMessage = generateNotificationMessage('deposit', {
      clientName: clientName,
      counselor: counselor,
      serviceType: serviceType,
      paymentMethod: paymentMethod,
      transferLastDigits: transferLastDigits,
      cashPaymentDate: cashPaymentDate
    });
    
    // ã€æ–°å¢ã€‘ç¹³äº¤æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
    createHelperTodoItem(
      OPERATION_TYPES.DEPOSIT_PAYMENT,
      clientName,
      {
        date: firstCounselingDate,
        time: "",
        therapist: counselor,
        room: "",
        serviceType: serviceType,
        additionalInfo: `ä¿è­‰é‡‘ç¹³äº¤ï¼š${paymentMethod === 'transfer' ? 'è½‰å¸³' : 'ç¾å ´ç¹³ç´'}`
      }
    );

    // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
    const paymentInfo = paymentMethod === 'transfer' ? 
      `è½‰å¸³æœ«äº”ç¢¼: ${transferLastDigits}` : 
      `ç¾å ´ç¹³ç´æ—¥æœŸ: ${cashPaymentDate}`;
    
    logSystemActivity(
      "ç¹³äº¤ä¿è­‰é‡‘",
      clientName,
      `${paymentInfo}, é¦–æ¬¡è«®å•†æ—¥æœŸ: ${firstCounselingDate}`,
      "æˆåŠŸ",
      counselor,
      `å·²æ›´æ–°ä¿è­‰é‡‘ç‹€æ…‹ç‚ºå·²ç¹³ç´ï¼ˆ${paymentMethod === 'transfer' ? 'è½‰å¸³' : 'ç¾å ´'}ï¼‰`
    );
    
    return { 
      success: true,
      notificationMessage: notificationMessage
    };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "ç¹³äº¤ä¿è­‰é‡‘",
      clientName,
      `ä¿è­‰é‡‘ç¹³ç´å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—"
    );
    
    Logger.log("è™•ç†ä¿è­‰é‡‘ç¹³ç´æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†ä¿è­‰é‡‘ç¹³ç´æ™‚å‡ºç¾éŒ¯èª¤' };
  }
}

/**
 * ç¢ºä¿é€šçŸ¥å¿ƒç†å¸«è¡¨æ ¼å­˜åœ¨
 */
function ensureCounselorNotificationSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("é€šçŸ¥å¿ƒç†å¸«");
  
  if (!sheet) {
    sheet = ss.insertSheet("é€šçŸ¥å¿ƒç†å¸«");
    sheet.appendRow(["å¿ƒç†å¸«å§“å", "é›»å­éƒµä»¶"]);
    sheet.getRange("A1:B1").setFontWeight("bold");
    
    // æ·»åŠ ä¸€äº›å‡è³‡æ–™ä¾›æ¸¬è©¦
    sheet.appendRow(["ç‹é†«å¸«", "example1@gmail.com"]);
    sheet.appendRow(["æé†«å¸«", "example2@gmail.com"]);
    sheet.appendRow(["å¼µé†«å¸«", "example3@gmail.com"]);
  }
  
  return sheet;
}

/**
 * ç²å–å¿ƒç†å¸«çš„é›»å­éƒµä»¶åœ°å€
 * @param {string} counselorName - å¿ƒç†å¸«å§“å
 * @return {string|null} å¿ƒç†å¸«çš„é›»å­éƒµä»¶åœ°å€
 */
function getCounselorEmail(counselorName) {
  try {
    ensureCounselorNotificationSheet();
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("é€šçŸ¥å¿ƒç†å¸«");
    const data = sheet.getDataRange().getValues();
    
    // æœå°‹å¿ƒç†å¸«çš„éƒµä»¶åœ°å€ï¼Œå…è¨±éƒ¨åˆ†åŒ¹é…
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === counselorName || 
          data[i][0].includes(counselorName) || 
          counselorName.includes(data[i][0])) {
        Logger.log(`æ‰¾åˆ°å¿ƒç†å¸« ${counselorName} çš„éƒµä»¶åœ°å€: ${data[i][1]}`);
        return data[i][1];
      }
    }
    
    // å¦‚æœåœ¨è¡¨æ ¼ä¸­æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é è¨­å€¼
    Logger.log(`åœ¨è¡¨æ ¼ä¸­æ‰¾ä¸åˆ°å¿ƒç†å¸« ${counselorName} çš„éƒµä»¶åœ°å€ï¼Œä½¿ç”¨é è¨­å€¼`);
    return null;
  } catch (error) {
    Logger.log(`ç²å–å¿ƒç†å¸«éƒµä»¶åœ°å€æ™‚å‡ºéŒ¯: ${error.toString()}`);
    return null;
  }
}

/**
 * é€šçŸ¥å¿ƒç†å¸«æœ‰æ–°çš„é ç´„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {Date|string} date - è«®å•†æ—¥æœŸ
 * @param {string} time - è«®å•†æ™‚é–“
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} room - è«®å•†å®¤
 * @return {boolean} æ˜¯å¦æˆåŠŸç™¼é€éƒµä»¶
 */
function notifyCounselor(clientName, serviceType, date, time, counselor, room) {
  try {
    // ç²å–å¿ƒç†å¸«éƒµä»¶åœ°å€
    const email = getCounselorEmail(counselor);
    if (!email) {
      Logger.log(`ç„¡æ³•é€šçŸ¥å¿ƒç†å¸« ${counselor}ï¼Œæ‰¾ä¸åˆ°éƒµä»¶åœ°å€`);
      return false;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    const dateObj = date instanceof Date ? date : new Date(date);
    const formattedDate = formatDateWithWeekday(dateObj);
    const formattedTime = time instanceof Date ? 
      Utilities.formatDate(time, "Asia/Taipei", "HH:mm") : time;
    
    // ç²å–æœå‹™æ–¹æ¡ˆçš„é¡¯ç¤ºåç¨±
    const displayServiceType = getDisplayName(serviceType, 'service');
    
    // éƒµä»¶ä¸»é¡Œ
    const subject = `ã€æ–°é ç´„é€šçŸ¥ã€‘${formattedDate} ${formattedTime} ${clientName}`;
    
    // å‰µå»º Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
    const calendarLink = createGoogleCalendarLink(clientName, serviceType, dateObj, time, counselor, room);
    
    // éƒµä»¶å…§å®¹
    const body = `
      <div style="font-family: Arial, sans-serif; padding: 15px;">
        <h2 style="color: #4285f4;">æ–°é ç´„é€šçŸ¥</h2>
        <p>è¦ªæ„›çš„ ${counselor}ï¼Œæ‚¨æœ‰ä¸€å€‹æ–°çš„é ç´„ï¼š</p>
        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #4285f4; margin: 15px 0;">
          <p><strong>å€‹æ¡ˆå§“åï¼š</strong>${clientName}</p>
          <p><strong>æœå‹™æ–¹æ¡ˆï¼š</strong>${displayServiceType}</p>
          <p><strong>è«®å•†æ—¥æœŸï¼š</strong>${formattedDate}</p>
          <p><strong>è«®å•†æ™‚é–“ï¼š</strong>${formattedTime}</p>
          <p><strong>è«®å•†å®¤ï¼š</strong>${room}</p>
        </div>
        <div style="text-align: center; margin: 20px 0;">
          <a href="${calendarLink}" target="_blank" style="display: inline-block; background-color: #4285f4; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold;">æ–°å¢è‡³æˆ‘çš„è¡Œäº‹æ›†</a>
        </div>
        <p>æ­¤éƒµä»¶ç”±ç³»çµ±è‡ªå‹•ç™¼é€ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚</p>
      </div>
    `;
    
    // ç™¼é€éƒµä»¶
    GmailApp.sendEmail(email, subject, "", {
      htmlBody: body,
      name: getSystemConfig().systemName
    });
    
    Logger.log(`å·²æˆåŠŸç™¼é€é€šçŸ¥çµ¦å¿ƒç†å¸« ${counselor} (${email})`);
    return true;
  } catch (error) {
    Logger.log(`é€šçŸ¥å¿ƒç†å¸«æ™‚å‡ºéŒ¯: ${error.toString()}`);
    return false;
  }
}

/**
 * å‰µå»º Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {Date} date - è«®å•†æ—¥æœŸ
 * @param {string} timeValue - è«®å•†æ™‚é–“
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} room - è«®å•†å®¤
 * @return {string} Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
 */
function createGoogleCalendarLink(clientName, serviceType, date, timeValue, counselor, room) {
  try {
    const config = getSystemConfig();
    
    // è™•ç†æ™‚é–“æ ¼å¼
    let formattedTime;
    if (timeValue instanceof Date) {
      formattedTime = Utilities.formatDate(timeValue, config.timeZone, "HH:mm");
    } else {
      formattedTime = timeValue;
    }
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [hours, minutes] = formattedTime.split(':').map(Number);
    
    // è¨­å®šäº‹ä»¶é–‹å§‹æ™‚é–“
    const startTime = new Date(date instanceof Date ? date : new Date(date));
    startTime.setHours(hours);
    startTime.setMinutes(minutes);
    startTime.setSeconds(0);
    
    // è¨­å®šçµæŸæ™‚é–“ï¼ˆæ ¹æ“šè«®å•†æ™‚é•·ï¼‰
    const endTime = new Date(startTime.getTime() + (config.counselingDuration * 60 * 1000));
    
    // ç²å–æ­¤æ¬¡æœå‹™çš„æ¬¡æ•¸
    const clientHistory = getClientServiceHistory(clientName);
    const currentServiceCount = clientHistory[serviceType] || 1;
    
    // å‰µå»ºäº‹ä»¶æ¨™é¡Œ
    const title = `ï¼ˆ${serviceType} ${currentServiceCount}ï¼‰${clientName}ï¼ˆ${counselor}ï¼‰- ${room}`;
    
    // å‰µå»ºäº‹ä»¶æè¿°
    const description = `æœå‹™æ–¹æ¡ˆ: ${serviceType}\nè«®å•†å¸«: ${counselor}\nè«®å•†å®¤: ${room}`;
    
    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º Google æ—¥æ›† URL æ ¼å¼
    const startDate = Utilities.formatDate(startTime, "UTC", "yyyyMMdd'T'HHmmss'Z'");
    const endDate = Utilities.formatDate(endTime, "UTC", "yyyyMMdd'T'HHmmss'Z'");
    
    // å»ºç«‹ Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
    const baseUrl = "https://calendar.google.com/calendar/render";
    const params = {
      action: "TEMPLATE",
      text: encodeURIComponent(title),
      dates: `${startDate}/${endDate}`,
      details: encodeURIComponent(description),
      location: encodeURIComponent(room),
      sf: true,
      output: "xml"
    };
    
    // çµ„åˆ URL åƒæ•¸
    const queryString = Object.keys(params)
      .map(key => `${key}=${params[key]}`)
      .join("&");
    
    return `${baseUrl}?${queryString}`;
  } catch (error) {
    Logger.log(`å‰µå»º Google æ—¥æ›†é€£çµæ™‚å‡ºéŒ¯: ${error.toString()}`);
    return "#"; // è¿”å›ç©ºé€£çµ
  }
}


/**
 * å¾å°ç…§è¡¨å–å¾—é¡¯ç¤ºåç¨±
 * @param {string} originalName - åŸå§‹åç¨±
 * @param {string} type - é¡å‹ ('service' æˆ– 'counselor')
 * @return {string} é¡¯ç¤ºåç¨±
 */
function getDisplayName(originalName, type) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = type === 'service' ? 'æœå‹™æ–¹æ¡ˆå°ç…§è¡¨' : 'å¿ƒç†å¸«å°ç…§è¡¨';
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) return originalName; // å¦‚æœæ‰¾ä¸åˆ°å°ç…§è¡¨ï¼Œè¿”å›åŸå§‹åç¨±
    
    const data = sheet.getDataRange().getValues();
    
    // è·³éæ¨™é¡Œè¡Œï¼Œæœå°‹å°æ‡‰çš„é¡¯ç¤ºåç¨±
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === originalName) {
        return data[i][1] || originalName;
      }
    }
    
    return originalName; // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰ï¼Œè¿”å›åŸå§‹åç¨±
  } catch (error) {
    Logger.log(`å–å¾—é¡¯ç¤ºåç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.toString()}`);
    return originalName;
  }
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸä¸¦åŠ å…¥æ˜ŸæœŸ
 * @param {Date} date - æ—¥æœŸç‰©ä»¶
 * @return {string} æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸå­—ä¸²
 */
function formatDateWithWeekday(date) {
  try {
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekday = weekdays[date.getDay()];
    return Utilities.formatDate(date, "Asia/Taipei", "yyyy/MM/dd") + `(${weekday})`;
  } catch (error) {
    Logger.log(`æ ¼å¼åŒ–æ—¥æœŸæ™‚å‡ºéŒ¯: ${error.toString()}`);
    return date ? date.toLocaleDateString() : 'æ—¥æœŸéŒ¯èª¤';
  }
}

/**
 * å‰µå»ºæ—¥æ›†äº‹ä»¶
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {Date|string} date - è«®å•†æ—¥æœŸ
 * @param {string} timeValue - è«®å•†æ™‚é–“
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} room - è«®å•†å®¤
 * @return {CalendarEvent|null} å‰µå»ºçš„æ—¥æ›†äº‹ä»¶
 */
function createCalendarEvent(clientName, serviceType, date, timeValue, counselor, room) {
  try {
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    Logger.log("åŸå§‹æ™‚é–“å€¼ï¼š" + timeValue);
    Logger.log("æ™‚é–“å€¼é¡å‹ï¼š" + typeof timeValue);
    
    // è™•ç†æ™‚é–“æ ¼å¼
    let formattedTime;
    if (timeValue instanceof Date) {
      formattedTime = Utilities.formatDate(timeValue, config.timeZone, "HH:mm");
    } else {
      formattedTime = timeValue;
    }
    
    Logger.log("æ ¼å¼åŒ–å¾Œçš„æ™‚é–“ï¼š" + formattedTime);
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [hours, minutes] = formattedTime.split(':').map(Number);
    
    // è¨­å®šäº‹ä»¶é–‹å§‹æ™‚é–“
    const startTime = new Date(date instanceof Date ? date : new Date(date));
    startTime.setHours(hours);
    startTime.setMinutes(minutes);
    startTime.setSeconds(0);
    
    // è¨­å®šçµæŸæ™‚é–“ï¼ˆæ ¹æ“šè«®å•†æ™‚é•·ï¼‰
    const endTime = new Date(startTime.getTime() + (config.counselingDuration * 60 * 1000));

    Logger.log("é è¨ˆå‰µå»ºçš„æ™‚é–“ï¼š");
    Logger.log("é–‹å§‹æ™‚é–“ï¼š" + Utilities.formatDate(startTime, config.timeZone, "yyyy/MM/dd HH:mm"));
    Logger.log("çµæŸæ™‚é–“ï¼š" + Utilities.formatDate(endTime, config.timeZone, "yyyy/MM/dd HH:mm"));

    // ç²å–å€‹æ¡ˆæ­·å²æœå‹™è¨˜éŒ„
    const clientHistory = getClientServiceHistory(clientName);
    let historyText = "";
    if (clientHistory && Object.keys(clientHistory).length > 0) {
      historyText = "\n\nå€‹æ¡ˆæ­·å²æœå‹™è¨˜éŒ„ï¼š\n";
      for (const [type, count] of Object.entries(clientHistory)) {
        historyText += `${type}: ${count}æ¬¡\n`;
      }
    }

    // ç²å–æ­¤æ¬¡æœå‹™çš„æ¬¡æ•¸
    const currentServiceCount = clientHistory[serviceType] || 1;
    
    // ç²å–è½‰æ›å¾Œçš„åç¨±å’Œæ ¼å¼åŒ–çš„æ—¥æœŸæ™‚é–“
    const displayServiceType = getDisplayName(serviceType, 'service');
    const displayCounselor = getDisplayName(counselor, 'counselor');
    const formattedDateWithWeekday = formatDateWithWeekday(startTime);
    const formattedTimeOnly = Utilities.formatDate(startTime, config.timeZone, "HH:mm");

    // æ ¹æ“šæœå‹™æ¬¡æ•¸ç”Ÿæˆä¸åŒçš„LINEé€šçŸ¥æ–‡å­—
    let lineNotification;
    if (currentServiceCount <= 1) {
      lineNotification = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å¹«æ‚¨é ç´„ä½¿ç”¨${displayServiceType}ï¼Œå®‰æ’çš„æ˜¯${displayCounselor}ã€‚æ™‚é–“æ˜¯${formattedDateWithWeekday} ${formattedTimeOnly}ï¼Œç¬¬ä¸€æ¬¡ä¾†è«‹ææ—©10åˆ†é˜å¡«å¯«è³‡æ–™ä»¥åŠæ”œå¸¶èº«åˆ†è­‰å”·~æ„Ÿè¬æ‚¨ã€`;
    } else {
      lineNotification = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å¹«æ‚¨é ç´„ä½¿ç”¨${displayServiceType}ï¼Œå®‰æ’çš„æ˜¯${displayCounselor}ã€‚æ™‚é–“æ˜¯${formattedDateWithWeekday} ${formattedTimeOnly}ï¼Œæ„Ÿè¬æ‚¨~ã€`;
    }
    
    // å‰µå»ºäº‹ä»¶ï¼Œä½¿ç”¨æ–°çš„æ¨™é¡Œæ ¼å¼
    const title = `ï¼ˆ${serviceType} ${currentServiceCount}ï¼‰${clientName}ï¼ˆ${counselor}ï¼‰- ${room}`;
    const event = calendar.createEvent(title, startTime, endTime, {
      description: `æœå‹™æ–¹æ¡ˆ: ${serviceType}\nè«®å•†å¸«: ${counselor}\nè«®å•†å®¤: ${room}${historyText}\n\nã€LINEé€šçŸ¥æ–‡å­—ã€‘\n${lineNotification}`,
      timeZone: config.timeZone
    });
    
    if (event) {
      Logger.log("äº‹ä»¶å‰µå»ºæˆåŠŸï¼");
      Logger.log("äº‹ä»¶æ¨™é¡Œï¼š" + event.getTitle());
      Logger.log("å¯¦éš›äº‹ä»¶æ™‚é–“ï¼š" + 
        Utilities.formatDate(event.getStartTime(), config.timeZone, "yyyy/MM/dd HH:mm"));
    }
    
    return event;
  } catch (error) {
    Logger.log("å‰µå»ºæ—¥æ›†äº‹ä»¶éŒ¯èª¤ï¼š" + error.toString());
    return null;
  }
}

/**
 * ç²å–å€‹æ¡ˆçš„æ­·å²æœå‹™è¨˜éŒ„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @return {Object} å€‹æ¡ˆæ­·å²æœå‹™è¨˜éŒ„
 */
function getClientServiceHistory(clientName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // å‰µå»ºæ¨™æº–åŒ–æœå‹™é¡å‹çš„æ˜ å°„è¡¨
    const serviceTypeMap = getServiceTypeMapping();
    
    // å‰µå»ºçµ±è¨ˆç‰©ä»¶
    const clientHistory = {};
    
    // é¦–å…ˆå¾ã€Œå€‹æ¡ˆæœå‹™è¨˜éŒ„ã€è¡¨æ ¼ä¸­ç²å–é è¨­æ¬¡æ•¸
    const recordSheet = ss.getSheetByName("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
    if (recordSheet) {
      const records = recordSheet.getDataRange().getValues();
      // è·³éæ¨™é¡Œè¡Œ
      for (let i = 1; i < records.length; i++) {
        const name = records[i][0];
        // æª¢æŸ¥åå­—æ˜¯å¦åŒ…å«åœ¨å®¢æˆ¶åç¨±ä¸­ï¼Œæˆ–å®¢æˆ¶åç¨±æ˜¯å¦åŒ…å«æ­¤åå­—
        if (name && (clientName.includes(name) || name.includes(clientName))) {
          let serviceType = records[i][1];
          // æ¨™æº–åŒ–æœå‹™é¡å‹
          serviceType = standardizeServiceType(serviceType, serviceTypeMap);
          const count = parseInt(records[i][2]);
          
          // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„æœå‹™é¡å‹ä½œç‚ºéµ
          clientHistory[serviceType] = count;
        }
      }
    }
    
    // ç„¶å¾Œå¾å¯¦éš›ç™»éŒ„è³‡æ–™ä¸­è¨ˆç®—æ¬¡æ•¸
    const dataSheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    if (dataSheet) {
      const data = dataSheet.getDataRange().getValues();
      
      // è·³éæ¨™é¡Œè¡Œ
      for (let i = 1; i < data.length; i++) {
        const name = data[i][1];
        // æª¢æŸ¥åå­—æ˜¯å¦åŒ…å«åœ¨å®¢æˆ¶åç¨±ä¸­ï¼Œæˆ–å®¢æˆ¶åç¨±æ˜¯å¦åŒ…å«æ­¤åå­—
        if (name && (clientName.includes(name) || name.includes(clientName))) {
          let serviceType = data[i][4];
          if (serviceType) {
            // æ¨™æº–åŒ–æœå‹™é¡å‹
            serviceType = standardizeServiceType(serviceType, serviceTypeMap);
            
            // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„æœå‹™é¡å‹ä½œç‚ºéµ
            clientHistory[serviceType] = (clientHistory[serviceType] || 0) + 1;
          }
        }
      }
    }
    
    return clientHistory;
  } catch (error) {
    Logger.log("ç²å–å€‹æ¡ˆæ­·å²è¨˜éŒ„éŒ¯èª¤ï¼š" + error.toString());
    return {};
  }
}

/**
 * ç²å–æœå‹™é¡å‹çš„æ¨™æº–åŒ–æ˜ å°„
 * @return {Object} æœå‹™é¡å‹æ˜ å°„è¡¨
 */
function getServiceTypeMapping() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const mappingSheet = ss.getSheetByName("æœå‹™æ–¹æ¡ˆå°ç…§è¡¨");
    const mapping = {};
    
    if (mappingSheet) {
      const data = mappingSheet.getDataRange().getValues();
      // è·³éæ¨™é¡Œè¡Œ
      for (let i = 1; i < data.length; i++) {
        if (data[i][0] && data[i][1]) {
          // å»ºç«‹é›™å‘æ˜ å°„ï¼Œå°‡ç°¡ç¨±å’Œå…¨åéƒ½æ˜ å°„åˆ°æ¨™æº–åç¨±
          const standardName = data[i][0]; // ä½¿ç”¨ç¬¬ä¸€åˆ—ä½œç‚ºæ¨™æº–åç¨±
          const displayName = data[i][1];
          
          mapping[standardName.toLowerCase()] = standardName;
          mapping[displayName.toLowerCase()] = standardName;
        }
      }
    }
    
    return mapping;
  } catch (error) {
    Logger.log("ç²å–æœå‹™é¡å‹æ˜ å°„éŒ¯èª¤ï¼š" + error.toString());
    return {};
  }
}

/**
 * æ¨™æº–åŒ–æœå‹™é¡å‹åç¨±
 * @param {string} serviceType - åŸå§‹æœå‹™é¡å‹åç¨±
 * @param {Object} mapping - æœå‹™é¡å‹æ˜ å°„è¡¨
 * @return {string} æ¨™æº–åŒ–å¾Œçš„æœå‹™é¡å‹åç¨±
 */
function standardizeServiceType(serviceType, mapping) {
  if (!serviceType) return serviceType;
  
  // è½‰ç‚ºå°å¯«é€²è¡Œæ¯”å°
  const lowercaseType = serviceType.toLowerCase();
  
  // å¾æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾æ¨™æº–åç¨±
  if (mapping[lowercaseType]) {
    return mapping[lowercaseType];
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œå˜—è©¦é€²è¡Œéƒ¨åˆ†åŒ¹é…
  for (const [key, value] of Object.entries(mapping)) {
    if (lowercaseType.includes(key) || key.includes(lowercaseType)) {
      return value;
    }
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…ï¼Œè¿”å›åŸå§‹å€¼
  return serviceType;
}

/**
 * ç²å–å®¢æˆ¶çš„æœå‹™é¡å‹
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} date - è«®å•†æ—¥æœŸ
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @return {string} æœå‹™é¡å‹
 */
function getClientServiceType(clientName, date, counselor) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    // å°‡æ—¥æœŸè½‰æ›ç‚ºå­—ç¬¦ä¸²æ ¼å¼ï¼Œä»¥ä¾¿æ¯”è¼ƒ
    const dateString = date instanceof Date ? 
      Utilities.formatDate(date, "Asia/Taipei", "yyyy-MM-dd") : 
      Utilities.formatDate(new Date(date), "Asia/Taipei", "yyyy-MM-dd");
    
    // æœå°‹ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„
    for (let i = 1; i < data.length; i++) {
      const rowClientName = data[i][1];
      const rowDate = data[i][2];
      const rowCounselor = data[i][3];
      const rowServiceType = data[i][4];
      
      // å°‡è¡Œä¸­çš„æ—¥æœŸè½‰æ›ç‚ºç›¸åŒæ ¼å¼
      const rowDateString = rowDate instanceof Date ? 
        Utilities.formatDate(rowDate, "Asia/Taipei", "yyyy-MM-dd") : 
        Utilities.formatDate(new Date(rowDate), "Asia/Taipei", "yyyy-MM-dd");
      
      // æª¢æŸ¥æ˜¯å¦ç¬¦åˆæ‰€æœ‰æ¢ä»¶
      if (rowClientName === clientName && 
          rowDateString === dateString && 
          rowCounselor === counselor) {
        return rowServiceType;
      }
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆçš„è¨˜éŒ„ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    return "";
  } catch (error) {
    Logger.log("ç²å–å®¢æˆ¶æœå‹™é¡å‹æ™‚å‡ºéŒ¯: " + error.toString());
    return "";
  }
}

/**
 * æ›´æ–°çµ±è¨ˆå ±è¡¨çš„å‡½æ•¸
 */
function updateStatistics() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dataSheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const statsSheet = ss.getSheetByName("çµ±è¨ˆå ±è¡¨");
    
    // å¦‚æœçµ±è¨ˆå ±è¡¨ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹
    if (!statsSheet) {
      const newStatsSheet = ss.insertSheet("çµ±è¨ˆå ±è¡¨");
      newStatsSheet.getRange(1, 1, 1, 5).setValues([["å¹´ä»½", "æœˆä»½", "å¿ƒç†å¸«", "æœå‹™æ–¹æ¡ˆ", "æ¬¡æ•¸"]]);
      newStatsSheet.getRange(1, 1, 1, 5).setFontWeight("bold");
      statsSheet = newStatsSheet;
    } else {
      // æ¸…é™¤èˆŠçš„çµ±è¨ˆè³‡æ–™ï¼ˆä¿ç•™æ¨™é¡Œï¼‰
      if (statsSheet.getLastRow() > 1) {
        statsSheet.getRange(2, 1, statsSheet.getLastRow()-1, statsSheet.getLastColumn()).clear();
      }
    }
    
    // ç²å–æ‰€æœ‰è³‡æ–™
    const data = dataSheet.getDataRange().getValues();
    
    // å‰µå»ºçµ±è¨ˆç‰©ä»¶
    const stats = {};
    
    // è·³éæ¨™é¡Œè¡Œ
    for (let i = 1; i < data.length; i++) {
      const counselor = data[i][3];
      const serviceType = data[i][4];
      const date = new Date(data[i][2]);
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      const key = `${year}-${month}-${counselor}-${serviceType}`;
      
      stats[key] = (stats[key] || 0) + 1;
    }
    
    // å¯«å…¥çµ±è¨ˆæ•¸æ“š
    const statsData = Object.entries(stats).map(([key, value]) => {
      const [year, month, counselor, serviceType] = key.split("-");
      return [year, month, counselor, serviceType, value];
    });
    
    if (statsData.length > 0) {
      statsSheet.getRange(2, 1, statsData.length, 5).setValues(statsData);
    }
    
    Logger.log("çµ±è¨ˆå ±è¡¨å·²æ›´æ–°");
  } catch (error) {
    Logger.log("æ›´æ–°çµ±è¨ˆå ±è¡¨éŒ¯èª¤ï¼š" + error.toString());
  }
}

/**
 * å–æ¶ˆé ç´„çš„å‡½æ•¸ - å°‡åŸäº‹ä»¶è®Šæˆç°è‰²è€Œéåˆªé™¤
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} appointmentDate - é ç´„æ—¥æœŸ
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @return {boolean} æ˜¯å¦æˆåŠŸå–æ¶ˆ
 */
function cancelAppointment(clientName, appointmentDate, counselor) {
  try {
    // 1. ä¿®æ”¹æ—¥æ›†äº‹ä»¶æ¨™é¡Œï¼Œä¸¦è¨­ç‚ºç°è‰²
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    const events = calendar.getEventsForDay(appointmentDate);
    let eventFound = false;
    
    for (let event of events) {
      const title = event.getTitle();
      if (title.includes(clientName) && !title.includes("ã€å–æ¶ˆã€‘")) {
        // ä¿®æ”¹æ¨™é¡Œï¼Œåœ¨å‰é¢åŠ ä¸Šã€å–æ¶ˆã€‘
        event.setTitle(`ã€å–æ¶ˆã€‘${title}`);
        
        // å°‡äº‹ä»¶è¨­ç‚ºç°è‰² (ä½¿ç”¨ Google æ—¥æ›†çš„ "8" ç°è‰²)
        event.setColor(CalendarApp.EventColor.GRAY);
        
        Logger.log("å·²å°‡æ—¥æ›†äº‹ä»¶æ¨™è¨˜ç‚ºå–æ¶ˆä¸¦è¨­ç‚ºç°è‰²");
        eventFound = true;
        break;
      }
    }

    if (!eventFound) {
      Logger.log("æœªæ‰¾åˆ°å°æ‡‰çš„æ—¥æ›†äº‹ä»¶");
    }

    // 2. å¾è©¦ç®—è¡¨ä¸­åˆªé™¤è³‡æ–™
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === clientName && 
          new Date(data[i][2]).toDateString() === appointmentDate.toDateString() &&
          data[i][3] === counselor) {
        sheet.deleteRow(i + 1);
        Logger.log("å·²å¾è©¦ç®—è¡¨åˆªé™¤è³‡æ–™");
        break;
      }
    }

    // 3. æ›´æ–°çµ±è¨ˆè³‡æ–™
    updateStatistics();
    Logger.log("å·²æ›´æ–°çµ±è¨ˆè³‡æ–™");
    
    // 4. ç™¼é€å–æ¶ˆé€šçŸ¥
    sendCancelNotification(clientName, appointmentDate, counselor);

    return true;
  } catch (error) {
    Logger.log("å–æ¶ˆé ç´„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.toString());
    return false;
  }
}

/**
 * ç™¼é€å–æ¶ˆé ç´„é€šçŸ¥
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} appointmentDate - é ç´„æ—¥æœŸ
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 */
function sendCancelNotification(clientName, appointmentDate, counselor) {
  try {
    // ç²å–å¿ƒç†å¸«éƒµä»¶åœ°å€
    const email = getCounselorEmail(counselor);
    if (!email) {
      Logger.log(`ç„¡æ³•ç™¼é€å–æ¶ˆé€šçŸ¥çµ¦å¿ƒç†å¸« ${counselor}ï¼Œæ‰¾ä¸åˆ°éƒµä»¶åœ°å€`);
      return;
    }
    
    // ç²å–æœå‹™é¡å‹
    const serviceType = getClientServiceType(clientName, appointmentDate, counselor);
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    const formattedDate = formatDateWithWeekday(appointmentDate);
    
    // éƒµä»¶ä¸»é¡Œ
    const subject = `ã€é ç´„å–æ¶ˆé€šçŸ¥ã€‘${formattedDate} ${clientName}`;
    
    // éƒµä»¶å…§å®¹
    const body = `
      <div style="font-family: Arial, sans-serif; padding: 15px;">
        <h2 style="color: #db4437;">é ç´„å–æ¶ˆé€šçŸ¥</h2>
        <p>è¦ªæ„›çš„ ${counselor}ï¼Œä»¥ä¸‹é ç´„å·²è¢«å–æ¶ˆï¼š</p>
        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #db4437; margin: 15px 0;">
          <p><strong>å€‹æ¡ˆå§“åï¼š</strong>${clientName}</p>
          <p><strong>æœå‹™æ–¹æ¡ˆï¼š</strong>${serviceType}</p>
          <p><strong>åŸå®šæ—¥æœŸï¼š</strong>${formattedDate}</p>
        </div>
        <p>æ­¤éƒµä»¶ç”±ç³»çµ±è‡ªå‹•ç™¼é€ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚</p>
      </div>
    `;
    
    // ç™¼é€éƒµä»¶
    GmailApp.sendEmail(email, subject, "", {
      htmlBody: body,
      name: getSystemConfig().systemName
    });
    
    Logger.log(`å·²æˆåŠŸç™¼é€å–æ¶ˆé€šçŸ¥çµ¦å¿ƒç†å¸« ${counselor} (${email})`);
  } catch (error) {
    Logger.log(`ç™¼é€å–æ¶ˆé€šçŸ¥æ™‚å‡ºéŒ¯: ${error.toString()}`);
  }
}

/**
 * ç™¼é€æ”¹æœŸé€šçŸ¥
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Date} originalDate - åŸå§‹é ç´„æ—¥æœŸ
 * @param {Date} newDate - æ–°é ç´„æ—¥æœŸ
 * @param {string} newTime - æ–°é ç´„æ™‚é–“
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} serviceType - æœå‹™é¡å‹
 * @param {string} room - è«®å•†å®¤
 */
function sendRescheduleNotification(clientName, originalDate, newDate, newTime, counselor, serviceType, room) {
  try {
    // ç²å–å¿ƒç†å¸«éƒµä»¶åœ°å€
    const email = getCounselorEmail(counselor);
    if (!email) {
      Logger.log(`ç„¡æ³•ç™¼é€æ”¹æœŸé€šçŸ¥çµ¦å¿ƒç†å¸« ${counselor}ï¼Œæ‰¾ä¸åˆ°éƒµä»¶åœ°å€`);
      return;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    const formattedOriginalDate = formatDateWithWeekday(originalDate);
    const formattedNewDate = formatDateWithWeekday(newDate);
    
    // å‰µå»º Google æ—¥æ›†æ–°å¢äº‹ä»¶é€£çµ
    const calendarLink = createGoogleCalendarLink(clientName, serviceType, newDate, newTime, counselor, room);
    
    // éƒµä»¶ä¸»é¡Œ
    const subject = `ã€é ç´„æ”¹æœŸé€šçŸ¥ã€‘${clientName} ${formattedOriginalDate} â†’ ${formattedNewDate}`;
    
    // éƒµä»¶å…§å®¹
    const body = `
      <div style="font-family: Arial, sans-serif; padding: 15px;">
        <h2 style="color: #f4b400;">é ç´„æ”¹æœŸé€šçŸ¥</h2>
        <p>è¦ªæ„›çš„ ${counselor}ï¼Œä»¥ä¸‹é ç´„å·²è¢«æ”¹æœŸï¼š</p>
        <div style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #f4b400; margin: 15px 0;">
          <p><strong>å€‹æ¡ˆå§“åï¼š</strong>${clientName}</p>
          <p><strong>æœå‹™æ–¹æ¡ˆï¼š</strong>${serviceType}</p>
          <p><strong>åŸå®šæ—¥æœŸï¼š</strong>${formattedOriginalDate}</p>
          <p><strong>æ–°é ç´„æ—¥æœŸï¼š</strong>${formattedNewDate}</p>
          <p><strong>æ–°é ç´„æ™‚é–“ï¼š</strong>${newTime}</p>
          <p><strong>è«®å•†å®¤ï¼š</strong>${room}</p>
        </div>
        <div style="text-align: center; margin: 20px 0;">
          <a href="${calendarLink}" target="_blank" style="display: inline-block; background-color: #f4b400; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold;">æ–°å¢è‡³æˆ‘çš„è¡Œäº‹æ›†</a>
        </div>
        <p>æ­¤éƒµä»¶ç”±ç³»çµ±è‡ªå‹•ç™¼é€ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚</p>
      </div>
    `;
    
    // ç™¼é€éƒµä»¶
    GmailApp.sendEmail(email, subject, "", {
      htmlBody: body,
      name: getSystemConfig().systemName
    });
    
    Logger.log(`å·²æˆåŠŸç™¼é€æ”¹æœŸé€šçŸ¥çµ¦å¿ƒç†å¸« ${counselor} (${email})`);
  } catch (error) {
    Logger.log(`ç™¼é€æ”¹æœŸé€šçŸ¥æ™‚å‡ºéŒ¯: ${error.toString()}`);
  }
}

/**
 * é¡¯ç¤ºå–æ¶ˆé ç´„çš„ä½¿ç”¨è€…ä»‹é¢
 */
function showCancelDialog() {
  // ç²å–å¿ƒç†å¸«åˆ—è¡¨
  const counselors = getCounselorList();
  const counselorOptions = counselors.map(counselor => 
    `<option value="${counselor}">${counselor}</option>`).join('');
  
  // ç²å–å®¢æˆ¶åå–®ä¾›ä¸‹æ‹‰é¸æ“‡
  const clients = getClientList();
  const clientOptions = clients.map(client => 
    `<option value="${client}">${client}</option>`).join('');
  
  var html = `
    <div id="cancel-container" style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #db4437;">å–æ¶ˆé ç´„</h2>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>
        <div style="position: relative; width: 100%;">
          <input type="text" id="clientName" list="clientList" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡å€‹æ¡ˆå§“å" autocomplete="off">
          <datalist id="clientList">
            ${clientOptions}
          </datalist>
          <div id="clientNameError" style="color: #c62828; font-size: 12px; margin-top: 3px; display: none;">æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º</div>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">é ç´„æ—¥æœŸï¼š</label><br>
        <input type="date" id="appointmentDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">è«®å•†å¸«ï¼š</label><br>
        <select id="counselor" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡è«®å•†å¸«</option>
          ${counselorOptions}
        </select>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å–æ¶ˆåŸå› ï¼š</label><br>
        <textarea id="cancelReason" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; height: 80px;" placeholder="è«‹è¼¸å…¥å–æ¶ˆåŸå› "></textarea>
      </div>
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitCancel()" style="background-color: #db4437; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªå–æ¶ˆ</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      // åˆå§‹åŒ–é é¢æ™‚è¨­å®šä»Šå¤©æ—¥æœŸ
      document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        document.getElementById("appointmentDate").value = year + "-" + month + "-" + day;
        
        // è¨­ç½®åå­—è¼¸å…¥æ¡†çš„äº‹ä»¶ç›£è½
        setupClientNameInputFilter();
      });
      
      // è¨­ç½®å€‹æ¡ˆåç¨±çš„éæ¿¾åŠŸèƒ½
      function setupClientNameInputFilter() {
        const clientNameInput = document.getElementById('clientName');
        const clientList = document.getElementById('clientList');
        const originalOptions = Array.from(clientList.options).map(opt => opt.value);
        
        clientNameInput.addEventListener('input', function() {
          const searchValue = this.value.toLowerCase();
          const errorElement = document.getElementById('clientNameError');
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…çš„åå­—
          const exactMatch = originalOptions.some(option => option === this.value);
          if (this.value && !exactMatch) {
            errorElement.style.display = 'block';
          } else {
            errorElement.style.display = 'none';
          }
        });
      }
      
      function submitCancel() {
        var clientName = document.getElementById('clientName').value;
        var appointmentDate = document.getElementById('appointmentDate').value;
        var counselor = document.getElementById('counselor').value;
        var cancelReason = document.getElementById('cancelReason').value;
        
        if (!clientName || !appointmentDate || !counselor) {
          showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'error');
          return;
        }
        
        // åš´æ ¼é©—è­‰å®¢æˆ¶åç¨±æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
        const clientList = document.getElementById('clientList');
        const clients = Array.from(clientList.options).map(opt => opt.value);
        if (!clients.includes(clientName)) {
          showMessage('æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º', 'error');
          return;
        }
        
        document.getElementById('message').style.display = 'none';
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        showLoading();
        
        google.script.run
          .withSuccessHandler(function(result) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            if (result.success) {
              if (result.notificationMessage) {
                // é¡¯ç¤ºå–æ¶ˆé ç´„è¨Šæ¯æ¡†
                document.getElementById('message').style.display = "none";
                document.getElementById('cancel-container').innerHTML = result.notificationMessage;
              } else {
                showMessage('é ç´„å·²æˆåŠŸå–æ¶ˆ', 'success');
                setTimeout(function() {
                  google.script.host.close();
                }, 2000);
              }
            } else {
              showMessage(result.message || 'å–æ¶ˆé ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .processCancelRequest(clientName, appointmentDate, counselor, cancelReason);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>`;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(500);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'å–æ¶ˆé ç´„');
}



/**
 * è™•ç†å–æ¶ˆè«‹æ±‚çš„å‡½æ•¸
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} appointmentDate - é ç´„æ—¥æœŸå­—ä¸²
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} cancelReason - å–æ¶ˆåŸå› 
 * @return {Object} è™•ç†çµæœ
 */
function processCancelRequest(clientName, appointmentDate, counselor, cancelReason) {
  try {
    var date = new Date(appointmentDate);
    
    // åœ¨å–æ¶ˆé ç´„å‰å…ˆå–å¾—é ç´„è³‡è¨Š
    const appointmentInfo = findAppointmentInfo(clientName, date, counselor);
    if (!appointmentInfo) {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "å–æ¶ˆé ç´„",
        clientName,
        `å–æ¶ˆé ç´„å¤±æ•—: æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é ç´„è¨˜éŒ„`,
        "å¤±æ•—",
        counselor,
        `å˜—è©¦å–æ¶ˆæ—¥æœŸ: ${appointmentDate}`
      );
      return { 
        success: false, 
        message: "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é ç´„è¨˜éŒ„" 
      };
    }
    
    // åŸ·è¡Œå–æ¶ˆé ç´„æ“ä½œ
    const cancelResult = cancelAppointment(clientName, date, counselor);
    
    if (cancelResult) {
      // ç”Ÿæˆå–æ¶ˆé ç´„é€šçŸ¥
      const notificationMessage = generateNotificationMessage('cancel', {
        clientName: clientName,
        appointmentDate: date,
        appointmentTime: appointmentInfo.time,
        counselor: counselor,
        serviceType: appointmentInfo.serviceType,
        room: appointmentInfo.room,
        cancelReason: cancelReason
      });
      
      // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
      logSystemActivity(
        "å–æ¶ˆé ç´„",
        clientName,
        `å–æ¶ˆæ—¥æœŸ: ${appointmentDate}, å¿ƒç†å¸«: ${counselor}`,
        "æˆåŠŸ",
        counselor,
        `å–æ¶ˆåŸå› : ${cancelReason}`
      );

      // ã€æ–°å¢ã€‘å–æ¶ˆæˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
      createHelperTodoItem(
        OPERATION_TYPES.CANCELLATION,
        clientName,
        {
          date: appointmentDate,
          time: appointmentInfo.time,
          therapist: counselor,
          room: appointmentInfo.room,
          serviceType: appointmentInfo.serviceType,
          additionalInfo: `å–æ¶ˆåŸå› ï¼š${cancelReason}`
        }
      );

      return { 
        success: true,
        notificationMessage: notificationMessage
      };
    } else {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "å–æ¶ˆé ç´„",
        clientName,
        `å–æ¶ˆé ç´„å¤±æ•—: åŸ·è¡Œå–æ¶ˆæ“ä½œå¤±æ•—`,
        "å¤±æ•—",
        counselor,
        `å–æ¶ˆåŸå› : ${cancelReason}`
      );
      return { 
        success: false, 
        message: "å–æ¶ˆé ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦" 
      };
    }
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å–æ¶ˆé ç´„",
      clientName,
      `å–æ¶ˆé ç´„å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—",
      counselor
    );
    
    Logger.log("è™•ç†å–æ¶ˆè«‹æ±‚æ™‚å‡ºéŒ¯: " + error.toString());
    return { 
      success: false, 
      message: "è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + error.toString() 
    };
  }
}

/**
 * é¡¯ç¤ºèª¿æ•´é ç´„æ™‚é–“çš„ä½¿ç”¨è€…ä»‹é¢ (å·²ä¿®æ­£è¡çªè™•ç†é‚è¼¯)
 */
function showRescheduleDialog() {
  const counselors = getCounselorList();
  const counselorOptions = counselors.map(counselor => `<option value="${counselor}">${counselor}</option>`).join('');
  
  const clients = getClientList();
  const clientOptions = clients.map(client => `<option value="${client}">${client}</option>`).join('');
  
  // æ³¨æ„ï¼šé€™è£¡å…ˆä¸è¼‰å…¥ roomsï¼Œå› ç‚ºç•¶è¡çªç™¼ç”Ÿæ™‚ï¼Œæœƒç”±å¾Œç«¯æä¾›å¯ç”¨çš„åˆ—è¡¨
  
  var html = `
    <div id="reschedule-container" style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #f4b400;">èª¿æ•´é ç´„æ™‚é–“</h2>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>
        <div style="position: relative; width: 100%;">
          <input type="text" id="clientName" list="clientList" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡å€‹æ¡ˆå§“å" autocomplete="off">
          <datalist id="clientList">${clientOptions}</datalist>
          <div id="clientNameError" style="color: #c62828; font-size: 12px; margin-top: 3px; display: none;">æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º</div>
        </div>
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">åŸé ç´„æ—¥æœŸï¼š</label><br>
        <input type="date" id="originalDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">è«®å•†å¸«ï¼š</label><br>
        <select id="counselor" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡è«®å•†å¸«</option>
          ${counselorOptions}
        </select>
      </div>
      <hr>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">æ–°é ç´„æ—¥æœŸï¼š</label><br>
        <input type="date" id="newDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin: 10px 0;">
        <label style="font-weight: bold;">æ–°é ç´„æ™‚é–“ï¼š</label><br>
        <select id="newHour" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          ${generateHourOptions()}
        </select>
        <select id="newMinute" style="width: 45%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="00">00</option>
          <option value="30">30</option>
        </select>
      </div>
      
      <div id="roomSelectionDiv" style="margin: 15px 0; display: none;">
        <label style="font-weight: bold;">é¸æ“‡æ–°çš„è«®å•†å®¤ï¼š</label><br>
        <select id="newRoom" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡å¯ç”¨è«®å•†å®¤</option>
        </select>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitReschedule()" id="submitButton" style="background-color: #f4b400; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªèª¿æ•´</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      let rescheduleData = {}; // ç”¨æ–¼å„²å­˜éœ€è¦é‡æ–°æäº¤çš„è³‡æ–™

      document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        document.getElementById("originalDate").value = year + "-" + month + "-" + day;
        document.getElementById("newDate").value = year + "-" + month + "-" + day;
      });

      function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        messageDiv.style.backgroundColor = type === 'error' ? '#ffebee' : (type === 'warning' ? '#fff3e0' : '#e8f5e9');
        messageDiv.style.color = type === 'error' ? '#c62828' : (type === 'warning' ? '#ef6c00' : '#2e7d32');
      }

      function submitReschedule() {
        const clientName = document.getElementById('clientName').value;
        const originalDate = document.getElementById('originalDate').value;
        const counselor = document.getElementById('counselor').value;
        const newDate = document.getElementById('newDate').value;
        const newTime = document.getElementById('newHour').value + ':' + document.getElementById('newMinute').value;
        const newRoom = document.getElementById('newRoom').value; // ç²å–æ–°é¸æ“‡çš„è«®å•†å®¤

        if (!clientName || !originalDate || !counselor || !newDate) {
          showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½', 'error');
          return;
        }

        document.getElementById('message').style.display = 'none';
        showLoading();

        // ã€ä¿®æ”¹è™•ã€‘æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„æ”¹æœŸè³‡æ–™ã€‚å¦‚æœæ²’æœ‰ï¼Œèµ°æ­£å¸¸æµç¨‹ï¼›å¦‚æœæœ‰ï¼Œè¡¨ç¤ºæ˜¯ç¬¬äºŒæ¬¡æäº¤ã€‚
        if (Object.keys(rescheduleData).length > 0 && newRoom) {
            // ç¬¬äºŒæ¬¡æäº¤ï¼Œä½¿ç”¨è€…å·²é¸æ“‡æ–°æˆ¿é–“
            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleFailure)
                .processRescheduleWithNewRoom(rescheduleData, newRoom);
        } else {
            // ç¬¬ä¸€æ¬¡æäº¤
            google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleFailure)
                .processRescheduleRequest(clientName, originalDate, counselor, newDate, newTime);
        }
      }

      function handleSuccess(result) {
        hideLoading();
        if (result.success) {
          document.getElementById('reschedule-container').innerHTML = result.notificationMessage;
        } else if (result.needRoomChange) {
          // ã€ä¿®æ”¹è™•ã€‘è™•ç†éœ€è¦æ›´æ›æˆ¿é–“çš„é‚è¼¯
          showMessage(result.message, 'warning');
          rescheduleData = result.originalInfo; // æš«å­˜ä½¿ç”¨è€…è¼¸å…¥çš„è³‡æ–™
          
          const roomSelectionDiv = document.getElementById('roomSelectionDiv');
          const newRoomSelect = document.getElementById('newRoom');
          
          // å¡«å……å¯ç”¨çš„æˆ¿é–“åˆ—è¡¨
          newRoomSelect.innerHTML = '<option value="">è«‹é¸æ“‡å¯ç”¨è«®å•†å®¤</option>' + 
                                    result.availableRooms.map(r => \`<option value="\${r}">\${r}</option>\`).join('');
          roomSelectionDiv.style.display = 'block'; // é¡¯ç¤ºæˆ¿é–“é¸æ“‡å™¨
          
        } else {
          showMessage(result.message || 'èª¿æ•´å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
      }

      function handleFailure(error) {
        hideLoading();
        showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
      }
    </script>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(450)
    .setHeight(620);
  SpreadsheetApp.getUi().showModalDialog(ui, 'èª¿æ•´é ç´„æ™‚é–“');
}

/**
 * è™•ç†èª¿æ•´æ™‚é–“è«‹æ±‚çš„å‡½æ•¸ (æ•´åˆä¿®æ­£ç‰ˆ V2)
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} originalDateStr - åŸé ç´„æ—¥æœŸå­—ä¸²
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {string} newDateStr - æ–°é ç´„æ—¥æœŸå­—ä¸²
 * @param {string} newTime - æ–°é ç´„æ™‚é–“
 * @return {Object} è™•ç†çµæœ
 */
function processRescheduleRequest(clientName, originalDateStr, counselor, newDateStr, newTime) {
  try {
    const origDate = new Date(originalDateStr);
    const newDateObj = new Date(newDateStr);

    // 1. ç²å–åŸé ç´„è³‡è¨Š
    const originalInfo = findAppointmentInfo(clientName, origDate, counselor);
    if (!originalInfo) {
      const message = "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åŸé ç´„è¨˜éŒ„ï¼Œè«‹ç¢ºèªå€‹æ¡ˆå§“åã€åŸé ç´„æ—¥æœŸå’Œå¿ƒç†å¸«æ˜¯å¦æ­£ç¢ºã€‚";
      logSystemActivity("èª¿æ•´é ç´„æ™‚é–“", clientName, message, "å¤±æ•—", counselor);
      return { success: false, message: message };
    }
    const roomToUse = originalInfo.room;
    const serviceType = originalInfo.serviceType;

    // 2. æª¢æŸ¥æ–°æ™‚æ®µçš„åŸè«®å•†å®¤æ˜¯å¦å¯ç”¨
    const roomAvailable = checkRoomAvailabilityExcludingCurrent(newDateObj, newTime, roomToUse, clientName, counselor);
    
    // ã€ä¿®æ”¹è™•ã€‘å¦‚æœæˆ¿é–“ä¸å¯ç”¨ï¼Œå‰‡æª¢æŸ¥å…¶ä»–æˆ¿é–“
    if (!roomAvailable) {
      const allRooms = getRoomList();
      const availableRooms = allRooms.filter(room => room !== roomToUse && checkRoomAvailabilityExcludingCurrent(newDateObj, newTime, room, clientName, counselor));

      if (availableRooms.length === 0) {
        const message = `æ–°æ™‚æ®µ ${newDateStr} ${newTime} çš„æ‰€æœ‰è«®å•†å®¤éƒ½å·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ã€‚`;
        logSystemActivity("èª¿æ•´é ç´„æ™‚é–“", clientName, message, "å¤±æ•—", counselor, `åŸé ç´„: ${originalDateStr}`);
        return { success: false, message: message };
      }

      // å›å‚³ç‰¹æ®Šç‰©ä»¶ï¼Œå‘ŠçŸ¥å‰ç«¯éœ€è¦ä½¿ç”¨è€…é¸æ“‡æ–°æˆ¿é–“
      return {
        success: false,
        needRoomChange: true,
        message: `åŸè«®å•†å®¤ ${roomToUse} åœ¨æ–°æ™‚æ®µå·²è¢«é ç´„ï¼Œä½†æœ‰å…¶ä»–å¯ç”¨ç©ºé–“ã€‚è«‹é¸æ“‡ä¸€å€‹æ–°çš„è«®å•†å®¤ï¼š`,
        availableRooms: availableRooms,
        originalInfo: { clientName, originalDateStr, counselor, newDateStr, newTime, serviceType }
      };
    }
    
    // å¦‚æœåŸæˆ¿é–“å¯ç”¨ï¼Œç›´æ¥å®Œæˆæ”¹æœŸ
    const result = processRescheduleWithNewRoom({ clientName, originalDateStr, counselor, newDateStr, newTime, serviceType }, roomToUse);
    return result;

  } catch (error) {
    Logger.log("è™•ç†èª¿æ•´æ™‚é–“è«‹æ±‚æ™‚å‡ºéŒ¯: " + error.toString());
    logSystemActivity("èª¿æ•´é ç´„æ™‚é–“", clientName, `è™•ç†è«‹æ±‚æ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤: ${error.toString()}`, "å¤±æ•—", counselor);
    return { success: false, message: "è™•ç†éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + error.toString() };
  }
}

/**
 * ä½¿ç”¨æŒ‡å®šçš„è«®å•†å®¤ä¾†å®Œæˆé ç´„èª¿æ•´
 * @param {Object} originalInfo - åŒ…å«æ‰€æœ‰é ç´„è³‡è¨Šçš„ç‰©ä»¶
 * @param {string} newRoom - æœ€çµ‚é¸å®šçš„æ–°è«®å•†å®¤
 * @return {Object} è™•ç†çµæœ
 */
function processRescheduleWithNewRoom(originalInfo, newRoom) {
  const { clientName, originalDateStr, counselor, newDateStr, newTime, serviceType } = originalInfo;
  const origDate = new Date(originalDateStr);
  const newDateObj = new Date(newDateStr);

  try {
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);

    // æ¨™è¨˜åŸå§‹æ—¥æ›†äº‹ä»¶ç‚ºã€æ”¹æœŸã€‘
    const originalEvents = calendar.getEventsForDay(origDate);
    for (let event of originalEvents) {
      const title = event.getTitle();
      if (title.includes(clientName) && title.includes(counselor) && !title.includes("ã€")) {
        event.setTitle(`ã€æ”¹æœŸã€‘${title}`);
        event.setColor(CalendarApp.EventColor.GRAY);
        Logger.log(`å·²å°‡åŸå§‹æ—¥æ›†äº‹ä»¶æ¨™è¨˜ç‚ºæ”¹æœŸ: ${title}`);
        break;
      }
    }

    // å‰µå»ºæ–°çš„æ—¥æ›†äº‹ä»¶
    const newEvent = createCalendarEvent(clientName, serviceType, newDateObj, newTime, counselor, newRoom);
    if (newEvent) {
      newEvent.setColor(CalendarApp.EventColor.BLUE);
    }

    // æ›´æ–°è©¦ç®—è¡¨ä¸­çš„è³‡æ–™
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    let updated = false;
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === clientName && isSameDay(new Date(data[i][2]), origDate) && data[i][3] === counselor) {
        sheet.getRange(i + 1, 3).setValue(newDateObj); // æ›´æ–°æ—¥æœŸ
        sheet.getRange(i + 1, 6).setValue(newTime);   // æ›´æ–°æ™‚é–“
        sheet.getRange(i + 1, 7).setValue(newRoom);   // æ›´æ–°è«®å•†å®¤
        updated = true;
        Logger.log(`å·²åœ¨è©¦ç®—è¡¨ä¸­æ›´æ–°é ç´„è³‡æ–™ï¼Œç¬¬ ${i + 1} è¡Œ`);
        break;
      }
    }
    if (!updated) {
      sheet.appendRow([new Date(), clientName, newDateObj, counselor, serviceType, newTime, newRoom, ""]);
      Logger.log("åœ¨ç™»éŒ„è³‡æ–™ä¸­æœªæ‰¾åˆ°å°æ‡‰èˆŠç´€éŒ„ï¼Œå·²ç‚ºæ–°é ç´„æ–°å¢ä¸€ç­†è³‡æ–™ã€‚");
    }
    
    updateStatistics();
    sendRescheduleNotification(clientName, origDate, newDateObj, newTime, counselor, serviceType, newRoom);
    
    const notificationMessage = generateNotificationMessage('reschedule', {
      clientName: clientName,
      originalDate: origDate,
      newDate: newDateObj,
      newTime: newTime,
      counselor: counselor,
      serviceType: serviceType,
      room: newRoom
    });

    logSystemActivity("èª¿æ•´é ç´„æ™‚é–“", clientName, `åŸæ—¥æœŸ: ${originalDateStr} -> æ–°æ—¥æœŸ: ${newDateStr} ${newTime}`, "æˆåŠŸ", counselor, `è«®å•†å®¤æ›´æ›ç‚º: ${newRoom}`);
    
    return { success: true, notificationMessage: notificationMessage };
  } catch (error) {
     Logger.log("åŸ·è¡Œæœ€çµ‚æ”¹æœŸæ™‚å‡ºéŒ¯: " + error.toString());
     logSystemActivity("èª¿æ•´é ç´„æ™‚é–“", clientName, `åŸ·è¡Œæœ€çµ‚æ”¹æœŸæ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤: ${error.toString()}`, "å¤±æ•—", counselor);
     return { success: false, message: "åŸ·è¡Œæœ€çµ‚æ”¹æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤: " + error.toString() };
  }
}

/**
 * ç²å–æ‰€æœ‰å®¢æˆ¶åå–®
 * @return {Array<string>} å®¢æˆ¶åå–®
 */
function getClientList() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dataSheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    if (!dataSheet) return [];
    
    const data = dataSheet.getDataRange().getValues();
    
    // å‡è¨­å®¢æˆ¶åç¨±åœ¨ç¬¬2åˆ—ï¼ˆç´¢å¼•1ï¼‰
    const clientSet = new Set();
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] && typeof data[i][1] === 'string') {
        clientSet.add(data[i][1]);
      }
    }
    
    return Array.from(clientSet).sort();
  } catch (error) {
    Logger.log("ç²å–å®¢æˆ¶åå–®æ™‚å‡ºéŒ¯: " + error.toString());
    return [];
  }
}

/**
 * é¡¯ç¤ºèª¿æ•´è«®å•†ç©ºé–“å°è©±æ¡†
 */
function showChangeRoomDialog() {
  // ç²å–å¿ƒç†å¸«åˆ—è¡¨
  const counselors = getCounselorList();
  const counselorOptions = counselors.map(counselor => 
    `<option value="${counselor}">${counselor}</option>`).join('');
  
  // ç²å–è«®å•†å®¤åˆ—è¡¨
  const rooms = getRoomList();
  const roomOptions = rooms.map(room => 
    `<option value="${room}">${room}</option>`).join('');
  
  // ç²å–å®¢æˆ¶åå–®ä¾›ä¸‹æ‹‰é¸æ“‡
  const clients = getClientList();
  const clientOptions = clients.map(client => 
    `<option value="${client}">${client}</option>`).join('');
  
  var html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">èª¿æ•´è«®å•†ç©ºé–“</h2>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆå§“åï¼š</label><br>
        <div style="position: relative; width: 100%;">
          <input type="text" id="clientName" list="clientList" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è«‹è¼¸å…¥æˆ–é¸æ“‡å€‹æ¡ˆå§“å" autocomplete="off">
          <datalist id="clientList">
            ${clientOptions}
          </datalist>
          <div id="clientNameError" style="color: #c62828; font-size: 12px; margin-top: 3px; display: none;">æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º</div>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">é ç´„æ—¥æœŸï¼š</label><br>
        <input type="date" id="appointmentDate" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">è«®å•†å¸«ï¼š</label><br>
        <select id="counselor" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡è«®å•†å¸«</option>
          ${counselorOptions}
        </select>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">æ–°è«®å•†å®¤ï¼š</label><br>
        <select id="newRoom" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡æ–°è«®å•†å®¤</option>
          ${roomOptions}
        </select>
      </div>
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitChangeRoom()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªèª¿æ•´</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      // åˆå§‹åŒ–é é¢æ™‚è¨­å®šä»Šå¤©æ—¥æœŸ
      document.addEventListener("DOMContentLoaded", function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        document.getElementById("appointmentDate").value = year + "-" + month + "-" + day;
        
        // è¨­ç½®åå­—è¼¸å…¥æ¡†çš„äº‹ä»¶ç›£è½
        setupClientNameInputFilter();
      });
      
      // è¨­ç½®å€‹æ¡ˆåç¨±çš„éæ¿¾åŠŸèƒ½
      function setupClientNameInputFilter() {
        const clientNameInput = document.getElementById('clientName');
        const clientList = document.getElementById('clientList');
        const originalOptions = Array.from(clientList.options).map(opt => opt.value);
        
        clientNameInput.addEventListener('input', function() {
          const searchValue = this.value.toLowerCase();
          const errorElement = document.getElementById('clientNameError');
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…çš„åå­—
          const exactMatch = originalOptions.some(option => option === this.value);
          if (this.value && !exactMatch) {
            errorElement.style.display = 'block';
          } else {
            errorElement.style.display = 'none';
          }
        });
      }
      
      function submitChangeRoom() {
        var clientName = document.getElementById('clientName').value;
        var appointmentDate = document.getElementById('appointmentDate').value;
        var counselor = document.getElementById('counselor').value;
        var newRoom = document.getElementById('newRoom').value;
        
        if (!clientName || !appointmentDate || !counselor || !newRoom) {
          showMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
          return;
        }
        
        // åš´æ ¼é©—è­‰å®¢æˆ¶åç¨±æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
        const clientList = document.getElementById('clientList');
        const clients = Array.from(clientList.options).map(opt => opt.value);
        if (!clients.includes(clientName)) {
          showMessage('æŸ¥ç„¡æ­¤å€‹æ¡ˆï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢º', 'error');
          return;
        }
        
        document.getElementById('message').style.display = 'none';
        
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        showLoading();
        
        google.script.run
          .withSuccessHandler(function(result) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            if (result.success) {
              showMessage('è«®å•†å®¤å·²æˆåŠŸèª¿æ•´ï¼', 'success');
              setTimeout(function() {
                google.script.host.close();
              }, 2000);
            } else {
              showMessage(result.message || 'èª¿æ•´è«®å•†å®¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .processChangeRoomRequest(clientName, appointmentDate, counselor, newRoom);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>`;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(500);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'èª¿æ•´è«®å•†ç©ºé–“');
}


/**
 * ä½¿ç”¨æ–°è«®å•†å®¤è™•ç†çºŒç´„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} renewalDate - çºŒç´„æ—¥æœŸ
 * @param {string} renewalTime - çºŒç´„æ™‚é–“
 * @param {string} counselor - å¿ƒç†å¸«
 * @param {string} serviceType - æœå‹™é¡å‹
 * @param {string} newRoom - æ–°è«®å•†å®¤
 * @return {Object} è™•ç†çµæœ
 */
function processRenewalWithNewRoom(clientName, renewalDate, renewalTime, counselor, serviceType, newRoom) {
  try {
    const newDateObj = new Date(renewalDate);
    
    // çºŒç´„æ˜¯å…¨æ–°çš„é ç´„ï¼Œç›´æ¥ä½¿ç”¨ checkRoomAvailability
    if (!checkRoomAvailability(newDateObj, renewalTime, newRoom)) {
      return { success: false, message: 'é¸æ“‡çš„è«®å•†å®¤å·²è¢«é ç´„ï¼Œè«‹é‡æ–°é¸æ“‡' };
    }
    
    // æ·»åŠ æ–°é ç´„è¨˜éŒ„
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const now = new Date();
    
    sheet.appendRow([
      now,                    // æ™‚é–“æˆ³è¨˜
      clientName,             // å€‹æ¡ˆå§“å
      newDateObj,             // è«®å•†æ—¥æœŸ
      counselor,              // è«®å•†å¸«
      serviceType,            // æœå‹™æ–¹æ¡ˆ
      renewalTime,            // æ™‚é–“
      newRoom,                // è«®å•†å®¤
      "å·²ç¹³ç´"                // ä¿è­‰é‡‘ç‹€æ…‹ï¼ˆçºŒç´„é€šå¸¸å·²ç¹³ç´ï¼‰
    ]);
    
    // æ’åºè³‡æ–™
    sortDataByTimestamp(sheet);
    
    // å‰µå»ºæ—¥æ›†äº‹ä»¶
    createCalendarEvent(clientName, serviceType, newDateObj, renewalTime, counselor, newRoom);
    
    // æ›´æ–°çµ±è¨ˆå ±è¡¨
    updateStatistics();
    
    // é€šçŸ¥å¿ƒç†å¸«
    notifyCounselor(clientName, serviceType, newDateObj, renewalTime, counselor, newRoom);
    
    // ç”ŸæˆçºŒç´„è¨Šæ¯
    const notificationMessage = generateNotificationMessage('renewal', {
      clientName: clientName,
      renewalDate: newDateObj,
      renewalTime: renewalTime,
      counselor: counselor,
      serviceType: serviceType,
      room: newRoom
    });
    
    // ã€æ–°å¢ã€‘çºŒç´„æˆåŠŸå¾Œï¼Œæ–°å¢å°å¹«æ‰‹å¾…è¾¦
    createHelperTodoItem(
      OPERATION_TYPES.RENEWAL,
      clientName,
      {
        clientName: clientName,
        date: renewalDate,
        time: renewalTime,
        therapist: counselor,
        room: newRoom,
        serviceType: serviceType,
        additionalInfo: "çºŒç´„ï¼ˆæ›´æ›è«®å•†å®¤ï¼‰"
      }
    );
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒ
    logSystemActivity(
      "å€‹æ¡ˆçºŒç´„",
      clientName,
      `çºŒç´„æ—¥æœŸ: ${renewalDate}, æ™‚é–“: ${renewalTime}, è«®å•†å®¤: ${newRoom}`,
      "æˆåŠŸ",
      counselor,
      "çºŒç´„å®Œæˆï¼ˆæ›´æ›è«®å•†å®¤ï¼‰"
    );
    
    return { 
      success: true,
      notificationMessage: notificationMessage 
    };
  } catch (error) {
    Logger.log("ä½¿ç”¨æ–°è«®å•†å®¤è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    return { success: false, message: 'è™•ç†çºŒç´„æ™‚å‡ºç¾éŒ¯èª¤' };
  }
}


/**
 * æª¢æŸ¥è«®å•†å®¤åœ¨æ”¹æœŸæ™‚æ˜¯å¦å¯ç”¨ï¼ˆå°ˆé–€ç”¨æ–¼æ”¹æœŸå ´æ™¯ï¼‰
 * @param {Date} newDate - æ–°é ç´„æ—¥æœŸ
 * @param {string} newTime - æ–°é ç´„æ™‚é–“ (HH:MMæ ¼å¼)
 * @param {string} room - è«®å•†å®¤åç¨±
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} counselor - å¿ƒç†å¸«å§“å
 * @param {Date} originalDate - åŸé ç´„æ—¥æœŸï¼ˆç”¨æ–¼æ’é™¤ï¼‰
 * @return {boolean} è«®å•†å®¤æ˜¯å¦å¯ç”¨
 */
function checkRoomAvailabilityForReschedule(newDate, newTime, room, clientName, counselor, originalDate) {
  try {
    // å¾ç³»çµ±è¨­å®šç²å–æ—¥æ›†ID
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    // åˆ†å‰²æ™‚é–“å­—ä¸²å–å¾—å°æ™‚å’Œåˆ†é˜
    const [hours, minutes] = newTime.split(':').map(Number);
    
    // è¨­å®šæ–°é ç´„çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
    const startTime = new Date(newDate);
    startTime.setHours(hours);
    startTime.setMinutes(minutes);
    startTime.setSeconds(0);
    
    const endTime = new Date(startTime);
    endTime.setMinutes(startTime.getMinutes() + config.counselingDuration); // è«®å•†æ™‚é•·
    
    // æª¢æŸ¥æ–°æ—¥æœŸç•¶å¤©çš„æ‰€æœ‰äº‹ä»¶
    const dayStart = new Date(newDate);
    dayStart.setHours(0, 0, 0, 0);
    
    const dayEnd = new Date(newDate);
    dayEnd.setHours(23, 59, 59, 999);
    
    // ç²å–æ–°æ—¥æœŸç•¶å¤©æ‰€æœ‰äº‹ä»¶
    const events = calendar.getEvents(dayStart, dayEnd);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èˆ‡æ–°æ™‚æ®µé‡ç–Šçš„åŒä¸€è«®å•†å®¤çš„é ç´„
    for (let event of events) {
      const title = event.getTitle();
      const desc = event.getDescription();
      
      // è·³éå·²å–æ¶ˆå’Œå·²æ”¹æœŸçš„äº‹ä»¶
      if (title.includes("ã€å–æ¶ˆã€‘") || title.includes("ã€æ”¹æœŸã€‘")) {
        continue;
      }
      
      // è·³éåŸé ç´„ï¼ˆå¦‚æœæ˜¯åŒä¸€å€‹å€‹æ¡ˆå’Œå¿ƒç†å¸«ï¼‰
      if (title.includes(clientName) && title.includes(counselor)) {
        const eventDate = event.getStartTime();
        // å¦‚æœæ˜¯åŸé ç´„æ—¥æœŸçš„äº‹ä»¶ï¼Œè·³éæª¢æŸ¥
        if (isSameDay(eventDate, originalDate)) {
          continue;
        }
      }
      
      // æª¢æŸ¥è«®å•†å®¤æ˜¯å¦ç›¸åŒ
      if (title.includes(`- ${room}`) || desc.includes(`è«®å•†å®¤: ${room}`)) {
        // æª¢æŸ¥æ™‚é–“æ˜¯å¦é‡ç–Š
        const eventStart = event.getStartTime();
        const eventEnd = event.getEndTime();
        
        // æª¢æŸ¥é‡ç–Šçš„æƒ…æ³
        if ((startTime >= eventStart && startTime < eventEnd) || 
            (endTime > eventStart && endTime <= eventEnd) ||
            (startTime <= eventStart && endTime >= eventEnd)) {
          Logger.log(`æ™‚é–“è¡çªï¼š${title} åœ¨ ${eventStart} - ${eventEnd}`);
          return false; // æ™‚æ®µé‡ç–Šï¼Œè«®å•†å®¤ä¸å¯ç”¨
        }
      }
    }
    
    return true; // è«®å•†å®¤å¯ç”¨
  } catch (error) {
    Logger.log("æª¢æŸ¥æ”¹æœŸè«®å•†å®¤å¯ç”¨æ€§æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    // å‡ºéŒ¯æ™‚è¿”å›falseä¿å®ˆè™•ç†
    return false;
  }
}





/**
 * å»ºç«‹å€‹æ¡ˆæœå‹™è¨˜éŒ„è¡¨æ ¼
 * @return {Sheet} å€‹æ¡ˆæœå‹™è¨˜éŒ„è¡¨æ ¼
 */
function createClientServiceRecordSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
  
  if (!sheet) {
    sheet = ss.insertSheet("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
    sheet.appendRow(["å€‹æ¡ˆåå­—", "æœå‹™æ–¹æ¡ˆ", "å·²æœå‹™æ¬¡æ•¸", "æœ€å¾Œæ›´æ–°æ—¥æœŸ"]);
    sheet.getRange("A1:D1").setFontWeight("bold");
  }
  
  return sheet;
}


/**
 * é¡¯ç¤ºè¨­å®šå€‹æ¡ˆæœå‹™è¨˜éŒ„çš„å°è©±æ¡†
 */
function showAddClientServiceRecord() {
  // ç²å–æœå‹™æ–¹æ¡ˆåˆ—è¡¨
  const serviceTypes = getServiceTypeList();
  const serviceTypeOptions = serviceTypes.map(type => 
    `<option value="${type}">${type}</option>`).join('');
  
  var html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">è¨­å®šå€‹æ¡ˆæœå‹™è¨˜éŒ„</h2>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å€‹æ¡ˆåå­—ï¼š</label><br>
        <input type="text" id="clientName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹å¦‚ï¼šé˜¿ç™½">
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">æœå‹™æ–¹æ¡ˆï¼š</label><br>
        <select id="serviceType" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">è«‹é¸æ“‡æœå‹™æ–¹æ¡ˆ</option>
          ${serviceTypeOptions}
        </select>
      </div>
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">å·²æœå‹™æ¬¡æ•¸ï¼š</label><br>
        <input type="number" id="serviceCount" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;" min="1" value="1">
      </div>
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitRecord()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªè¨­å®š</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
    </div>
    <script>
      function submitRecord() {
        var clientName = document.getElementById('clientName').value;
        var serviceType = document.getElementById('serviceType').value;
        var serviceCount = document.getElementById('serviceCount').value;
        
        if (!clientName || !serviceType || !serviceCount) {
          showMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
          return;
        }
        
        if (!/^\\d+$/.test(serviceCount)) {
          showMessage('æœå‹™æ¬¡æ•¸å¿…é ˆæ˜¯æ­£æ•´æ•¸', 'error');
          return;
        }
        
        document.getElementById('message').style.display = 'none';
        
        google.script.run
          .withSuccessHandler(function(result) {
            showMessage('å€‹æ¡ˆæœå‹™è¨˜éŒ„å·²è¨­å®šæˆåŠŸ', 'success');
            setTimeout(function() {
              google.script.host.close();
            }, 2000);
          })
          .withFailureHandler(function(error) {
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .addClientServiceRecord(clientName, serviceType, serviceCount);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>`;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(450);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'è¨­å®šå€‹æ¡ˆæœå‹™è¨˜éŒ„');
}

/**
 * æ·»åŠ å€‹æ¡ˆæœå‹™è¨˜éŒ„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {string|number} serviceCount - æœå‹™æ¬¡æ•¸
 * @return {boolean} æ˜¯å¦æˆåŠŸæ·»åŠ 
 */
function addClientServiceRecord(clientName, serviceType, serviceCount) {
  try {
    const sheet = createClientServiceRecordSheet();
    const data = sheet.getDataRange().getValues();
    
    // ç¢ºä¿æœå‹™æ¬¡æ•¸æ˜¯æ•¸å­—
    const count = parseInt(serviceCount);
    if (isNaN(count) || count < 1) {
      throw new Error("æœå‹™æ¬¡æ•¸å¿…é ˆæ˜¯æ­£æ•´æ•¸");
    }
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤å€‹æ¡ˆçš„æ­¤æœå‹™æ–¹æ¡ˆè¨˜éŒ„
    let found = false;
    for (let i = 1; i < data.length; i++) {
      // ä½¿ç”¨åŒ…å«é—œä¿‚æª¢æŸ¥ï¼Œè€Œéå®Œå…¨åŒ¹é…
      if (data[i][0].includes(clientName) || clientName.includes(data[i][0])) {
        if (data[i][1] === serviceType) {
          // æ›´æ–°ç¾æœ‰è¨˜éŒ„
          sheet.getRange(i + 1, 3).setValue(count);
          sheet.getRange(i + 1, 4).setValue(new Date());
          found = true;
          break;
        }
      }
    }
    
    if (!found) {
      // æ–°å¢è¨˜éŒ„
      sheet.appendRow([clientName, serviceType, count, new Date()]);
    }
    
    return true;
  } catch (error) {
    Logger.log("è¨­å®šå€‹æ¡ˆæœå‹™è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.toString());
    throw error;
  }
}

/**
 * æ›´æ–°å€‹æ¡ˆæœå‹™è¨˜éŒ„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆ
 * @param {number} newCount - æ–°æœå‹™æ¬¡æ•¸
 * @return {boolean} æ˜¯å¦æˆåŠŸæ›´æ–°
 */
function updateClientServiceRecord(clientName, serviceType, newCount) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
    
    if (!sheet) {
      // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸¦æ·»åŠ è¨˜éŒ„
      const newSheet = createClientServiceRecordSheet();
      newSheet.appendRow([clientName, serviceType, newCount, new Date()]);
      return true;
    }
    
    const data = sheet.getDataRange().getValues();
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤å€‹æ¡ˆçš„æ­¤æœå‹™æ–¹æ¡ˆè¨˜éŒ„
    let found = false;
    for (let i = 1; i < data.length; i++) {
      // ä½¿ç”¨åŒ…å«é—œä¿‚æª¢æŸ¥ï¼Œè€Œéå®Œå…¨åŒ¹é…
      if ((data[i][0].includes(clientName) || clientName.includes(data[i][0])) && 
          data[i][1] === serviceType) {
        // æ›´æ–°ç¾æœ‰è¨˜éŒ„
        sheet.getRange(i + 1, 3).setValue(newCount);
        sheet.getRange(i + 1, 4).setValue(new Date());
        found = true;
        break;
      }
    }
    
    if (!found) {
      // æ–°å¢è¨˜éŒ„
      sheet.appendRow([clientName, serviceType, newCount, new Date()]);
    }
    
    return true;
  } catch (error) {
    Logger.log("æ›´æ–°å€‹æ¡ˆæœå‹™è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.toString());
    return false;
  }
}


/**
 * ã€å…¨æ–°é€šç”¨å‡½å¼ã€‘å¾ç³»çµ±è¨­å®šå·¥ä½œè¡¨ä¸­ï¼Œæ ¹æ“šå€å¡Šæ¨™é¡Œç²å–å…¶ä¸‹æ–¹çš„é¸é …åˆ—è¡¨
 * @param {string} sectionName - è¦è®€å–çš„å€å¡Šæ¨™é¡Œ (ä¾‹å¦‚ "æœå‹™æ–¹æ¡ˆ", "å¿ƒç†å¸«")
 * @return {Array<string>} è©²å€å¡Šçš„é¸é …åˆ—è¡¨
 */
function getListFromSettings(sectionName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
    
    if (!settingsSheet) {
      // å¦‚æœæ‰¾ä¸åˆ°è¨­å®šè¡¨ï¼Œæä¾›ä¸€å€‹ UI æç¤º
      SpreadsheetApp.getUi().alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åç‚º 'ç³»çµ±è¨­å®š' çš„å·¥ä½œè¡¨ã€‚");
      return [];
    }
    
    const data = settingsSheet.getDataRange().getValues();
    const listItems = [];
    let inTargetSection = false;

    // å¾ç¬¬äºŒè¡Œé–‹å§‹éæ­· (è·³éæ¨™é¡Œ)
    for (let i = 1; i < data.length; i++) {
      const currentCellA = data[i][0].trim(); // ç•¶å‰è¡ŒAæ¬„ä½ (å€å¡Šæ¨™é¡Œ)
      const currentCellB = data[i][1].trim(); // ç•¶å‰è¡ŒBæ¬„ä½ (é¸é …å€¼)

      if (currentCellA !== "") {
        // Aæ¬„æœ‰å€¼ï¼Œä»£è¡¨é€™æ˜¯ä¸€å€‹å€å¡Šçš„é–‹å§‹
        if (inTargetSection) {
          // å¦‚æœæˆ‘å€‘åŸæœ¬å·²ç¶“åœ¨ç›®æ¨™å€å¡Šå…§ï¼Œç¾åœ¨åˆé‡åˆ°æ–°çš„å€å¡Šæ¨™é ­ï¼Œ
          // è¡¨ç¤ºç›®æ¨™å€å¡Šå·²ç¶“çµæŸï¼Œå¯ä»¥åœæ­¢è®€å–ã€‚
          break; 
        }
        if (currentCellA === sectionName) {
          // æ‰¾åˆ°äº†æˆ‘å€‘æƒ³è¦çš„å€å¡Šï¼Œé–‹å§‹è®€å–ã€‚
          inTargetSection = true;
        }
      } else if (inTargetSection && currentCellB !== "") {
        // Aæ¬„æ˜¯ç©ºçš„ï¼Œä¸”æˆ‘å€‘æ­£è™•æ–¼ç›®æ¨™å€å¡Šå…§ï¼Œé€™è¡¨ç¤ºé€™æ˜¯ä¸€å€‹é¸é …ã€‚
        listItems.push(currentCellB);
      }
    }
    
    if (listItems.length === 0) {
        Logger.log(`åœ¨ 'ç³»çµ±è¨­å®š' ä¸­æ‰¾ä¸åˆ°å€å¡Š "${sectionName}" æˆ–è©²å€å¡Šä¸‹æ²’æœ‰ä»»ä½•é …ç›®ã€‚`);
    }

    return listItems;
  } catch (error) {
    Logger.log(`å¾ç³»çµ±è¨­å®šç²å– '${sectionName}' åˆ—è¡¨æ™‚å‡ºéŒ¯: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`è®€å–è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    return []; // ç™¼ç”ŸéŒ¯èª¤æ™‚è¿”å›ç©ºé™£åˆ—
  }
}



/**
 * æ¸¬è©¦å‡½æ•¸
 */
function testFormSubmit() {
  onFormSubmit();
}

/**
 * æ¸¬è©¦å–æ¶ˆé ç´„çš„å‡½æ•¸
 */
function testCancelAppointment() {
  // ç¯„ä¾‹ï¼šå–æ¶ˆç‰¹å®šé ç´„
  const clientName = "æ¸¬è©¦å®¢æˆ¶";
  const appointmentDate = new Date("2025-02-20");
  const counselor = "ç‹é†«å¸«";
  cancelAppointment(clientName, appointmentDate, counselor);
}

/**
 * æ¸¬è©¦èª¿æ•´é ç´„æ™‚é–“çš„å‡½æ•¸
 */
function testRescheduleAppointment() {
  const clientName = "æ¸¬è©¦å®¢æˆ¶";
  const originalDate = new Date("2025-02-20");
  const counselor = "ç‹é†«å¸«";
  const newDate = new Date("2025-02-25");
  const newTime = "14:30";
  const room = "è«®å•†å®¤A";
  rescheduleAppointment(clientName, originalDate, counselor, newDate, newTime, room);
}

/**
 * ã€æ›´æ–°å¾Œã€‘å¾ç³»çµ±è¨­å®šè¡¨æ ¼ç²å–å¿ƒç†å¸«åˆ—è¡¨
 * @return {Array<string>} å¿ƒç†å¸«åˆ—è¡¨
 */
function getCounselorList() {
  return getListFromSettings("å¿ƒç†å¸«");
}

/**
 * ã€æ›´æ–°å¾Œã€‘å¾ç³»çµ±è¨­å®šè¡¨æ ¼ç²å–æœå‹™æ–¹æ¡ˆåˆ—è¡¨
 * @return {Array<string>} æœå‹™æ–¹æ¡ˆåˆ—è¡¨
 */
function getServiceTypeList() {
  return getListFromSettings("æœå‹™æ–¹æ¡ˆ");
}

/**
 * ã€æ›´æ–°å¾Œã€‘å¾ç³»çµ±è¨­å®šè¡¨æ ¼ç²å–è«®å•†å®¤åˆ—è¡¨
 * @return {Array<string>} è«®å•†å®¤åˆ—è¡¨
 */
function getRoomList() {
  return getListFromSettings("è«®å•†å®¤");
}


/**
 * ç”Ÿæˆå°æ™‚é¸é …çš„HTML
 */
function generateHourOptions() {
  var options = '';
  for (var i = 8; i <= 21; i++) {
    var hour = i < 10 ? '0' + i : '' + i;
    options += `<option value="${hour}">${hour}</option>`;
  }
  return options;
}

/**
 * æ›´æ–°ç³»çµ±è¨­å®šè¡¨æ ¼ï¼Œæ·»åŠ ä¿è­‰é‡‘æ¢ä»¶æ¬„ä½
 */
function updateSystemSettingsForDeposit() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
  
  if (!sheet) {
    return false;
  }
  
  // æª¢æŸ¥æ˜¯å¦å·²æœ‰ä¿è­‰é‡‘æ¬„ä½
  const headerRow = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  if (headerRow.indexOf("ä¿è­‰é‡‘ç‹€æ…‹") === -1) {
    // æ·»åŠ ä¿è­‰é‡‘ç‹€æ…‹å’Œå‚™è¨»æ¬„ä½
    const lastCol = sheet.getLastColumn();
    sheet.getRange(1, lastCol + 1).setValue("ä¿è­‰é‡‘ç‹€æ…‹");
    sheet.getRange(1, lastCol + 2).setValue("å‚™è¨»");
    sheet.getRange(1, lastCol + 1, 1, 2).setFontWeight("bold");
    
    // è¨­å®šæ¬„å¯¬
    sheet.setColumnWidth(lastCol + 1, 100);
    sheet.setColumnWidth(lastCol + 2, 200);
  }
  
  return true;
}

/**
 * ç²å–æ‰€æœ‰ä¿è­‰é‡‘æ¢ä»¶è¨­å®š
 * @return {Object} ä¿è­‰é‡‘æ¢ä»¶
 */
function getDepositConditions() {
  try {
    // ç¢ºä¿ç³»çµ±è¨­å®šè¡¨æ ¼å·²æ›´æ–°
    updateSystemSettingsForDeposit();
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
    const data = sheet.getDataRange().getValues();
    
    const conditions = {};
    let inServiceSection = false;
    
    // æ‰¾å‡ºä¿è­‰é‡‘ç‹€æ…‹å’Œå‚™è¨»æ¬„ä½çš„ç´¢å¼•
    const headerRow = data[0];
    const depositStatusIndex = headerRow.indexOf("ä¿è­‰é‡‘ç‹€æ…‹");
    const noteIndex = headerRow.indexOf("å‚™è¨»");
    
    // å¦‚æœæ‰¾ä¸åˆ°ä¿è­‰é‡‘æ¬„ä½ï¼Œè¿”å›ç©ºå°è±¡
    if (depositStatusIndex === -1) {
      return {};
    }
    
    // éæ­·æ‰€æœ‰è¡Œï¼Œæ‰¾å‡ºæœå‹™æ–¹æ¡ˆå€æ®µ
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === "æœå‹™æ–¹æ¡ˆ") {
        inServiceSection = true;
        continue;
      } else if (inServiceSection && (data[i][0] === "å¿ƒç†å¸«" || data[i][0] === "è«®å•†å®¤")) {
        // å·²ç¶“åˆ°ä¸‹ä¸€å€‹å€æ®µ
        break;
      }
      
      if (inServiceSection && data[i][1] && data[i][1] !== "") {
        const serviceType = data[i][1];
        const status = depositStatusIndex !== -1 && data[i][depositStatusIndex] ? data[i][depositStatusIndex] : 'éœ€æ”¶';
        const note = noteIndex !== -1 && data[i][noteIndex] ? data[i][noteIndex] : '';
        
        conditions[serviceType] = {
          status: status,
          note: note
        };
      }
    }
    
    return conditions;
  } catch (error) {
    Logger.log("ç²å–ä¿è­‰é‡‘æ¢ä»¶è¨­å®šæ™‚å‡ºéŒ¯ï¼š" + error.toString());
    return {};
  }
}

/**
 * å„²å­˜ä¿è­‰é‡‘æ¢ä»¶è¨­å®š
 * @param {Object} settings - ä¿è­‰é‡‘æ¢ä»¶è¨­å®š
 * @return {Object} è™•ç†çµæœ
 */
function saveDepositConditions(settings) {
  try {
    // ç¢ºä¿ç³»çµ±è¨­å®šè¡¨æ ¼å·²æ›´æ–°
    updateSystemSettingsForDeposit();
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
    const data = sheet.getDataRange().getValues();
    
    // æ‰¾å‡ºä¿è­‰é‡‘ç‹€æ…‹å’Œå‚™è¨»æ¬„ä½çš„ç´¢å¼•
    const headerRow = data[0];
    const depositStatusIndex = headerRow.indexOf("ä¿è­‰é‡‘ç‹€æ…‹");
    const noteIndex = headerRow.indexOf("å‚™è¨»");
    
    // å¦‚æœæ‰¾ä¸åˆ°ä¿è­‰é‡‘æ¬„ä½ï¼Œè¿”å›éŒ¯èª¤
    if (depositStatusIndex === -1) {
      // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
      logSystemActivity(
        "ç³»çµ±è¨­å®š",
        "",
        `ä¿è­‰é‡‘æ¢ä»¶è¨­å®šå¤±æ•—: æ‰¾ä¸åˆ°ä¿è­‰é‡‘ç‹€æ…‹æ¬„ä½`,
        "å¤±æ•—"
      );
      return { success: false, message: 'æ‰¾ä¸åˆ°ä¿è­‰é‡‘ç‹€æ…‹æ¬„ä½' };
    }
    
    // éæ­·æ‰€æœ‰è¡Œï¼Œæ‰¾å‡ºæœå‹™æ–¹æ¡ˆå€æ®µä¸¦æ›´æ–°
    let inServiceSection = false;
    let updated = 0;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === "æœå‹™æ–¹æ¡ˆ") {
        inServiceSection = true;
        continue;
      } else if (inServiceSection && (data[i][0] === "å¿ƒç†å¸«" || data[i][0] === "è«®å•†å®¤")) {
        // å·²ç¶“åˆ°ä¸‹ä¸€å€‹å€æ®µ
        break;
      }
      
      if (inServiceSection && data[i][1] && data[i][1] !== "") {
        const serviceType = data[i][1];
        
        if (settings[serviceType]) {
          // æ›´æ–°ä¿è­‰é‡‘ç‹€æ…‹
          sheet.getRange(i + 1, depositStatusIndex + 1).setValue(settings[serviceType].status);
          
          // æ›´æ–°å‚™è¨»
          if (noteIndex !== -1) {
            sheet.getRange(i + 1, noteIndex + 1).setValue(settings[serviceType].note);
          }
          
          updated++;
        }
      }
    }
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
    const settingsDetails = Object.keys(settings).map(type => 
      `${type}: ${settings[type].status}`).join(', ');
    
    logSystemActivity(
      "ç³»çµ±è¨­å®š",
      "",
      `æ›´æ–°ä¿è­‰é‡‘æ¢ä»¶è¨­å®š: ${settingsDetails}`,
      "æˆåŠŸ",
      "",
      `å…±æ›´æ–°${updated}é …è¨­å®š`
    );
    
    return { success: true, updatedCount: updated };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "ç³»çµ±è¨­å®š",
      "",
      `ä¿è­‰é‡‘æ¢ä»¶è¨­å®šå¤±æ•—: ${error.toString()}`,
      "å¤±æ•—"
    );
    
    Logger.log("å„²å­˜ä¿è­‰é‡‘æ¢ä»¶è¨­å®šæ™‚å‡ºéŒ¯ï¼š" + error.toString());
    return { success: false, message: 'å„²å­˜è¨­å®šæ™‚å‡ºç¾éŒ¯èª¤ï¼š' + error.toString() };
  }
}

/**
 * é¡¯ç¤ºä¿è­‰é‡‘æ¢ä»¶è¨­å®šå°è©±æ¡†
 */
function showDepositConditionsDialog() {
  // ç²å–æœå‹™æ–¹æ¡ˆåˆ—è¡¨
  const serviceTypes = getServiceTypeList();
  
  // ç²å–ç¾æœ‰ä¿è­‰é‡‘æ¢ä»¶
  const depositConditions = getDepositConditions();
  
  // ç”Ÿæˆè¡¨æ ¼è¡Œ
  let tableRows = '';
  serviceTypes.forEach(serviceType => {
    const condition = depositConditions[serviceType] || { status: 'éœ€æ”¶', note: '' };
    const checkedExempt = condition.status === 'å…æ”¶' ? 'checked' : '';
    const checkedRequired = condition.status === 'éœ€æ”¶' ? 'checked' : '';
    
    tableRows += `
      <tr>
        <td>${serviceType}</td>
        <td>
          <label><input type="radio" name="deposit_${encodeURIComponent(serviceType)}" value="å…æ”¶" ${checkedExempt}> å…æ”¶</label>
          <label><input type="radio" name="deposit_${encodeURIComponent(serviceType)}" value="éœ€æ”¶" ${checkedRequired}> éœ€æ”¶</label>
        </td>
        <td>
          <input type="text" id="note_${encodeURIComponent(serviceType)}" value="${condition.note}" style="width: 100%;">
        </td>
      </tr>
    `;
  });
  
  var html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">ä¿è­‰é‡‘æ¢ä»¶è¨­å®š</h2>
      <p>è«‹è¨­å®šå„æœå‹™æ–¹æ¡ˆçš„ä¿è­‰é‡‘æ”¶å–æ¢ä»¶ï¼š</p>
      
      <div style="max-height: 400px; overflow-y: auto; margin: 15px 0; border: 1px solid #ddd; border-radius: 4px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f8f9fa;">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">æœå‹™æ–¹æ¡ˆ</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">ä¿è­‰é‡‘ç‹€æ…‹</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">å‚™è¨»</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="saveSettings()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">å„²å­˜è¨­å®š</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
      
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      function saveSettings() {
        // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
        showLoading();
        
        const serviceTypes = ${JSON.stringify(serviceTypes)};
        const settings = {};
        
        serviceTypes.forEach(serviceType => {
          const radioName = 'deposit_' + encodeURIComponent(serviceType);
          const noteId = 'note_' + encodeURIComponent(serviceType);
          
          const radioButtons = document.getElementsByName(radioName);
          let status = 'éœ€æ”¶'; // é è¨­å€¼
          
          for (let i = 0; i < radioButtons.length; i++) {
            if (radioButtons[i].checked) {
              status = radioButtons[i].value;
              break;
            }
          }
          
          const note = document.getElementById(noteId).value;
          
          settings[serviceType] = {
            status: status,
            note: note
          };
        });
        
        google.script.run
          .withSuccessHandler(function(result) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            if (result.success) {
              showMessage('ä¿è­‰é‡‘æ¢ä»¶è¨­å®šå·²æˆåŠŸå„²å­˜ï¼æ›´æ–°äº† ' + result.updatedCount + ' å€‹æœå‹™æ–¹æ¡ˆ', 'success');
              setTimeout(function() {
                google.script.host.close();
              }, 2000);
            } else {
              showMessage(result.message || 'è¨­å®šå„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
          })
          .withFailureHandler(function(error) {
            // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
            hideLoading();
            
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error, 'error');
          })
          .saveDepositConditions(settings);
      }
      
      function showMessage(message, type) {
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = message;
        messageDiv.style.display = 'block';
        
        if (type === 'error') {
          messageDiv.style.backgroundColor = '#ffebee';
          messageDiv.style.color = '#c62828';
        } else {
          messageDiv.style.backgroundColor = '#e8f5e9';
          messageDiv.style.color = '#2e7d32';
        }
      }
    </script>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(500)
    .setHeight(550);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ä¿è­‰é‡‘æ¢ä»¶è¨­å®š');
}

/**
 * ç”Ÿæˆé€šçŸ¥è¨Šæ¯æ¡† (å·²æ–°å¢æ”¹æœŸé€šçŸ¥)
 * @param {string} messageType - è¨Šæ¯é¡å‹ (firstAppointment, renewal, deposit, cancel, reschedule)
 * @param {Object} data - ç›¸é—œè³‡æ–™
 * @return {string} HTMLè¨Šæ¯
 */
function generateNotificationMessage(messageType, data) {
  let title = '';
  let message = '';
  
  // å¾å°ç…§è¡¨ç²å–æ­£å¼åç¨±
  const displayServiceType = getServiceTypeDisplayName(data.serviceType);
  const displayCounselor = getCounselorDisplayName(data.counselor);
  
  Logger.log("åŸå§‹æœå‹™é¡å‹: " + data.serviceType + " -> è½‰æ›å¾Œ: " + displayServiceType);
  Logger.log("åŸå§‹å¿ƒç†å¸«: " + data.counselor + " -> è½‰æ›å¾Œ: " + displayCounselor);
  
  switch (messageType) {
    case 'firstAppointment': {
      title = 'åˆæ¬¡é ç´„é€šçŸ¥';
      const formattedDateWithWeekday = formatDateWithWeekday(new Date(data.appointmentDate));
      const formattedTimeOnly = data.appointmentTime;
      const clientName = data.clientName;
      
      // æª¢æŸ¥æœå‹™æ–¹æ¡ˆçš„ä¿è­‰é‡‘ç‹€æ…‹
      const depositStatus = getServiceDepositStatus(data.serviceType);
      
      if (depositStatus === "å…æ”¶") {
        // å…æ”¶ä¿è­‰é‡‘çš„è¨Šæ¯
        message = `æ‚¨å¥½ï¼Œæé†’æ‚¨å·²åª’åˆ${displayCounselor}ï¼Œ${formattedDateWithWeekday} ${formattedTimeOnly}çš„${displayServiceType}ã€‚

ç¬¬ä¸€æ¬¡å‰ä¾†å»ºè­°ææ—©5-10åˆ†é˜æ–¹ä¾¿å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œæœ‰ä»»ä½•å•é¡Œè«‹å†ä¾†é›»æœ¬æ‰€ã€‚
*å‚™è¨»:è‹¥ç‚ºé’å£¯ä¸–ä»£å¿ƒç†å¥åº·æ–¹æ¡ˆè«‹ä¸€ä½µæ”œå¸¶èº«åˆ†è­‰ä»¥åˆ©é©—è­‰èº«åˆ†

æœ¬æ‰€åœ°å€ï¼šé«˜é›„å¸‚é³³å±±å€å‡±æ—‹è·¯317å··76è™Ÿ
é€£çµ¡é›»è©±ï¼š0921-311675`;
      } else {
        // éœ€æ”¶ä¿è­‰é‡‘çš„è¨Šæ¯
        message = `æ‚¨å¥½ï¼Œæé†’æ‚¨å·²åª’åˆ${displayCounselor}ï¼Œ${formattedDateWithWeekday} ${formattedTimeOnly}çš„${displayServiceType}ã€‚
è«‹æ–¼æ”¶åˆ°æ­¤ä¿¡ä»¶çš„48å°æ™‚å…§ç¹³äº¤ä¿è­‰é‡‘600å…ƒè‡³
å°ç£éŠ€è¡Œ(004)å¸³è™Ÿ025001206438 
æˆ¶å:æµªå¿ƒäººå¿ƒç†è«®å•†æ‰€ä½•é´»è£•

è½‰å¸³å®Œæˆè«‹å…ˆå‘ŠçŸ¥æœ¬æ‰€è½‰å¸³æ™‚é–“èˆ‡è½‰å¸³å¾Œäº”ç¢¼ï¼Œç¢ºå®šæ”¶åˆ°æœƒå†å›è¦†æ‚¨ã€‚

ç¬¬ä¸€æ¬¡å‰ä¾†å»ºè­°ææ—©5-10åˆ†é˜æ–¹ä¾¿å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œæœ‰ä»»ä½•å•é¡Œè«‹å†ä¾†é›»æœ¬æ‰€ã€‚

æœ¬æ‰€åœ°å€ï¼šé«˜é›„å¸‚é³³å±±å€å‡±æ—‹è·¯317å··76è™Ÿ
é€£çµ¡é›»è©±ï¼š0921-311675`;
      }
      break;
    }
    case 'renewal': {
      title = 'çºŒç´„é€šçŸ¥';
      const formattedDateWithWeekday = formatDateWithWeekday(new Date(data.renewalDate));
      const formattedTimeOnly = data.renewalTime;
      const clientName = data.clientName;
      
      // æ ¹æ“šæœå‹™æ¬¡æ•¸ç”Ÿæˆä¸åŒçš„LINEé€šçŸ¥æ–‡å­—
      if (data.serviceCount <= 1) {
        message = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å¹«æ‚¨é ç´„ä½¿ç”¨${displayServiceType}ï¼Œå®‰æ’çš„æ˜¯${displayCounselor}ã€‚æ™‚é–“æ˜¯${formattedDateWithWeekday} ${formattedTimeOnly}ï¼Œç¬¬ä¸€æ¬¡ä¾†è«‹ææ—©10åˆ†é˜å¡«å¯«è³‡æ–™ä»¥åŠæ”œå¸¶èº«åˆ†è­‰å”·~æ„Ÿè¬æ‚¨ã€`;
      } else {
        message = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å¹«æ‚¨é ç´„ä½¿ç”¨${displayServiceType}ï¼Œå®‰æ’çš„æ˜¯${displayCounselor}ã€‚æ™‚é–“æ˜¯${formattedDateWithWeekday} ${formattedTimeOnly}ï¼Œæ„Ÿè¬æ‚¨~ã€`;
      }
      break;
    }
    case 'deposit': {
      title = 'ä¿è­‰é‡‘å·²ç¹³ç´é€šçŸ¥';
      message = `å·²ç¢ºèªæ”¶åˆ°æ‚¨çš„ä¿è­‰é‡‘ï¼Œæ„Ÿè¬æ‚¨ï¼
æé†’æ‚¨ç¬¬ä¸€æ¬¡ä¾†æ‰€è«‹ææ—©5-10åˆ†é˜ï¼Œä»¥ä¾¿å¡«å¯«è³‡æ–™ã€‚

æœ¬æ‰€åœ°å€ï¼šé«˜é›„å¸‚é³³å±±å€å‡±æ—‹è·¯317å··76è™Ÿ
é€£çµ¡é›»è©±ï¼š0921-311675`;
      break;
    }
    case 'cancel': {
      // å–æ¶ˆé ç´„è¨Šæ¯
      title = 'é ç´„å–æ¶ˆé€šçŸ¥';
      const formattedDateWithWeekday = formatDateWithWeekday(new Date(data.appointmentDate));
      const formattedTimeOnly = data.appointmentTime;
      const clientName = data.clientName;
      const cancelReason = data.cancelReason || 'æœªæä¾›åŸå› ';
      
      message = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å–æ¶ˆæ‚¨${formattedDateWithWeekday} ${formattedTimeOnly}èˆ‡${displayCounselor}çš„${displayServiceType}é ç´„ã€‚

å–æ¶ˆåŸå› ï¼š${cancelReason}

å¦‚éœ€é‡æ–°é ç´„ï¼Œè«‹å†èˆ‡æˆ‘å€‘è¯ç¹«ã€‚

æœ¬æ‰€åœ°å€ï¼šé«˜é›„å¸‚é³³å±±å€å‡±æ—‹è·¯317å··76è™Ÿ
é€£çµ¡é›»è©±ï¼š0921-311675ã€`;
      break;
    }
    case 'reschedule': {
      // æ–°å¢ï¼šæ”¹æœŸé ç´„è¨Šæ¯
      title = 'é ç´„æ”¹æœŸé€šçŸ¥';
      const formattedNewDateWithWeekday = formatDateWithWeekday(new Date(data.newDate));
      const formattedTimeOnly = data.newTime;
      const clientName = data.clientName;
      
      message = `ã€Œ${clientName}æ‚¨å¥½ï¼Œå·²å¹«æ‚¨é ç´„ä½¿ç”¨${displayServiceType}ï¼Œå®‰æ’çš„æ˜¯${displayCounselor}ã€‚èª¿æ•´æ™‚é–“æ˜¯${formattedNewDateWithWeekday} ${formattedTimeOnly}ï¼Œæ„Ÿè¬æ‚¨~ã€`;
      break;
    }
    default: {
      title = 'ç³»çµ±é€šçŸ¥';
      message = 'ç„¡å¯ç”¨è¨Šæ¯';
    }
  }
  
  // ä¿å­˜è¨Šæ¯åˆ°æ­·å²è¨˜éŒ„
  saveMessageHistory(data.clientName, messageType, message);
  
  // è¿”å›HTMLè¨Šæ¯æ¡†ï¼Œä¸åŒ…å«è¤‡è£½æŒ‰éˆ•
  return `
    <div style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
      <h3 style="color: #4285f4; margin-top: 0;">${title}</h3>
      <div style="white-space: pre-line; margin-bottom: 15px;">${message}</div>
      <div style="text-align: center;">
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
          é—œé–‰
        </button>
      </div>
    </div>
  `;
}


/**
 * ç²å–æœå‹™æ–¹æ¡ˆçš„ä¿è­‰é‡‘ç‹€æ…‹
 * @param {string} serviceType - æœå‹™æ–¹æ¡ˆåç¨±
 * @return {string} ä¿è­‰é‡‘ç‹€æ…‹ ("éœ€æ”¶" æˆ– "å…æ”¶")
 */
function getServiceDepositStatus(serviceType) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
    
    if (!sheet) {
      Logger.log("æ‰¾ä¸åˆ°ç³»çµ±è¨­å®šè¡¨æ ¼");
      return "éœ€æ”¶"; // é è¨­ç‚ºéœ€æ”¶
    }
    
    const data = sheet.getDataRange().getValues();
    let inServiceSection = false;
    
    // éæ­·è¡¨æ ¼å°‹æ‰¾æœå‹™æ–¹æ¡ˆ
    for (let i = 0; i < data.length; i++) {
      // æª¢æŸ¥æ˜¯å¦é€²å…¥æœå‹™æ–¹æ¡ˆå€æ®µ
      if (data[i][0] === "æœå‹™æ–¹æ¡ˆ") {
        inServiceSection = true;
        continue;
      }
      
      // å¦‚æœå·²ç¶“é›¢é–‹æœå‹™æ–¹æ¡ˆå€æ®µï¼Œå‰‡é€€å‡º
      if (inServiceSection && (data[i][0] === "å¿ƒç†å¸«" || data[i][0] === "è«®å•†å®¤")) {
        break;
      }
      
      // åœ¨æœå‹™æ–¹æ¡ˆå€æ®µä¸­å°‹æ‰¾åŒ¹é…çš„æœå‹™æ–¹æ¡ˆ
      if (inServiceSection && data[i][1] === serviceType) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¿è­‰é‡‘ç‹€æ…‹æ¬„ä½ (Cåˆ—)
        if (data[i].length > 2 && data[i][2]) {
          return data[i][2]; // è¿”å›ä¿è­‰é‡‘ç‹€æ…‹
        } else {
          return "éœ€æ”¶"; // å¦‚æœæ²’æœ‰æŒ‡å®šï¼Œé è¨­ç‚ºéœ€æ”¶
        }
      }
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„æœå‹™æ–¹æ¡ˆï¼Œé è¨­ç‚ºéœ€æ”¶
    Logger.log(`æ‰¾ä¸åˆ°æœå‹™æ–¹æ¡ˆ "${serviceType}" çš„ä¿è­‰é‡‘ç‹€æ…‹ï¼Œé è¨­ç‚ºéœ€æ”¶`);
    return "éœ€æ”¶";
  } catch (error) {
    Logger.log(`ç²å–æœå‹™æ–¹æ¡ˆä¿è­‰é‡‘ç‹€æ…‹æ™‚å‡ºéŒ¯: ${error.toString()}`);
    return "éœ€æ”¶"; // ç™¼ç”ŸéŒ¯èª¤æ™‚é è¨­ç‚ºéœ€æ”¶
  }
}

/**
 * é¡¯ç¤ºä¿è­‰é‡‘æª¢æ ¸å°è©±æ¡†
 */
function showDepositCheck() {
  // ç²å–æœªç¹³ä¿è­‰é‡‘çš„å€‹æ¡ˆè³‡æ–™
  const unpaidDeposits = getUnpaidDeposits();
  
  // ç”Ÿæˆè¡¨æ ¼è¡Œ
  let tableRows = '';
  unpaidDeposits.forEach(client => {
    // è¨ˆç®—è·é›¢è«®å•†æ—¥æœŸçš„å¤©æ•¸
    const today = new Date();
    const counselingDate = new Date(client.date);
    const daysUntilCounseling = Math.ceil((counselingDate - today) / (1000 * 60 * 60 * 24));
    
    // æ±ºå®šè­¦ç¤ºç­‰ç´š
    let warningClass = '';
    if (daysUntilCounseling <= 1) {
      warningClass = 'table-danger';
    } else if (daysUntilCounseling <= 3) {
      warningClass = 'table-warning';
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸå’Œæ™‚é–“
    const formattedDate = Utilities.formatDate(counselingDate, "Asia/Taipei", "yyyy/MM/dd");
    
    tableRows += `
      <tr class="${warningClass}">
        <td>${client.name}</td>
        <td>${formattedDate}</td>
        <td>${client.counselor}</td>
        <td>${client.time}</td>
        <td>${client.room}</td>
        <td>
          <button onclick="markDepositPaid('${client.name}', '${formattedDate}')" 
                  class="btn btn-success btn-sm">
            <i class="bi bi-check-circle"></i> æ¨™è¨˜å·²ç¹³äº¤
          </button>
        </td>
      </tr>
    `;
  });
  
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <style>
        body { padding: 20px; }
        .table-container {
          max-height: 500px;
          overflow-y: auto;
        }
        .warning-legend {
          margin: 20px 0;
          padding: 10px;
          border-radius: 4px;
          background-color: #f8f9fa;
        }
        .warning-item {
          display: inline-block;
          margin-right: 20px;
        }
        .warning-box {
          display: inline-block;
          width: 20px;
          height: 20px;
          margin-right: 5px;
          vertical-align: middle;
        }
        .red-warning { background-color: #f8d7da; }
        .yellow-warning { background-color: #fff3cd; }
      </style>
    </head>
    <body>
      <div class="container">
        <h2 class="mb-4">ä¿è­‰é‡‘æª¢æ ¸</h2>
        
        <div class="warning-legend">
          <div class="warning-item">
            <div class="warning-box red-warning"></div>
            è·é›¢è«®å•†æ—¥æœŸ 1 å¤©å…§
          </div>
          <div class="warning-item">
            <div class="warning-box yellow-warning"></div>
            è·é›¢è«®å•†æ—¥æœŸ 3 å¤©å…§
          </div>
        </div>
        
        <div class="table-container">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>å€‹æ¡ˆå§“å</th>
                <th>è«®å•†æ—¥æœŸ</th>
                <th>æœå‹™å¿ƒç†å¸«</th>
                <th>è«®å•†æ™‚é–“</th>
                <th>è«®å•†ç©ºé–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
        
        ${generateLoadingIndicatorHTML()}
      </div>
      
      <script>
        function markDepositPaid(clientName, date) {
          // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
          showLoading();
          
          google.script.run
            .withSuccessHandler(function(result) {
              // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
              hideLoading();
              
              if (result.success) {
                // ç§»é™¤å°æ‡‰çš„è¡Œ
                const rows = document.querySelectorAll('tr');
                rows.forEach(row => {
                  if (row.cells[0].textContent === clientName && 
                      row.cells[1].textContent === date) {
                    row.remove();
                  }
                });
                
                // å¦‚æœæ²’æœ‰æ›´å¤šæœªç¹³è²»è¨˜éŒ„ï¼Œé¡¯ç¤ºè¨Šæ¯
                if (document.querySelectorAll('tbody tr').length === 0) {
                  document.querySelector('tbody').innerHTML = 
                    '<tr><td colspan="6" class="text-center">æ²’æœ‰æœªç¹³äº¤ä¿è­‰é‡‘çš„è¨˜éŒ„</td></tr>';
                }
              } else {
                alert(result.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              }
            })
            .withFailureHandler(function(error) {
              // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
              hideLoading();
              alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
            })
            .showDepositPaymentDialog();
        }
      </script>
    </body>
    </html>
  `;
  
  const ui = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(600);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ä¿è­‰é‡‘æª¢æ ¸');
}

/**
 * ç²å–æœªç¹³ä¿è­‰é‡‘çš„å€‹æ¡ˆè³‡æ–™
 * @return {Array} æœªç¹³ä¿è­‰é‡‘çš„å€‹æ¡ˆè³‡æ–™é™£åˆ—
 */
function getUnpaidDeposits() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    const data = sheet.getDataRange().getValues();
    
    const unpaidClients = [];
    const today = new Date();
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹éæ­·ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
    for (let i = 1; i < data.length; i++) {
      const depositStatus = data[i][7]; // Håˆ— - ä¿è­‰é‡‘ç‹€æ…‹
      const counselingDate = new Date(data[i][2]); // Cåˆ— - è«®å•†æ—¥æœŸ
      
      // åªæª¢æŸ¥æ˜ç¢ºæ¨™è¨˜ç‚º"æœªç¹³ç´"çš„è¨˜éŒ„ï¼Œä¸”è«®å•†æ—¥æœŸè¦åœ¨ä»Šå¤©æˆ–ä¹‹å¾Œ
      if (depositStatus === 'æœªç¹³ç´' && counselingDate >= today) {
        unpaidClients.push({
          name: data[i][1],      // Båˆ— - å€‹æ¡ˆå§“å
          date: counselingDate,   // Cåˆ— - è«®å•†æ—¥æœŸ
          counselor: data[i][3],  // Dåˆ— - æœå‹™å¿ƒç†å¸«
          time: data[i][5],      // Fåˆ— - è«®å•†æ™‚é–“
          room: data[i][6]       // Gåˆ— - è«®å•†ç©ºé–“
        });
      }
    }
    
    // æŒ‰æ—¥æœŸæ’åº
    unpaidClients.sort((a, b) => a.date - b.date);
    
    return unpaidClients;
  } catch (error) {
    Logger.log("ç²å–æœªç¹³ä¿è­‰é‡‘è³‡æ–™æ™‚å‡ºéŒ¯: " + error.toString());
    return [];
  }
}

/**
 * é¡¯ç¤ºä¿è­‰é‡‘æª¢æ ¸å°è©±æ¡†
 */
function showDepositCheck() {
  // ç²å–æœªç¹³ä¿è­‰é‡‘çš„å€‹æ¡ˆè³‡æ–™
  const unpaidDeposits = getUnpaidDeposits();
  
  // ç”Ÿæˆè¡¨æ ¼è¡Œ
  let tableRows = '';
  if (unpaidDeposits.length === 0) {
    tableRows = '<tr><td colspan="6" class="text-center">ç›®å‰æ²’æœ‰æœªç¹³äº¤ä¿è­‰é‡‘çš„å€‹æ¡ˆ</td></tr>';
  } else {
    unpaidDeposits.forEach(client => {
      // è¨ˆç®—è·é›¢è«®å•†æ—¥æœŸçš„å¤©æ•¸
      const today = new Date();
      today.setHours(0, 0, 0, 0); // è¨­ç½®ç‚ºç•¶å¤©é–‹å§‹æ™‚é–“
      const counselingDate = new Date(client.date);
      counselingDate.setHours(0, 0, 0, 0); // è¨­ç½®ç‚ºç•¶å¤©é–‹å§‹æ™‚é–“
      const daysUntilCounseling = Math.ceil((counselingDate - today) / (1000 * 60 * 60 * 24));
      
      // æ±ºå®šè­¦ç¤ºç­‰ç´š
      let warningClass = '';
      let warningText = '';
      if (daysUntilCounseling <= 1) {
        warningClass = 'table-danger';
        warningText = 'ï¼ˆç·Šæ€¥ï¼‰';
      } else if (daysUntilCounseling <= 3) {
        warningClass = 'table-warning';
        warningText = 'ï¼ˆæ³¨æ„ï¼‰';
      }
      
      // æ ¼å¼åŒ–æ—¥æœŸå’Œæ™‚é–“
      const formattedDate = Utilities.formatDate(counselingDate, "Asia/Taipei", "yyyy/MM/dd");
      
      tableRows += `
        <tr class="${warningClass}">
          <td>${client.name}</td>
          <td>${formattedDate} ${warningText}</td>
          <td>${client.counselor}</td>
          <td>${client.time}</td>
          <td>${client.room}</td>
          <td>
            <button onclick="markDepositPaid('${client.name}', '${formattedDate}')" 
                    class="btn btn-success btn-sm">
              <i class="bi bi-check-circle"></i> æ¨™è¨˜å·²ç¹³äº¤
            </button>
          </td>
        </tr>
      `;
    });
  }
  
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <style>
        body { padding: 20px; }
        .table-container {
          max-height: 500px;
          overflow-y: auto;
        }
        .warning-legend {
          margin: 20px 0;
          padding: 10px;
          border-radius: 4px;
          background-color: #f8f9fa;
        }
        .warning-item {
          display: inline-block;
          margin-right: 20px;
        }
        .warning-box {
          display: inline-block;
          width: 20px;
          height: 20px;
          margin-right: 5px;
          vertical-align: middle;
        }
        .red-warning { background-color: #f8d7da; }
        .yellow-warning { background-color: #fff3cd; }
      </style>
    </head>
    <body>
      <div class="container">
        <h2 class="mb-4">ä¿è­‰é‡‘æª¢æ ¸</h2>
        
        <div class="warning-legend">
          <div class="warning-item">
            <div class="warning-box red-warning"></div>
            è·é›¢è«®å•†æ—¥æœŸ 1 å¤©å…§ï¼ˆç·Šæ€¥ï¼‰
          </div>
          <div class="warning-item">
            <div class="warning-box yellow-warning"></div>
            è·é›¢è«®å•†æ—¥æœŸ 3 å¤©å…§ï¼ˆæ³¨æ„ï¼‰
          </div>
        </div>
        
        <div class="table-container">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>å€‹æ¡ˆå§“å</th>
                <th>è«®å•†æ—¥æœŸ</th>
                <th>æœå‹™å¿ƒç†å¸«</th>
                <th>è«®å•†æ™‚é–“</th>
                <th>è«®å•†ç©ºé–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
        
        ${generateLoadingIndicatorHTML()}
      </div>
      
      <script>
        function markDepositPaid(clientName, date) {
          // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
          showLoading();
          
          google.script.run
            .withSuccessHandler(function(result) {
              // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
              hideLoading();
              
              if (result.success) {
                // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ¸…å–®
                google.script.run.showDepositCheck();
              } else {
                alert(result.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
              }
            })
            .withFailureHandler(function(error) {
              // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨
              hideLoading();
              alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
            })
            .showDepositPaymentDialog();
        }
      </script>
    </body>
    </html>
  `;
  
  const ui = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(600);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ä¿è­‰é‡‘æª¢æ ¸');
}


/**
 * å¾æœå‹™æ–¹æ¡ˆå°ç…§è¡¨ç²å–æ­£å¼åç¨±
 * @param {string} serviceTypeCode - æœå‹™æ–¹æ¡ˆä»£ç¢¼/ç°¡å¯«
 * @return {string} æœå‹™æ–¹æ¡ˆçš„æ­£å¼åç¨±
 */
function getServiceTypeDisplayName(serviceTypeCode) {
  try {
    // å–å¾—æœå‹™æ–¹æ¡ˆå°ç…§è¡¨
    const serviceTypesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('æœå‹™æ–¹æ¡ˆå°ç…§è¡¨');
    
    if (!serviceTypesSheet) {
      Logger.log("æ‰¾ä¸åˆ°æœå‹™æ–¹æ¡ˆå°ç…§è¡¨");
      return serviceTypeCode;
    }
    
    const data = serviceTypesSheet.getDataRange().getValues();
    
    // æ¨™æº–åŒ–æœå°‹çš„æœå‹™æ–¹æ¡ˆåç¨±
    const normalizedCode = serviceTypeCode.trim().toLowerCase();
    
    // å¾ç¬¬2è¡Œé–‹å§‹æŸ¥æ‰¾ï¼ˆå‡è¨­ç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
    for (let i = 1; i < data.length; i++) {
      if (!data[i][0]) continue; // è·³éç©ºå€¼
      
      // æ¨™æº–åŒ–è¡¨æ ¼ä¸­çš„åç¨±ä»¥é€²è¡Œæ›´å¯¬é¬†çš„æ¯”è¼ƒ
      const normalizedName = data[i][0].trim().toLowerCase();
      
      // å®Œå…¨åŒ¹é…æˆ–åŒ…å«é—œä¿‚
      if (normalizedName === normalizedCode || 
          normalizedName.includes(normalizedCode) || 
          normalizedCode.includes(normalizedName)) {
        Logger.log(`æ‰¾åˆ°æœå‹™æ–¹æ¡ˆåŒ¹é…: "${data[i][0]}" â†’ "${data[i][1]}"`);
        return data[i][1] || serviceTypeCode;  // Bæ¬„æ˜¯æ­£å¼é¡¯ç¤ºåç¨±
      }
    }
    
    Logger.log(`æ‰¾ä¸åˆ°åŒ¹é…çš„æœå‹™æ–¹æ¡ˆåç¨±ï¼Œè¿”å›åŸå§‹å€¼: ${serviceTypeCode}`);
    return serviceTypeCode;
  } catch (error) {
    Logger.log(`ç²å–æœå‹™æ–¹æ¡ˆé¡¯ç¤ºåç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.toString()}`);
    return serviceTypeCode;
  }
}

/**
 * å¾å¿ƒç†å¸«å°ç…§è¡¨ç²å–æ­£å¼åç¨±
 * @param {string} counselorCode - å¿ƒç†å¸«ä»£ç¢¼/ç°¡ç¨±
 * @return {string} å¿ƒç†å¸«çš„æ­£å¼åç¨±
 */
function getCounselorDisplayName(counselorCode) {
  try {
    // å–å¾—å¿ƒç†å¸«å°ç…§è¡¨
    const counselorsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å¿ƒç†å¸«å°ç…§è¡¨');
    
    // ç¢ºèªè¡¨æ ¼å­˜åœ¨
    if (!counselorsSheet) {
      Logger.log("æ‰¾ä¸åˆ°å¿ƒç†å¸«å°ç…§è¡¨");
      return counselorCode;
    }
    
    const data = counselorsSheet.getDataRange().getValues();
    
    // è¨˜éŒ„è¡¨æ ¼å…§å®¹é€²è¡Œèª¿è©¦
    Logger.log("å¿ƒç†å¸«å°ç…§è¡¨å…§å®¹ï¼š");
    for (let i = 0; i < Math.min(data.length, 5); i++) {
      Logger.log(`è¡Œ ${i+1}: ${JSON.stringify(data[i])}`);
    }
    
    // æ¨™æº–åŒ–æœå°‹çš„å¿ƒç†å¸«åç¨±
    const normalizedCode = counselorCode.trim().toLowerCase();
    
    // å¾ç¬¬2è¡Œé–‹å§‹æŸ¥æ‰¾ï¼ˆå‡è¨­ç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
    for (let i = 1; i < data.length; i++) {
      if (!data[i][0]) continue; // è·³éç©ºå€¼
      
      // æ¨™æº–åŒ–è¡¨æ ¼ä¸­çš„åç¨±ä»¥é€²è¡Œæ›´å¯¬é¬†çš„æ¯”è¼ƒ
      const normalizedName = data[i][0].trim().toLowerCase();
      
      // å®Œå…¨åŒ¹é…æˆ–åŒ…å«é—œä¿‚
      if (normalizedName === normalizedCode || 
          normalizedName.includes(normalizedCode) || 
          normalizedCode.includes(normalizedName)) {
        Logger.log(`æ‰¾åˆ°å¿ƒç†å¸«åŒ¹é…: "${data[i][0]}" â†’ "${data[i][1]}"`);
        return data[i][1] || counselorCode;  // Bæ¬„æ˜¯æ­£å¼é¡¯ç¤ºåç¨±
      }
    }
    
    Logger.log(`æ‰¾ä¸åˆ°åŒ¹é…çš„å¿ƒç†å¸«åç¨±ï¼Œè¿”å›åŸå§‹å€¼: ${counselorCode}`);
    return counselorCode;
  } catch (error) {
    Logger.log(`ç²å–å¿ƒç†å¸«é¡¯ç¤ºåç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.toString()}`);
    return counselorCode;
  }
}

/**
 * å¾æœå‹™æ–¹æ¡ˆå°ç…§è¡¨ç²å–æ­£å¼åç¨±
 * @param {string} serviceTypeCode - æœå‹™æ–¹æ¡ˆä»£ç¢¼/ç°¡å¯«
 * @return {string} æœå‹™æ–¹æ¡ˆçš„æ­£å¼åç¨±
 */
function getServiceTypeDisplayName(serviceTypeCode) {
  // å–å¾—æœå‹™æ–¹æ¡ˆå°ç…§è¡¨
  const serviceTypesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('æœå‹™æ–¹æ¡ˆå°ç…§è¡¨');
  const data = serviceTypesSheet.getDataRange().getValues();
  
  // å¾ç¬¬2è¡Œé–‹å§‹æŸ¥æ‰¾ï¼ˆå‡è¨­ç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === serviceTypeCode) {  // Aæ¬„æ˜¯ä»£ç¢¼/ç°¡å¯«
      return data[i][1];  // Bæ¬„æ˜¯æ­£å¼åç¨±
    }
  }
  
  // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰çš„æ­£å¼åç¨±ï¼Œå‰‡è¿”å›åŸå§‹ä»£ç¢¼
  return serviceTypeCode;
}

/**
 * å¾å¿ƒç†å¸«å°ç…§è¡¨ç²å–æ­£å¼åç¨±
 * @param {string} counselorCode - å¿ƒç†å¸«ä»£ç¢¼/ç°¡ç¨±
 * @return {string} å¿ƒç†å¸«çš„æ­£å¼åç¨±
 */
function getCounselorDisplayName(counselorCode) {
  try {
    // å–å¾—å¿ƒç†å¸«å°ç…§è¡¨
    const counselorsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å¿ƒç†å¸«å°ç…§è¡¨');
    
    // ç¢ºèªè¡¨æ ¼å­˜åœ¨
    if (!counselorsSheet) {
      Logger.log("æ‰¾ä¸åˆ°å¿ƒç†å¸«å°ç…§è¡¨");
      return counselorCode;
    }
    
    const data = counselorsSheet.getDataRange().getValues();
    
    // è¨˜éŒ„è¡¨æ ¼å…§å®¹é€²è¡Œèª¿è©¦
    Logger.log("å¿ƒç†å¸«å°ç…§è¡¨å…§å®¹ï¼š");
    for (let i = 0; i < Math.min(data.length, 5); i++) {
      Logger.log(`è¡Œ ${i+1}: ${JSON.stringify(data[i])}`);
    }
    
    // æ¨™æº–åŒ–æœå°‹çš„å¿ƒç†å¸«åç¨±
    const normalizedCode = counselorCode.trim().toLowerCase();
    
    // å¾ç¬¬2è¡Œé–‹å§‹æŸ¥æ‰¾ï¼ˆå‡è¨­ç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
    for (let i = 1; i < data.length; i++) {
      if (!data[i][0]) continue; // è·³éç©ºå€¼
      
      // æ¨™æº–åŒ–è¡¨æ ¼ä¸­çš„åç¨±ä»¥é€²è¡Œæ›´å¯¬é¬†çš„æ¯”è¼ƒ
      const normalizedName = data[i][0].trim().toLowerCase();
      
      // å®Œå…¨åŒ¹é…æˆ–åŒ…å«é—œä¿‚
      if (normalizedName === normalizedCode || 
          normalizedName.includes(normalizedCode) || 
          normalizedCode.includes(normalizedName)) {
        Logger.log(`æ‰¾åˆ°å¿ƒç†å¸«åŒ¹é…: "${data[i][0]}" â†’ "${data[i][1]}"`);
        return data[i][1] || counselorCode;  // Bæ¬„æ˜¯æ­£å¼é¡¯ç¤ºåç¨±
      }
    }
    
    Logger.log(`æ‰¾ä¸åˆ°åŒ¹é…çš„å¿ƒç†å¸«åç¨±ï¼Œè¿”å›åŸå§‹å€¼: ${counselorCode}`);
    return counselorCode;
  } catch (error) {
    Logger.log(`ç²å–å¿ƒç†å¸«é¡¯ç¤ºåç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.toString()}`);
    return counselorCode;
  }
}


/**
 * ä¿å­˜è¨Šæ¯æ­·å²è¨˜éŒ„
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} messageType - è¨Šæ¯é¡å‹
 * @param {string} message - è¨Šæ¯å…§å®¹
 */
function saveMessageHistory(clientName, messageType, message) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName("è¨Šæ¯æ­·å²è¨˜éŒ„");
    
    // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œå‰‡å‰µå»º
    if (!sheet) {
      sheet = ss.insertSheet("è¨Šæ¯æ­·å²è¨˜éŒ„");
      sheet.appendRow(["æ™‚é–“æˆ³è¨˜", "å€‹æ¡ˆå§“å", "è¨Šæ¯é¡å‹", "è¨Šæ¯å…§å®¹"]);
      sheet.getRange(1, 1, 1, 4).setFontWeight("bold");
    }
    
    // æ·»åŠ æ–°è¨˜éŒ„
    sheet.appendRow([new Date(), clientName, messageType, message]);
    
  } catch (error) {
    Logger.log("ä¿å­˜è¨Šæ¯æ­·å²è¨˜éŒ„æ™‚å‡ºéŒ¯: " + error.toString());
  }
}

/**
 * é¡¯ç¤ºè¨Šæ¯æ­·å²è¨˜éŒ„
 */
function showMessageHistory() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("è¨Šæ¯æ­·å²è¨˜éŒ„");
    
    if (!sheet || sheet.getLastRow() <= 1) {
      SpreadsheetApp.getUi().alert("æ²’æœ‰æ‰¾åˆ°è¨Šæ¯æ­·å²è¨˜éŒ„");
      return;
    }
    
    // ç²å–æ­·å²è¨˜éŒ„
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4).getValues();
    
    // ç”ŸæˆHTMLåˆ—è¡¨
    let tableRows = '';
    data.forEach(function(row, index) {
      const timestamp = Utilities.formatDate(new Date(row[0]), "Asia/Taipei", "yyyy/MM/dd HH:mm");
      const clientName = row[1] || '';
      const messageType = row[2] || '';
      const message = row[3] || '';
      
      tableRows += `
        <tr>
          <td>${timestamp}</td>
          <td>${clientName}</td>
          <td>${getMessageTypeName(messageType)}</td>
          <td>
            <button onclick="showMessage(${index})" style="background-color: #4285f4; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
              æŸ¥çœ‹å…§å®¹
            </button>
          </td>
        </tr>`;
    });
    
    // ç”Ÿæˆæ¶ˆæ¯å…§å®¹JSON
    const messagesJson = JSON.stringify(data.map(row => row[3]));
    
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <base target="_top">
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          table { width: 100%; border-collapse: separate; }
          border-spacing: 0;
          th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
          th { background-color: #f2f2f2; }
          .message-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
          }
          .message-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 600px;
          }
          .close-btn {
            float: right;
            cursor: pointer;
            font-size: 20px;
          }
          .filter-container {
            margin-bottom: 20px;
          }
          .message-text {
            white-space: pre-line;
            margin: 20px 0;
          }
        </style>
      </head>
      <body>
        <h2>è¨Šæ¯æ­·å²è¨˜éŒ„</h2>
        
        <div class="filter-container">
          <input type="text" id="clientFilter" placeholder="è¼¸å…¥å€‹æ¡ˆå§“å..." style="padding: 8px; width: 200px;">
          <button onclick="applyFilter()" style="background-color: #4285f4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
            æœå°‹
          </button>
          <button onclick="resetFilter()" style="background-color: #f1f1f1; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
            é‡ç½®
          </button>
        </div>
        
        <table id="messageTable">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>å€‹æ¡ˆå§“å</th>
              <th>è¨Šæ¯é¡å‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
        
        <div id="messageModal" class="message-modal">
          <div class="message-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>è¨Šæ¯å…§å®¹</h3>
            <div id="messageText" class="message-text"></div>
          </div>
        </div>
        
        <script>
          // ä¿å­˜æ‰€æœ‰æ¶ˆæ¯
          const messages = ${messagesJson};
          const originalTableContent = document.getElementById('messageTable').innerHTML;
          
          function showMessage(index) {
            const modal = document.getElementById('messageModal');
            const messageText = document.getElementById('messageText');
            messageText.textContent = messages[index];
            modal.style.display = 'block';
          }
          
          function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
          }
          
          function applyFilter() {
            const filterText = document.getElementById('clientFilter').value.toLowerCase();
            const tableRows = document.querySelectorAll('#messageTable tbody tr');
            
            tableRows.forEach(row => {
              const clientName = row.cells[1].textContent.toLowerCase();
              if (clientName.includes(filterText)) {
                row.style.display = '';
              } else {
                row.style.display = 'none';
              }
            });
          }
          
          function resetFilter() {
            document.getElementById('clientFilter').value = '';
            document.getElementById('messageTable').innerHTML = originalTableContent;
          }
          
          // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰å½ˆçª—
          window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target == modal) {
              modal.style.display = 'none';
            }
          }
        </script>
      </body>
      </html>
    `;
    
    var ui = HtmlService.createHtmlOutput(html)
      .setWidth(800)
      .setHeight(600);
      
    SpreadsheetApp.getUi().showModalDialog(ui, 'è¨Šæ¯æ­·å²è¨˜éŒ„');
  } catch (error) {
    Logger.log("é¡¯ç¤ºè¨Šæ¯æ­·å²è¨˜éŒ„æ™‚å‡ºéŒ¯: " + error.toString());
    SpreadsheetApp.getUi().alert("é¡¯ç¤ºè¨Šæ¯æ­·å²æ™‚ç™¼ç”ŸéŒ¯èª¤: " + error.toString());
  }
}


/**
 * ç²å–è¨Šæ¯é¡å‹åç¨±
 */
function getMessageTypeName(type) {
  switch (type) {
    case 'firstAppointment': return 'åˆæ¬¡é ç´„';
    case 'renewal': return 'çºŒç´„é€šçŸ¥';
    case 'deposit': return 'ä¿è­‰é‡‘é€šçŸ¥';
    case 'cancel': return 'å–æ¶ˆé ç´„';
    default: return type;
  }
}


/**
 * ç²å–æ‰€æœ‰å®¢æˆ¶åå–®
 * @return {Array<string>} å®¢æˆ¶åå–®
 */
function getClientList() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const clientSet = new Set();
    
    // 1. å¾ã€Œç™»éŒ„è³‡æ–™ã€è¡¨æ ¼ç²å–å®¢æˆ¶åç¨±
    const dataSheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    if (dataSheet) {
      const data = dataSheet.getDataRange().getValues();
      
      // å‡è¨­å®¢æˆ¶åç¨±åœ¨ç¬¬2åˆ—ï¼ˆç´¢å¼•1ï¼‰
      for (let i = 1; i < data.length; i++) {
        if (data[i][1] && typeof data[i][1] === 'string' && data[i][1].trim() !== '') {
          clientSet.add(data[i][1].trim());
        }
      }
    }
    
    // 2. å¾ã€Œå€‹æ¡ˆæœå‹™è¨˜éŒ„ã€è¡¨æ ¼ç²å–å®¢æˆ¶åç¨±
    const recordSheet = ss.getSheetByName("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
    if (recordSheet) {
      const records = recordSheet.getDataRange().getValues();
      
      // å‡è¨­å®¢æˆ¶åç¨±åœ¨ç¬¬1åˆ—ï¼ˆç´¢å¼•0ï¼‰
      for (let i = 1; i < records.length; i++) {
        if (records[i][0] && typeof records[i][0] === 'string' && records[i][0].trim() !== '') {
          clientSet.add(records[i][0].trim());
        }
      }
    }
    
    // 3. å¾ã€Œè¨Šæ¯æ­·å²è¨˜éŒ„ã€è¡¨æ ¼ç²å–å®¢æˆ¶åç¨±
    const messageSheet = ss.getSheetByName("è¨Šæ¯æ­·å²è¨˜éŒ„");
    if (messageSheet) {
      const messages = messageSheet.getDataRange().getValues();
      
      // å‡è¨­å®¢æˆ¶åç¨±åœ¨ç¬¬2åˆ—ï¼ˆç´¢å¼•1ï¼‰
      for (let i = 1; i < messages.length; i++) {
        if (messages[i][1] && typeof messages[i][1] === 'string' && messages[i][1].trim() !== '') {
          clientSet.add(messages[i][1].trim());
        }
      }
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•åå–®ï¼Œè¿”å›ç©ºæ•¸çµ„
    if (clientSet.size === 0) {
      Logger.log("è­¦å‘Šï¼šæ‰¾ä¸åˆ°ä»»ä½•å€‹æ¡ˆåå–®");
      return [];
    }
    
    // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åºï¼ˆæŒ‰ä¸­æ–‡æˆ–è‹±æ–‡å­—æ¯é †åºï¼‰
    const clientList = Array.from(clientSet).sort((a, b) => {
      return a.localeCompare(b, 'zh-TW');
    });
    
    Logger.log(`æˆåŠŸç²å– ${clientList.length} ä½å€‹æ¡ˆåå–®`);
    return clientList;
  } catch (error) {
    Logger.log("ç²å–å®¢æˆ¶åå–®æ™‚å‡ºéŒ¯: " + error.toString());
    return [];
  }
}

/**
 * ç²å–å€‹æ¡ˆçš„æ­·å²æœå‹™è¨˜éŒ„ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @return {Object} å€‹æ¡ˆæ­·å²æœå‹™è¨˜éŒ„
 */
function getClientServiceHistory(clientName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // å‰µå»ºæ¨™æº–åŒ–æœå‹™é¡å‹çš„æ˜ å°„è¡¨
    const serviceTypeMap = getServiceTypeMapping();
    
    // å‰µå»ºçµ±è¨ˆç‰©ä»¶
    const clientHistory = {};
    
    // é¦–å…ˆå¾ã€Œå€‹æ¡ˆæœå‹™è¨˜éŒ„ã€è¡¨æ ¼ä¸­ç²å–é è¨­æ¬¡æ•¸
    const recordSheet = ss.getSheetByName("å€‹æ¡ˆæœå‹™è¨˜éŒ„");
    if (recordSheet) {
      const records = recordSheet.getDataRange().getValues();
      // è·³éæ¨™é¡Œè¡Œ
      for (let i = 1; i < records.length; i++) {
        const name = records[i][0];
        // é€²è¡Œå®Œå…¨åŒ¹é…æˆ–éƒ¨åˆ†åŒ¹é…
        if (name && 
            (name === clientName || 
             name.includes(clientName) || 
             clientName.includes(name) ||
             areSimilarNames(name, clientName))) {
          
          let serviceType = records[i][1];
          // æ¨™æº–åŒ–æœå‹™é¡å‹
          serviceType = standardizeServiceType(serviceType, serviceTypeMap);
          const count = parseInt(records[i][2]);
          
          // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„æœå‹™é¡å‹ä½œç‚ºéµ
          clientHistory[serviceType] = count;
        }
      }
    }
    
    // ç„¶å¾Œå¾å¯¦éš›ç™»éŒ„è³‡æ–™ä¸­è¨ˆç®—æ¬¡æ•¸
    const dataSheet = ss.getSheetByName("ç™»éŒ„è³‡æ–™");
    if (dataSheet) {
      const data = dataSheet.getDataRange().getValues();
      
      // è·³éæ¨™é¡Œè¡Œ
      for (let i = 1; i < data.length; i++) {
        const name = data[i][1];
        // é€²è¡Œå®Œå…¨åŒ¹é…æˆ–éƒ¨åˆ†åŒ¹é…
        if (name && 
            (name === clientName || 
             name.includes(clientName) || 
             clientName.includes(name) ||
             areSimilarNames(name, clientName))) {
          
          let serviceType = data[i][4];
          if (serviceType) {
            // æ¨™æº–åŒ–æœå‹™é¡å‹
            serviceType = standardizeServiceType(serviceType, serviceTypeMap);
            
            // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„æœå‹™é¡å‹ä½œç‚ºéµ
            clientHistory[serviceType] = (clientHistory[serviceType] || 0) + 1;
          }
        }
      }
    }
    
    return clientHistory;
  } catch (error) {
    Logger.log("ç²å–å€‹æ¡ˆæ­·å²è¨˜éŒ„éŒ¯èª¤ï¼š" + error.toString());
    return {};
  }
}

/**
 * æª¢æŸ¥å…©å€‹åå­—æ˜¯å¦ç›¸ä¼¼
 * @param {string} name1 - ç¬¬ä¸€å€‹åå­—
 * @param {string} name2 - ç¬¬äºŒå€‹åå­—
 * @return {boolean} æ˜¯å¦ç›¸ä¼¼
 */
function areSimilarNames(name1, name2) {
  // ç§»é™¤ç©ºæ ¼ä¸¦è½‰ç‚ºå°å¯«é€²è¡Œæ¯”è¼ƒ
  const cleanName1 = name1.replace(/\s+/g, '').toLowerCase();
  const cleanName2 = name2.replace(/\s+/g, '').toLowerCase();
  
  // å¦‚æœæ¸…ç†å¾Œçš„åå­—ç›¸åŒï¼Œå‰‡è¦–ç‚ºç›¸ä¼¼
  if (cleanName1 === cleanName2) return true;
  
  // æ¼¢å­—å§“åç‰¹æ®Šè™•ç† - æª¢æŸ¥æ˜¯å¦åŒ…å«å°æ–¹çš„æ‰€æœ‰å­—
  let containsAllChars = true;
  for (let char of cleanName1) {
    if (!cleanName2.includes(char)) {
      containsAllChars = false;
      break;
    }
  }
  if (containsAllChars) return true;
  
  containsAllChars = true;
  for (let char of cleanName2) {
    if (!cleanName1.includes(char)) {
      containsAllChars = false;
      break;
    }
  }
  
  return containsAllChars;
}

/**
 * æŸ¥çœ‹å¾…è¾¦äº‹é … - ä¸»å…¥å£å‡½æ•¸
 */
function viewClientTodos() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
  
  // ç²å–é€²åº¦é¸é …å’Œå®¢æˆ¶åå–®
  const statusOptions = getStatusOptions();
  const clientNames = getClientList();
  
  // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œå‰µå»ºå®ƒ
  if (!sheet) {
    createClientTodoSheet();
    ui.alert("å·²å‰µå»ºå¾…è¾¦äº‹é …è¡¨æ ¼ï¼Œä½†ç›®å‰æ²’æœ‰è¨˜éŒ„");
  }
  
  // ç²å–æ‰€æœ‰å¾…è¾¦äº‹é …
  const data = getTodoData();
  
  // è½‰æ›æ•¸æ“šç‚ºJSON
  const jsonData = JSON.stringify(formatTodoData(data));
  
  // å‰µå»ºé¸é …HTML
  let statusOptionsHtml = statusOptions.map(status => 
    `<option value="${status}">${status}</option>`).join('');
  let clientOptionsHtml = clientNames.map(name => 
    `<option value="${name}">${name}</option>`).join('');
  
  // å‰µå»ºHTML
  const htmlContent = generateTodoHtml(statusOptionsHtml, clientOptionsHtml, jsonData);
  
  // é¡¯ç¤ºå°è©±æ¡†
  const html = HtmlService.createHtmlOutput(htmlContent)
    .setWidth(1200)
    .setHeight(700)
    .setTitle('å€‹æ¡ˆå¾…è¾¦äº‹é …ç®¡ç†');
    
  ui.showModalDialog(html, 'å€‹æ¡ˆå¾…è¾¦äº‹é …ç®¡ç†');
}

/**
 * ç²å–å¾…è¾¦äº‹é …è³‡æ–™
 * @return {Array} å¾…è¾¦äº‹é …è³‡æ–™
 */
function getTodoData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
  
  if (!sheet || sheet.getLastRow() <= 1) {
    return [];
  }
  
  return sheet.getRange(2, 1, Math.max(1, sheet.getLastRow() - 1), 8).getValues();
}

/**
 * æ ¼å¼åŒ–å¾…è¾¦äº‹é …è³‡æ–™
 * @param {Array} data - åŸå§‹è³‡æ–™
 * @return {Array} æ ¼å¼åŒ–å¾Œçš„è³‡æ–™
 */
function formatTodoData(data) {
  return data.map(row => ({
    timestamp: row[0] ? Utilities.formatDate(new Date(row[0]), "Asia/Taipei", "yyyy/MM/dd HH:mm") : '',
    clientName: row[1] || '',
    status: row[2] || '',
    notes: row[3] || '',
    deadline: row[4] ? Utilities.formatDate(new Date(row[4]), "Asia/Taipei", "yyyy/MM/dd") : '',
    priority: row[5] || '',
    assignedTo: row[6] || '',
    completedTime: row[7] ? Utilities.formatDate(new Date(row[7]), "Asia/Taipei", "yyyy/MM/dd HH:mm") : ''
  }));
}

/**
 * ç”Ÿæˆå¾…è¾¦äº‹é …HTMLå…§å®¹
 * @param {string} statusOptionsHtml - ç‹€æ…‹é¸é …HTML
 * @param {string} clientOptionsHtml - å®¢æˆ¶é¸é …HTML
 * @param {string} jsonData - JSONæ ¼å¼çš„å¾…è¾¦äº‹é …è³‡æ–™
 * @return {string} HTMLå…§å®¹
 */
function generateTodoHtml(statusOptionsHtml, clientOptionsHtml, jsonData) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <style>
        ${generateTodoCss()}
      </style>
    </head>
    <body>
      <div class="container">
        <h2 class="mb-4">å€‹æ¡ˆå¾…è¾¦äº‹é …ç®¡ç†</h2>
        
        <!-- åˆ†é æ¨™ç±¤ -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" aria-controls="active" aria-selected="true">
              <i class="bi bi-list-task"></i> é€²è¡Œä¸­çš„å¾…è¾¦
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-controls="completed" aria-selected="false">
              <i class="bi bi-check2-all"></i> å·²å®Œæˆçš„å¾…è¾¦
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab" aria-controls="add" aria-selected="false">
              <i class="bi bi-plus-circle"></i> æ–°å¢å¾…è¾¦
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
          <!-- é€²è¡Œä¸­çš„å¾…è¾¦ -->
          ${generateActiveTabHtml(statusOptionsHtml, clientOptionsHtml)}
          
          <!-- å·²å®Œæˆçš„å¾…è¾¦ -->
          ${generateCompletedTabHtml(clientOptionsHtml)}
          
          <!-- æ–°å¢å¾…è¾¦ -->
          ${generateAddTabHtml(statusOptionsHtml, clientOptionsHtml)}
        </div>
        
        <!-- ç·¨è¼¯å‚™è¨»çš„å½ˆçª— -->
        ${generateEditNotesModalHtml()}
      </div>
      
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        ${generateTodoJavaScript(jsonData)}
      </script>
    </body>
    </html>
  `;
}

/**
 * å‰µå»ºå¾…è¾¦äº‹é …UI
 * @return {HtmlOutput} HTMLè¼¸å‡º
 */
function createTodoUI() {
  // ç²å–é€²åº¦é¸é …å’Œå®¢æˆ¶åå–®
  const statusOptions = getStatusOptions();
  const clientNames = getClientList();
  
  // å‰µå»ºé¸é …HTML
  let statusOptionsHtml = statusOptions.map(status => 
    `<option value="${status}">${status}</option>`).join('');
  let clientOptionsHtml = clientNames.map(name => 
    `<option value="${name}">${name}</option>`).join('');
  
  // ç²å–æ‰€æœ‰å¾…è¾¦äº‹é …
  const data = getTodoData();
  
  // è½‰æ›æ•¸æ“šç‚ºJSON
  const jsonData = JSON.stringify(formatTodoData(data));
  
  // å‰µå»ºHTML
  const htmlContent = generateTodoHtml(statusOptionsHtml, clientOptionsHtml, jsonData);
  
  return HtmlService.createHtmlOutput(htmlContent);
}

/**
 * ç²å–å¾…è¾¦äº‹é …è³‡æ–™
 * @return {Array} å¾…è¾¦äº‹é …è³‡æ–™
 */
function getTodoData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
  
  if (!sheet || sheet.getLastRow() <= 1) {
    return [];
  }
  
  return sheet.getRange(2, 1, Math.max(1, sheet.getLastRow() - 1), 8).getValues();
}

/**
 * æ ¼å¼åŒ–å¾…è¾¦äº‹é …è³‡æ–™
 * @param {Array} data - åŸå§‹è³‡æ–™
 * @return {Array} æ ¼å¼åŒ–å¾Œçš„è³‡æ–™
 */
function formatTodoData(data) {
  return data.map(row => ({
    timestamp: row[0] ? Utilities.formatDate(new Date(row[0]), "Asia/Taipei", "yyyy/MM/dd HH:mm") : '',
    clientName: row[1] || '',
    status: row[2] || '',
    notes: row[3] || '',
    deadline: row[4] ? Utilities.formatDate(new Date(row[4]), "Asia/Taipei", "yyyy/MM/dd") : '',
    priority: row[5] || '',
    assignedTo: row[6] || '',
    completedTime: row[7] ? Utilities.formatDate(new Date(row[7]), "Asia/Taipei", "yyyy/MM/dd HH:mm") : ''
  }));
}

/**
 * ç”Ÿæˆå¾…è¾¦äº‹é …HTMLå…§å®¹
 * @param {string} statusOptionsHtml - ç‹€æ…‹é¸é …HTML
 * @param {string} clientOptionsHtml - å®¢æˆ¶é¸é …HTML
 * @param {string} jsonData - JSONæ ¼å¼çš„å¾…è¾¦äº‹é …è³‡æ–™
 * @return {string} HTMLå…§å®¹
 */
function generateTodoHtml(statusOptionsHtml, clientOptionsHtml, jsonData) {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <style>
        ${generateTodoCss()}
      </style>
    </head>
    <body>
      <div class="container">
        <h2 class="mb-4">å€‹æ¡ˆå¾…è¾¦äº‹é …ç®¡ç†</h2>
        
        <!-- åˆ†é æ¨™ç±¤ -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" aria-controls="active" aria-selected="true">
              <i class="bi bi-list-task"></i> é€²è¡Œä¸­çš„å¾…è¾¦
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab" aria-controls="completed" aria-selected="false">
              <i class="bi bi-check2-all"></i> å·²å®Œæˆçš„å¾…è¾¦
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab" aria-controls="add" aria-selected="false">
              <i class="bi bi-plus-circle"></i> æ–°å¢å¾…è¾¦
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
          <!-- é€²è¡Œä¸­çš„å¾…è¾¦ -->
          ${generateActiveTabHtml(statusOptionsHtml, clientOptionsHtml)}
          
          <!-- å·²å®Œæˆçš„å¾…è¾¦ -->
          ${generateCompletedTabHtml(clientOptionsHtml)}
          
          <!-- æ–°å¢å¾…è¾¦ -->
          ${generateAddTabHtml(statusOptionsHtml, clientOptionsHtml)}
        </div>
        
        <!-- ç·¨è¼¯å‚™è¨»çš„å½ˆçª— -->
        ${generateEditNotesModalHtml()}
      </div>
      
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        ${generateTodoJavaScript(jsonData)}
      </script>
    </body>
    </html>
  `;
}

/**
 * ç”Ÿæˆå¾…è¾¦äº‹é …CSSæ¨£å¼
 */
function generateTodoCss() {
  return `
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid rgba(0,0,0,0.125);
      padding: 0;
    }
    .table-container {
      overflow: hidden;
      position: relative;
      border-radius: 4px;
      height: calc(100vh - 250px);
      min-height: 500px;
    }
    .table-scroll {
      overflow-y: auto;
      overflow-x: hidden;
      height: 100%;
    }
    .table {
      width: 100%;
      margin-bottom: 0;
      background-color: #fff;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 1;
      border-bottom: 2px solid #dee2e6;
    }
    .table td {
      vertical-align: middle;
    }
    .filter-collapse-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      text-align: left;
      padding: 10px 15px;
      background: none;
      border: none;
      color: #333;
      cursor: pointer;
    }
    .filter-collapse-btn:hover {
      background-color: rgba(0,0,0,0.02);
    }
    .filter-collapse-btn i {
      transition: transform 0.3s ease;
    }
    .filter-collapse-btn.collapsed i {
      transform: rotate(-180deg);
    }
    .filter-content {
      padding: 15px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .filter-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }
    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .table-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .table-scroll::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    .priority-high { background-color: #ffebee; }
    .priority-medium { background-color: #fff8e1; }
    .priority-low { background-color: #e8f5e9; }
    .status-completed {
      color: #757575;
      text-decoration: line-through;
    }
    .status-canceled {
      background-color: #f5f5f5;
      color: #9e9e9e;
    }
    .status-helper {
      background-color: #e3f2fd !important;
      border-top: 2px solid #bbdefb;
      color: #1976d2;
    }
    .editable {
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .editable:hover {
      background-color: #f0f0f0;
    }
    .editable div, .notes-content {
      white-space: pre-line;
      max-height: 100px;
      overflow-y: auto;
    }
    .status-select {
      width: 100%;
      padding: 8px;
      border: 2px solid #cfe2ff;
      border-radius: 4px;
      background-color: #e8f0fe;
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }
    .status-select:hover {
      border-color: #4285f4;
    }
    .status-select:focus {
      border-color: #4285f4;
      outline: none;
      box-shadow: 0 0 0 2px rgba(66,133,244,0.25);
    }
  `;
}

/**
 * ç”Ÿæˆé€²è¡Œä¸­å¾…è¾¦æ¨™ç±¤é HTML
 */
function generateActiveTabHtml(statusOptionsHtml, clientOptionsHtml) {
  return `
    <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
      <div class="card mb-3">
        <div class="card-header">
          <button class="filter-collapse-btn collapsed" type="button" 
                  data-bs-toggle="collapse" data-bs-target="#activeFilterCollapse" 
                  aria-expanded="false" aria-controls="activeFilterCollapse">
            <span class="filter-title">
              <i class="bi bi-funnel me-2"></i>ç¯©é¸æ¢ä»¶
            </span>
            <i class="bi bi-chevron-up"></i>
          </button>
          <div class="collapse" id="activeFilterCollapse">
            <div class="filter-content">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="form-floating">
                    <select class="form-select" id="clientFilter">
                      <option value="">å…¨éƒ¨</option>
                      ${clientOptionsHtml}
                    </select>
                    <label for="clientFilter">å€‹æ¡ˆ</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-floating">
                    <select class="form-select" id="statusFilter">
                      <option value="">å…¨éƒ¨</option>
                      ${statusOptionsHtml}
                    </select>
                    <label for="statusFilter">é€²åº¦</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-floating">
                    <select class="form-select" id="priorityFilter">
                      <option value="">å…¨éƒ¨</option>
                      <option value="é«˜">é«˜</option>
                      <option value="ä¸­">ä¸­</option>
                      <option value="ä½">ä½</option>
                    </select>
                    <label for="priorityFilter">å„ªå…ˆç´š</label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="d-grid">
                    <button class="btn btn-primary" onclick="applyFilters('active')">
                      <i class="bi bi-funnel"></i> å¥—ç”¨ç¯©é¸
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body p-0">
          <div class="table-container">
            <div class="table-scroll">
              <table class="table table-hover mb-0" id="active-todos-table">
                <thead>
                  <tr>
                    <th style="width: 8%">å»ºç«‹æ™‚é–“</th>
                    <th style="width: 10%">å€‹æ¡ˆå§“å</th>
                    <th style="width: 12%">ç›®å‰é€²åº¦</th>
                    <th style="width: 38%">å‚™è¨»</th>
                    <th style="width: 7%">æˆªæ­¢æ—¥æœŸ</th>
                    <th style="width: 7%">å„ªå…ˆç´š</th>
                    <th style="width: 8%">è² è²¬äºº</th>
                    <th style="width: 10%">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- å‹•æ…‹ç”Ÿæˆçš„å¾…è¾¦é …ç›® -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div id="active-empty-state" class="empty-state" style="display: none;">
            <i class="bi bi-inbox"></i>
            <h5>ç›®å‰æ²’æœ‰é€²è¡Œä¸­çš„å¾…è¾¦äº‹é …</h5>
            <p>é»æ“Šã€Œæ–°å¢å¾…è¾¦ã€æ¨™ç±¤ä¾†æ·»åŠ æ–°çš„å¾…è¾¦äº‹é …</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

/**
 * ç”Ÿæˆå·²å®Œæˆå¾…è¾¦æ¨™ç±¤é HTML
 */
function generateCompletedTabHtml(clientOptionsHtml) {
  return `
    <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
      <div class="card mb-3">
        <div class="card-header">
          <button class="filter-collapse-btn collapsed" type="button" 
                  data-bs-toggle="collapse" data-bs-target="#completedFilterCollapse" 
                  aria-expanded="false" aria-controls="completedFilterCollapse">
            <span class="filter-title">
              <i class="bi bi-funnel me-2"></i>ç¯©é¸æ¢ä»¶
            </span>
            <i class="bi bi-chevron-up"></i>
          </button>
          <div class="collapse" id="completedFilterCollapse">
            <div class="filter-content">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="form-floating">
                    <select class="form-select" id="completedClientFilter">
                      <option value="">å…¨éƒ¨</option>
                      ${clientOptionsHtml}
                    </select>
                    <label for="completedClientFilter">å€‹æ¡ˆ</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-floating">
                    <input type="date" class="form-control" id="completedDateFilter">
                    <label for="completedDateFilter">å®Œæˆæ—¥æœŸ</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="d-grid">
                    <button class="btn btn-primary" onclick="applyFilters('completed')">
                      <i class="bi bi-funnel"></i> å¥—ç”¨ç¯©é¸
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body p-0">
          <div class="table-container">
            <div class="table-scroll">
              <table class="table table-hover mb-0" id="completed-todos-table">
                <thead>
                  <tr>
                    <th style="width: 12%">å»ºç«‹æ™‚é–“</th>
                    <th style="width: 15%">å€‹æ¡ˆå§“å</th>
                    <th style="width: 43%">å‚™è¨»</th>
                    <th style="width: 15%">å®Œæˆæ™‚é–“</th>
                    <th style="width: 15%">è² è²¬äºº</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- å‹•æ…‹ç”Ÿæˆçš„å·²å®Œæˆå¾…è¾¦é …ç›® -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div id="completed-empty-state" class="empty-state" style="display: none;">
            <i class="bi bi-check2-circle"></i>
            <h5>ç›®å‰æ²’æœ‰å·²å®Œæˆçš„å¾…è¾¦äº‹é …</h5>
            <p>ç•¶æ‚¨å°‡å¾…è¾¦äº‹é …æ¨™è¨˜ç‚ºå®Œæˆå¾Œï¼Œå®ƒå€‘å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

// åˆå§‹åŒ–å‡½æ•¸
function initializeFilters() {
  // ç›£è½ç¯©é¸å€åŸŸçš„å±•é–‹/æ”¶åˆäº‹ä»¶
  document.querySelectorAll('.filter-collapse-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.classList.toggle('collapsed');
    });
  });

  // å¦‚æœæœ‰ä½¿ç”¨ä¸­çš„ç¯©é¸æ¢ä»¶ï¼Œè‡ªå‹•å±•é–‹ç¯©é¸å€åŸŸ
  function checkAndExpandFilters(type) {
    const hasActiveFilters = false; // é€™è£¡éœ€è¦æ ¹æ“šæ‚¨çš„é‚è¼¯ä¾†åˆ¤æ–·æ˜¯å¦æœ‰ä½¿ç”¨ä¸­çš„ç¯©é¸æ¢ä»¶
    if (hasActiveFilters) {
      const collapseId = type === 'active' ? 'activeFilterCollapse' : 'completedFilterCollapse';
      const collapseElement = document.getElementById(collapseId);
      if (collapseElement) {
        const bsCollapse = new bootstrap.Collapse(collapseElement, {
          show: true
        });
      }
    }
  }

  // æª¢æŸ¥å…©å€‹æ¨™ç±¤é çš„ç¯©é¸ç‹€æ…‹
  checkAndExpandFilters('active');
  checkAndExpandFilters('completed');
}


/**
 * ç”Ÿæˆæ–°å¢å¾…è¾¦æ¨™ç±¤é HTML
 * @param {string} statusOptionsHtml - ç‹€æ…‹é¸é …HTML
 * @param {string} clientOptionsHtml - å®¢æˆ¶é¸é …HTML
 * @return {string} HTMLå…§å®¹
 */
function generateAddTabHtml(statusOptionsHtml, clientOptionsHtml) {
  return `
    <div class="tab-pane fade" id="add" role="tabpanel" aria-labelledby="add-tab">
      <div class="card">
        <div class="card-header">
          <h5>æ–°å¢å¾…è¾¦äº‹é …</h5>
        </div>
        <div class="card-body">
          <form id="add-todo-form">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="text" class="form-control" id="new-clientName" list="clientList" required>
                  <datalist id="clientList">
                    ${clientOptionsHtml}
                  </datalist>
                  <label for="new-clientName">å€‹æ¡ˆå§“å *</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <select class="form-select" id="new-status" required>
                    <option value="">è«‹é¸æ“‡é€²åº¦...</option>
                    ${statusOptionsHtml}
                  </select>
                  <label for="new-status">ç›®å‰é€²åº¦ *</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="new-notes" style="height: 100px"></textarea>
                  <label for="new-notes">å‚™è¨»</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="date" class="form-control" id="new-deadline">
                  <label for="new-deadline">æˆªæ­¢æ—¥æœŸ</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" id="new-priority">
                    <option value="ä½">ä½</option>
                    <option value="ä¸­" selected>ä¸­</option>
                    <option value="é«˜">é«˜</option>
                  </select>
                  <label for="new-priority">å„ªå…ˆç´šåˆ¥</label>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-floating">
                  <input type="text" class="form-control" id="new-assignedTo">
                  <label for="new-assignedTo">è² è²¬äºº</label>
                </div>
              </div>
              <div class="col-12 text-end">
                <button type="button" class="btn btn-primary" onclick="addNewTodo()">
                  <i class="bi bi-plus-circle"></i> æ–°å¢å¾…è¾¦
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
}

/**
 * ç”Ÿæˆç·¨è¼¯å‚™è¨»æ¨¡æ…‹æ¡†HTML
 * @return {string} HTMLå…§å®¹
 */
function generateEditNotesModalHtml() {
  return `
    <div class="modal fade" id="editNotesModal" tabindex="-1" aria-labelledby="editNotesModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editNotesModalLabel">ç·¨è¼¯å‚™è¨»</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editNotesText" class="form-label">å‚™è¨»å…§å®¹</label>
              <textarea class="form-control" id="editNotesText" rows="5" style="height: 150px;"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveNotes()">å„²å­˜</button>
          </div>
        </div>
      </div>
    </div>
  `;
}



/**
 * ç”Ÿæˆå¾…è¾¦äº‹é …JavaScriptç¨‹å¼ç¢¼
 */
function generateTodoJavaScript(jsonData) {
  return `
    // è§£æJSONæ•¸æ“š
    const todos = ${jsonData};
    const originalTodos = [...todos];
    let currentEditingTodo = null;
    
    // åœ¨é é¢åŠ è¼‰æ™‚é¡¯ç¤ºæ‰€æœ‰å¾…è¾¦äº‹é …
    document.addEventListener('DOMContentLoaded', function() {
      renderTodos();
    });
    
    // æ¸²æŸ“æ‰€æœ‰å¾…è¾¦äº‹é …
    function renderTodos() {
      renderActiveTodos(originalTodos);
      renderCompletedTodos(originalTodos);
    }
    
    // æ¸²æŸ“é€²è¡Œä¸­çš„å¾…è¾¦äº‹é …
    function renderActiveTodos(todos) {
      const activeTable = document.getElementById('active-todos-table');
      const activeBody = activeTable.querySelector('tbody');
      activeBody.innerHTML = '';
      
      // ç¯©é¸å‡ºé€²è¡Œä¸­çš„å¾…è¾¦äº‹é …
      const activeTodos = todos.filter(todo => 
        todo.status !== 'å·²å®Œæˆ' && todo.status !== 'å·²å–æ¶ˆ');
      
      // é¡¯ç¤ºç©ºç‹€æ…‹æˆ–è¡¨æ ¼
      const emptyState = document.getElementById('active-empty-state');
      
      if (activeTodos.length === 0) {
        emptyState.style.display = 'block';
        activeTable.style.display = 'none';
        return;
      } else {
        emptyState.style.display = 'none';
        activeTable.style.display = 'table';
      }
      
      // å…ˆæ ¹æ“šç‹€æ…‹å’Œå„ªå…ˆç´šæ’åº
      const statusOrder = {
        'å°å¹«æ‰‹å¾…ç¢ºå®š': 1,  // æ”¾åˆ°æœ€å¾Œ
        'é€²è¡Œä¸­': 0,
        'ç­‰å¾…å›è¦†': 0,
        'å»¶é²': 0
      };
      
      const priorityOrder = { 'é«˜': 0, 'ä¸­': 1, 'ä½': 2 };
      
      activeTodos.sort((a, b) => {
        // é¦–å…ˆæŒ‰ç‹€æ…‹æ’åº
        const statusDiff = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
        if (statusDiff !== 0) return statusDiff;
        
        // å¦‚æœç‹€æ…‹ç›¸åŒï¼Œå‰‡æŒ‰å„ªå…ˆç´šæ’åº
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      });
      
      // æ¸²æŸ“æ¯ä¸€è¡Œ
      activeTodos.forEach(todo => {
        const row = document.createElement('tr');
        
        // è¨­ç½®è¡Œçš„æ¨£å¼
        if (todo.status === 'å°å¹«æ‰‹å¾…ç¢ºå®š') {
          row.classList.add('status-helper');
        } else {
          if (todo.priority === 'é«˜') {
            row.classList.add('priority-high');
          } else if (todo.priority === 'ä¸­') {
            row.classList.add('priority-medium');
          } else if (todo.priority === 'ä½') {
            row.classList.add('priority-low');
          }
        }
        
        // æª¢æŸ¥æˆªæ­¢æ—¥æœŸ
        let deadlineClass = '';
        let deadlineText = todo.deadline || '';
        
        if (todo.deadline) {
          const today = new Date();
          const deadline = new Date(todo.deadline);
          const diffTime = Math.abs(deadline - today);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (deadline < today) {
            deadlineClass = 'deadline-overdue';
            deadlineText += ' (å·²éæœŸ)';
          } else if (diffDays <= 3) {
            deadlineClass = 'deadline-approaching';
            deadlineText += ' (å³å°‡åˆ°æœŸ)';
          }
        }
        
        // ç²å–ç‹€æ…‹é¸é …
        const statusOptions = getStatusOptions();
        
        row.innerHTML = \`
          <td>\${todo.timestamp}</td>
          <td>\${todo.clientName}</td>
          <td>
            <select class="status-select form-select" onchange="updateStatus('\${todo.timestamp}', '\${todo.clientName}', this.value)">
              \${statusOptions.map(status => 
                \`<option value="\${status}" \${todo.status === status ? 'selected' : ''}>\${status}</option>\`
              ).join('')}
            </select>
          </td>
          <td class="editable" onclick="editNotes('\${todo.timestamp}', '\${todo.clientName}')">
            <div class="notes-content">\${todo.notes || 'é»æ“Šç·¨è¼¯'}</div>
          </td>
          <td class="\${deadlineClass}">\${deadlineText}</td>
          <td>
            <span class="badge \${todo.priority === 'é«˜' ? 'bg-danger' : todo.priority === 'ä¸­' ? 'bg-warning' : 'bg-info'} badge-priority">
              \${todo.priority}
            </span>
          </td>
          <td>\${todo.assignedTo}</td>
          <td>
            <button onclick="markAsCompleted('\${todo.timestamp}', '\${todo.clientName}')" class="btn btn-sm btn-success">
              <i class="bi bi-check-circle"></i> å®Œæˆ
            </button>
            <button onclick="deleteTodo('\${todo.timestamp}', '\${todo.clientName}')" class="btn btn-sm btn-danger ms-1">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        \`;
        
        activeBody.appendChild(row);
      });
      
      // å¦‚æœæœ‰ã€Œå°å¹«æ‰‹å¾…ç¢ºå®šã€çš„é …ç›®ï¼Œæ»¾å‹•åˆ°åº•éƒ¨
      if (activeTodos.some(todo => todo.status === 'å°å¹«æ‰‹å¾…ç¢ºå®š')) {
        const tableContainer = activeTable.closest('.table-container');
        if (tableContainer) {
          tableContainer.scrollTop = tableContainer.scrollHeight;
        }
      }
    }
    
    // æ¸²æŸ“å·²å®Œæˆçš„å¾…è¾¦äº‹é …
    function renderCompletedTodos(todos) {
      const completedTable = document.getElementById('completed-todos-table');
      const completedBody = completedTable.querySelector('tbody');
      completedBody.innerHTML = '';
      
      // ç¯©é¸å‡ºå·²å®Œæˆçš„å¾…è¾¦äº‹é …
      const completedTodos = todos.filter(todo => 
        todo.status === 'å·²å®Œæˆ' || todo.status === 'å·²å–æ¶ˆ');
      
      // é¡¯ç¤ºç©ºç‹€æ…‹æˆ–è¡¨æ ¼
      const emptyState = document.getElementById('completed-empty-state');
      
      if (completedTodos.length === 0) {
        emptyState.style.display = 'block';
        completedTable.style.display = 'none';
        return;
      } else {
        emptyState.style.display = 'none';
        completedTable.style.display = 'table';
      }
      
      // æŒ‰å®Œæˆæ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      completedTodos.sort((a, b) => {
        if (!a.completedTime) return 1;
        if (!b.completedTime) return -1;
        return new Date(b.completedTime) - new Date(a.completedTime);
      });
      
      // æ¸²æŸ“æ¯ä¸€è¡Œ
      completedTodos.forEach(todo => {
        const row = document.createElement('tr');
        
        // æ ¹æ“šç‹€æ…‹è¨­ç½®æ¨£å¼
        if (todo.status === 'å·²å®Œæˆ') {
          row.classList.add('status-completed');
        } else if (todo.status === 'å·²å–æ¶ˆ') {
          row.classList.add('status-canceled');
        }
        
        row.innerHTML = \`
          <td>\${todo.timestamp}</td>
          <td>\${todo.clientName}</td>
          <td><div class="notes-content">\${todo.notes || ''}</div></td>
          <td>\${todo.completedTime}</td>
          <td>\${todo.assignedTo}</td>
        \`;
        
        completedBody.appendChild(row);
      });
    }
    
    // ç¯©é¸å¾…è¾¦äº‹é …
    function applyFilters(tabType) {
      if (tabType === 'active') {
        const clientFilter = document.getElementById('clientFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const priorityFilter = document.getElementById('priorityFilter').value;
        
        const filteredTodos = originalTodos.filter(todo => {
          // æ’é™¤å·²å®Œæˆå’Œå·²å–æ¶ˆçš„é …ç›®
          if (todo.status === 'å·²å®Œæˆ' || todo.status === 'å·²å–æ¶ˆ') return false;
          
          // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
          const matchesClient = !clientFilter || todo.clientName === clientFilter;
          const matchesStatus = !statusFilter || todo.status === statusFilter;
          const matchesPriority = !priorityFilter || todo.priority === priorityFilter;
          
          return matchesClient && matchesStatus && matchesPriority;
        });
        
        renderActiveTodos(filteredTodos);
      } else if (tabType === 'completed') {
        const clientFilter = document.getElementById('completedClientFilter').value;
        const dateFilter = document.getElementById('completedDateFilter').value;
        
        const filteredTodos = originalTodos.filter(todo => {
          // åªåŒ…å«å·²å®Œæˆå’Œå·²å–æ¶ˆçš„é …ç›®
          if (todo.status !== 'å·²å®Œæˆ' && todo.status !== 'å·²å–æ¶ˆ') return false;
          
          // æ‡‰ç”¨ç¯©é¸æ¢ä»¶
          const matchesClient = !clientFilter || todo.clientName === clientFilter;
          
          // æ—¥æœŸç¯©é¸
          let matchesDate = true;
          if (dateFilter && todo.completedTime) {
            const completedDate = todo.completedTime.split(' ')[0]; // åªå–æ—¥æœŸéƒ¨åˆ†
            matchesDate = completedDate === dateFilter;
          }
          
          return matchesClient && matchesDate;
        });
        
        renderCompletedTodos(filteredTodos);
      }
    }
    
    // æ¨™è¨˜ç‚ºå·²å®Œæˆ
    function markAsCompleted(timestamp, clientName) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            const todoIndex = originalTodos.findIndex(todo => 
              todo.timestamp === timestamp && todo.clientName === clientName);
              
            if (todoIndex !== -1) {
              originalTodos[todoIndex].status = 'å·²å®Œæˆ';
              originalTodos[todoIndex].completedTime = new Date().toLocaleString('zh-TW');
            }
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderTodos();
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            showToast('å¾…è¾¦äº‹é …å·²æ¨™è¨˜ç‚ºå®Œæˆ', 'success');
          } else {
            showToast('æ“ä½œå¤±æ•—: ' + result.message, 'danger');
          }
        })
        .markTodoAsCompleted(clientName, timestamp);
    }
    
    // åˆªé™¤å¾…è¾¦äº‹é …
    function deleteTodo(timestamp, clientName) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // å¾æœ¬åœ°æ•¸æ“šä¸­åˆªé™¤
              const todoIndex = originalTodos.findIndex(todo => 
                todo.timestamp === timestamp && todo.clientName === clientName);
                
              if (todoIndex !== -1) {
                originalTodos.splice(todoIndex, 1);
              }
              
              // é‡æ–°æ¸²æŸ“åˆ—è¡¨
              renderTodos();
              
              // é¡¯ç¤ºæˆåŠŸæç¤º
              showToast('å¾…è¾¦äº‹é …å·²åˆªé™¤', 'success');
            } else {
              showToast('åˆªé™¤å¤±æ•—: ' + result.message, 'danger');
            }
          })
          .deleteTodo(clientName, timestamp);
      }
    }
    
    // æ›´æ–°å¾…è¾¦äº‹é …ç‹€æ…‹
    function updateStatus(timestamp, clientName, newStatus) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            const todoIndex = originalTodos.findIndex(todo => 
              todo.timestamp === timestamp && todo.clientName === clientName);
              
            if (todoIndex !== -1) {
              originalTodos[todoIndex].status = newStatus;
              
              // å¦‚æœç‹€æ…‹æ”¹ç‚ºå·²å®Œæˆï¼Œè¨­ç½®å®Œæˆæ™‚é–“
              if (newStatus === 'å·²å®Œæˆ') {
                originalTodos[todoIndex].completedTime = new Date().toLocaleString('zh-TW');
              } else {
                originalTodos[todoIndex].completedTime = '';
              }
            }
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderTodos();
            
            // å¦‚æœç‹€æ…‹æ”¹ç‚ºã€Œå°å¹«æ‰‹å¾…ç¢ºå®šã€ï¼Œæ»¾å‹•åˆ°åº•éƒ¨
            if (newStatus === 'å°å¹«æ‰‹å¾…ç¢ºå®š') {
              const activeTable = document.getElementById('active-todos-table');
              const tableContainer = activeTable.closest('.table-container');
              if (tableContainer) {
                tableContainer.scrollTop = tableContainer.scrollHeight;
              }
            }
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            showToast('ç‹€æ…‹å·²æ›´æ–°', 'success');
          } else {
            showToast('æ›´æ–°ç‹€æ…‹å¤±æ•—: ' + result.message, 'danger');
          }
        })
        .updateTodoStatus(clientName, timestamp, newStatus);
    }
    
    // ç·¨è¼¯å‚™è¨»
    function editNotes(timestamp, clientName) {
      // æŸ¥æ‰¾å°æ‡‰çš„å¾…è¾¦äº‹é …
      const todo = originalTodos.find(item => 
        item.timestamp === timestamp && item.clientName === clientName);
        
      if (!todo) return;
      
      // è¨­ç½®ç•¶å‰ç·¨è¼¯çš„å¾…è¾¦äº‹é …
      currentEditingTodo = { timestamp, clientName };
      
      // é¡¯ç¤ºç·¨è¼¯å½ˆçª—
      document.getElementById('editNotesText').value = todo.notes || '';
      const modal = new bootstrap.Modal(document.getElementById('editNotesModal'));
      modal.show();
    }
    
    // ä¿å­˜å‚™è¨»
    function saveNotes() {
      if (!currentEditingTodo) return;
      
      const newNotes = document.getElementById('editNotesText').value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ›´æ–°æœ¬åœ°æ•¸æ“š
            const todoIndex = originalTodos.findIndex(todo => 
              todo.timestamp === currentEditingTodo.timestamp && 
              todo.clientName === currentEditingTodo.clientName);
              
            if (todoIndex !== -1) {
              originalTodos[todoIndex].notes = newNotes;
            }
            
            // é—œé–‰å½ˆçª—ä¸¦é‡æ–°æ¸²æŸ“
            bootstrap.Modal.getInstance(document.getElementById('editNotesModal')).hide();
            renderTodos();
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            showToast('å‚™è¨»å·²æ›´æ–°', 'success');
          } else {
            showToast('ä¿å­˜å‚™è¨»å¤±æ•—: ' + result.message, 'danger');
          }
        })
        .updateTodoNotes(currentEditingTodo.clientName, currentEditingTodo.timestamp, newNotes);
    }
    
    // æ–°å¢å¾…è¾¦äº‹é …
    function addNewTodo() {
      const clientName = document.getElementById('new-clientName').value.trim();
      const status = document.getElementById('new-status').value;
      const notes = document.getElementById('new-notes').value;
      const deadline = document.getElementById('new-deadline').value;
      const priority = document.getElementById('new-priority').value;
      const assignedTo = document.getElementById('new-assignedTo').value;
      
      // é©—è­‰å¿…å¡«æ¬„ä½
      if (!clientName || !status) {
        showToast('è«‹å¡«å¯«å€‹æ¡ˆå§“åå’Œç›®å‰é€²åº¦', 'warning');
        return;
      }
      
      // æ”¶é›†è¡¨å–®æ•¸æ“š
      const formData = {
        clientName: clientName,
        status: status,
        notes: notes,
        deadline: deadline,
        priority: priority,
        assignedTo: assignedTo
      };
      
      // æäº¤è¡¨å–®
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('new-clientName').value = '';
            document.getElementById('new-status').selectedIndex = 0;
            document.getElementById('new-notes').value = '';
            document.getElementById('new-deadline').value = '';
            document.getElementById('new-priority').selectedIndex = 1; // é‡ç½®ç‚º"ä¸­"
            document.getElementById('new-assignedTo').value = '';
            
            // æ·»åŠ æ–°å¾…è¾¦åˆ°æœ¬åœ°æ•¸æ“š
            if (result.newTodo) {
              originalTodos.push(result.newTodo);
              
              // åˆ‡æ›åˆ°é€²è¡Œä¸­çš„å¾…è¾¦åˆ†é ä¸¦é‡æ–°æ¸²æŸ“
              document.getElementById('active-tab').click();
              renderTodos();
              
              // é¡¯ç¤ºæˆåŠŸæç¤º
              showToast('å¾…è¾¦äº‹é …å·²æˆåŠŸæ–°å¢', 'success');
            } else {
              // å¦‚æœæ²’æœ‰è¿”å›æ–°å¾…è¾¦ï¼Œé‡æ–°åŠ è¼‰é é¢
              location.reload();
            }
          } else {
            showToast('æ·»åŠ å¤±æ•—: ' + result.message, 'danger');
          }
        })
        .addClientTodo(formData);
    }
    
    // ç²å–ç‹€æ…‹é¸é …
    function getStatusOptions() {
      return [
        "é€²è¡Œä¸­",
        "ç­‰å¾…å›è¦†",
        "å»¶é²",
        "å°å¹«æ‰‹å¾…ç¢ºå®š",
        "å·²å®Œæˆ",
        "å·²å–æ¶ˆ"
      ];
    }
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showToast(message, type = 'info') {
      // å‰µå»º toast å…ƒç´ 
      const toastContainer = document.createElement('div');
      toastContainer.style.position = 'fixed';
      toastContainer.style.top = '20px';
      toastContainer.style.right = '20px';
      toastContainer.style.zIndex = '9999';
      
      const toast = document.createElement('div');
      toast.className = \`toast align-items-center text-white bg-\${type}\`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = \`
        <div class="d-flex">
          <div class="toast-body">
            \${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      \`;
      
      toastContainer.appendChild(toast);
      document.body.appendChild(toastContainer);
      
      // åˆå§‹åŒ–ä¸¦é¡¯ç¤º toast
      const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
      });
      bsToast.show();
      
      // ç•¶ toast éš±è—æ™‚ç§»é™¤å…ƒç´ 
      toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toastContainer);
      });
    }
  `;
}

/**
 * åˆªé™¤å¾…è¾¦äº‹é …
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} timestamp - æ™‚é–“æˆ³è¨˜
 * @return {Object} è™•ç†çµæœ
 */
function deleteTodo(clientName, timestamp) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
    
    if (!sheet) {
      return { success: false, message: "æ‰¾ä¸åˆ°å¾…è¾¦äº‹é …è¡¨" };
    }
    
    // æŸ¥æ‰¾åŒ¹é…çš„è¡Œ
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 8).getValues();
    for (let i = 0; i < data.length; i++) {
      const rowTimestamp = Utilities.formatDate(new Date(data[i][0]), "Asia/Taipei", "yyyy/MM/dd HH:mm");
      
      if (data[i][1] === clientName && rowTimestamp === timestamp) {
        // è¨˜éŒ„è¦åˆªé™¤çš„å¾…è¾¦è©³æƒ…
        const todoDetails = `ç‹€æ…‹: ${data[i][2]}, å‚™è¨»: ${data[i][3] || 'ç„¡'}`;
        
        // åˆªé™¤è©²è¡Œ
        sheet.deleteRow(i + 2);
        
        // æ·»åŠ æ—¥èªŒè¨˜éŒ„
        logSystemActivity(
          "å¾…è¾¦äº‹é …",
          clientName,
          `åˆªé™¤å¾…è¾¦äº‹é …: ${todoDetails}`,
          "æˆåŠŸ",
          data[i][6] || "", // è² è²¬äºº
          `æ™‚é–“æˆ³è¨˜: ${timestamp}`
        );
        
        return { success: true };
      }
    }
    
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `åˆªé™¤å¾…è¾¦å¤±æ•—: æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …`,
      "å¤±æ•—",
      "",
      `æ™‚é–“æˆ³è¨˜: ${timestamp}`
    );
    
    return { success: false, message: "æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …" };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `åˆªé™¤å¾…è¾¦éŒ¯èª¤: ${error.toString()}`,
      "å¤±æ•—"
    );
    
    Logger.log("åˆªé™¤å¾…è¾¦äº‹é …æ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, message: error.toString() };
  }
}

/**
 * å‰µå»ºå€‹æ¡ˆå¾…è¾¦äº‹é …è¡¨æ ¼
 */
function createClientTodoSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
  
  if (!sheet) {
    sheet = ss.insertSheet("å€‹æ¡ˆå¾…è¾¦äº‹é …");
    sheet.appendRow([
      "æ™‚é–“æˆ³è¨˜", 
      "å€‹æ¡ˆå§“å", 
      "ç›®å‰é€²åº¦", 
      "å‚™è¨»", 
      "æˆªæ­¢æ—¥æœŸ", 
      "å„ªå…ˆç´šåˆ¥",
      "è² è²¬äºº",
      "å®Œæˆæ™‚é–“"
    ]);
    
    // è¨­ç½®è¡¨é ­æ ¼å¼
    const headerRange = sheet.getRange(1, 1, 1, 8);
    headerRange.setBackground("#4285f4");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    
    // è¨­ç½®åˆ—å¯¬
    sheet.setColumnWidth(1, 180); // æ™‚é–“æˆ³è¨˜
    sheet.setColumnWidth(2, 120); // å€‹æ¡ˆå§“å
    sheet.setColumnWidth(3, 100); // ç›®å‰é€²åº¦
    sheet.setColumnWidth(4, 250); // å‚™è¨»
    sheet.setColumnWidth(5, 100); // æˆªæ­¢æ—¥æœŸ
    sheet.setColumnWidth(6, 80);  // å„ªå…ˆç´šåˆ¥
    sheet.setColumnWidth(7, 100); // è² è²¬äºº
    sheet.setColumnWidth(8, 180); // å®Œæˆæ™‚é–“
    
    // è¨­ç½®æ¢ä»¶æ ¼å¼
    setConditionalFormatting(sheet);
  }
  
  return sheet;
}

/**
 * æ›´æ–°å¾…è¾¦äº‹é …ç‹€æ…‹
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} timestamp - æ™‚é–“æˆ³è¨˜
 * @param {string} newStatus - æ–°ç‹€æ…‹
 * @return {Object} è™•ç†çµæœ
 */
function updateTodoStatus(clientName, timestamp, newStatus) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
    
    if (!sheet) {
      return { success: false, message: "æ‰¾ä¸åˆ°å¾…è¾¦äº‹é …è¡¨" };
    }
    
    // æŸ¥æ‰¾åŒ¹é…çš„è¡Œ
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 8).getValues();
    for (let i = 0; i < data.length; i++) {
      const rowTimestamp = Utilities.formatDate(new Date(data[i][0]), "Asia/Taipei", "yyyy/MM/dd HH:mm");
      
      if (data[i][1] === clientName && rowTimestamp === timestamp) {
        // æ›´æ–°ç‹€æ…‹
        sheet.getRange(i + 2, 3).setValue(newStatus); // ç‹€æ…‹åˆ—
        
        // å¦‚æœç‹€æ…‹ç‚ºå·²å®Œæˆï¼Œè¨­ç½®å®Œæˆæ™‚é–“
        if (newStatus === "å·²å®Œæˆ") {
          sheet.getRange(i + 2, 8).setValue(new Date()); // å®Œæˆæ™‚é–“åˆ—
        } else {
          // å¦‚æœå¾å·²å®Œæˆè®Šç‚ºå…¶ä»–ç‹€æ…‹ï¼Œæ¸…ç©ºå®Œæˆæ™‚é–“
          sheet.getRange(i + 2, 8).setValue(""); 
        }
        
        // æ·»åŠ æ—¥èªŒè¨˜éŒ„
        logSystemActivity(
          "å¾…è¾¦äº‹é …",
          clientName,
          `æ›´æ–°å¾…è¾¦ç‹€æ…‹: ${newStatus}`,
          "æˆåŠŸ",
          data[i][6] || "", // è² è²¬äºº
          `æ™‚é–“æˆ³è¨˜: ${timestamp}`
        );
        
        return { success: true };
      }
    }
    
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `æ›´æ–°å¾…è¾¦ç‹€æ…‹å¤±æ•—: æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …`,
      "å¤±æ•—",
      "",
      `æ™‚é–“æˆ³è¨˜: ${timestamp}, å˜—è©¦ç‹€æ…‹: ${newStatus}`
    );
    
    return { success: false, message: "æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …" };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `æ›´æ–°å¾…è¾¦ç‹€æ…‹éŒ¯èª¤: ${error.toString()}`,
      "å¤±æ•—"
    );
    
    Logger.log("æ›´æ–°å¾…è¾¦äº‹é …ç‹€æ…‹æ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, message: error.toString() };
  }
}


/**
 * æ›´æ–°å¾…è¾¦äº‹é …å‚™è¨»
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} timestamp - æ™‚é–“æˆ³è¨˜
 * @param {string} newNotes - æ–°å‚™è¨»
 * @return {Object} è™•ç†çµæœ
 */
function updateTodoNotes(clientName, timestamp, newNotes) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
    
    if (!sheet) {
      return { success: false, message: "æ‰¾ä¸åˆ°å¾…è¾¦äº‹é …è¡¨" };
    }
    
    // æŸ¥æ‰¾åŒ¹é…çš„è¡Œ
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 8).getValues();
    for (let i = 0; i < data.length; i++) {
      const rowTimestamp = Utilities.formatDate(new Date(data[i][0]), "Asia/Taipei", "yyyy/MM/dd HH:mm");
      
      if (data[i][1] === clientName && rowTimestamp === timestamp) {
        // æ›´æ–°å‚™è¨»
        sheet.getRange(i + 2, 4).setValue(newNotes); // å‚™è¨»åˆ—
        
        // æ·»åŠ æ—¥èªŒè¨˜éŒ„
        logSystemActivity(
          "å¾…è¾¦äº‹é …",
          clientName,
          `æ›´æ–°å¾…è¾¦å‚™è¨»`,
          "æˆåŠŸ",
          data[i][6] || "", // è² è²¬äºº
          `æ™‚é–“æˆ³è¨˜: ${timestamp}`
        );
        
        return { success: true };
      }
    }
    
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `æ›´æ–°å¾…è¾¦å‚™è¨»å¤±æ•—: æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …`,
      "å¤±æ•—",
      "",
      `æ™‚é–“æˆ³è¨˜: ${timestamp}`
    );
    
    return { success: false, message: "æ‰¾ä¸åˆ°åŒ¹é…çš„å¾…è¾¦äº‹é …" };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      clientName,
      `æ›´æ–°å¾…è¾¦å‚™è¨»éŒ¯èª¤: ${error.toString()}`,
      "å¤±æ•—"
    );
    
    Logger.log("æ›´æ–°å¾…è¾¦äº‹é …å‚™è¨»æ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, message: error.toString() };
  }
}

/**
 * æ·»åŠ å€‹æ¡ˆå¾…è¾¦äº‹é …
 * @param {Object} formData - è¡¨å–®æ•¸æ“š
 * @return {Object} è™•ç†çµæœ
 */
function addClientTodo(formData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName("å€‹æ¡ˆå¾…è¾¦äº‹é …");
    
    // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå‰µå»ºå®ƒ
    if (!sheet) {
      sheet = createClientTodoSheet();
    }
    
    // æº–å‚™æ•¸æ“š
    const now = new Date();
    const deadline = formData.deadline ? new Date(formData.deadline) : "";
    
    // æ·»åŠ æ•¸æ“šè¡Œ
    sheet.appendRow([
      now,                   // æ™‚é–“æˆ³è¨˜
      formData.clientName,   // å€‹æ¡ˆå§“å
      formData.status,       // ç›®å‰é€²åº¦
      formData.notes,        // å‚™è¨»
      deadline,              // æˆªæ­¢æ—¥æœŸ
      formData.priority,     // å„ªå…ˆç´šåˆ¥
      formData.assignedTo,   // è² è²¬äºº
      formData.status === "å·²å®Œæˆ" ? now : ""  // å®Œæˆæ™‚é–“ï¼ˆå¦‚æœç‹€æ…‹æ˜¯å·²å®Œæˆï¼Œå‰‡è¨­ç½®ç‚ºç•¶å‰æ™‚é–“ï¼‰
    ]);
    
    // è¨­ç½®æ¢ä»¶æ ¼å¼
    setConditionalFormatting(sheet);
    
    // å‰µå»ºè¿”å›çš„æ–°å¾…è¾¦äº‹é …å°è±¡
    const newTodo = {
      timestamp: Utilities.formatDate(now, "Asia/Taipei", "yyyy/MM/dd HH:mm"),
      clientName: formData.clientName,
      status: formData.status,
      notes: formData.notes,
      deadline: formData.deadline,
      priority: formData.priority,
      assignedTo: formData.assignedTo,
      completedTime: formData.status === "å·²å®Œæˆ" ? 
        Utilities.formatDate(now, "Asia/Taipei", "yyyy/MM/dd HH:mm") : ""
    };
    
    // æ·»åŠ æˆåŠŸæ—¥èªŒè¨˜éŒ„
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      formData.clientName,
      `æ–°å¢å¾…è¾¦: ${formData.status}`,
      "æˆåŠŸ",
      formData.assignedTo,
      `å„ªå…ˆç´š: ${formData.priority}, æˆªæ­¢æ—¥æœŸ: ${formData.deadline || 'ç„¡'}`
    );
    
    return { success: true, newTodo: newTodo };
  } catch (error) {
    // è¨˜éŒ„å¤±æ•—æ—¥èªŒ
    logSystemActivity(
      "å¾…è¾¦äº‹é …",
      formData.clientName || "",
      `æ–°å¢å¾…è¾¦å¤±æ•—: ${error.toString()}`,
      "å¤±æ•—",
      formData.assignedTo || ""
    );
    
    Logger.log("æ·»åŠ å¾…è¾¦äº‹é …æ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, message: error.toString() };
  }
}

/**
 * ç²å–å¾…è¾¦äº‹é …ç‹€æ…‹é¸é …
 * @return {Array<string>} ç‹€æ…‹é¸é …åˆ—è¡¨
 */
function getStatusOptions() {
  return [
    "é€²è¡Œä¸­",
    "ç­‰å¾…å›è¦†",
    "å»¶é²",
    "å·²å®Œæˆ",
    "å·²å–æ¶ˆ",
    "ç­‰å¾…å›è¦†",
    "å°å¹«æ‰‹å¾…ç¢ºå®š"
  ];
}

/**
 * å°‡å¾…è¾¦äº‹é …æ¨™è¨˜ç‚ºå·²å®Œæˆ
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} timestamp - æ™‚é–“æˆ³è¨˜
 * @return {Object} è™•ç†çµæœ
 */
function markTodoAsCompleted(clientName, timestamp) {
  return updateTodoStatus(clientName, timestamp, "å·²å®Œæˆ");
}

/**
 * è¨­ç½®è¡¨æ ¼çš„æ¢ä»¶æ ¼å¼
 */
function setConditionalFormatting(sheet) {
  // æ¸…é™¤ç¾æœ‰çš„æ¢ä»¶æ ¼å¼
  const rules = sheet.getConditionalFormatRules();
  sheet.clearConditionalFormatRules();
  
  // ç²å–è³‡æ–™ç¯„åœ
  const lastRow = Math.max(sheet.getLastRow(), 2);
  const dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());
  
  // è¨­ç½®å„ªå…ˆç´šçš„æ¢ä»¶æ ¼å¼
  const priorityColumn = 6; // Fåˆ—
  const statusColumn = 3;   // Cåˆ—
  
  // é«˜å„ªå…ˆç´š - ç´…è‰²èƒŒæ™¯
  let highPriorityRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("é«˜")
    .setBackground("#ffcccc")
    .setRanges([sheet.getRange(2, priorityColumn, lastRow - 1, 1)])
    .build();
  
  // ä¸­å„ªå…ˆç´š - é»ƒè‰²èƒŒæ™¯
  let mediumPriorityRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("ä¸­")
    .setBackground("#fff2cc")
    .setRanges([sheet.getRange(2, priorityColumn, lastRow - 1, 1)])
    .build();
  
  // ä½å„ªå…ˆç´š - ç¶ è‰²èƒŒæ™¯
  let lowPriorityRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("ä½")
    .setBackground("#d9ead3")
    .setRanges([sheet.getRange(2, priorityColumn, lastRow - 1, 1)])
    .build();
  
  // å·²å®Œæˆ - æ–‡å­—åˆªé™¤ç·š
  let completedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("å·²å®Œæˆ")
    .setStrikethrough(true)
    .setFontColor("#999999")
    .setRanges([sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn())])
    .build();
  
  // å·²å–æ¶ˆ - ç°è‰²èƒŒæ™¯
  let canceledRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("å·²å–æ¶ˆ")
    .setBackground("#eeeeee")
    .setFontColor("#999999")
    .setRanges([sheet.getRange(2, statusColumn, lastRow - 1, 1)])
    .build();
  
  // å°å¹«æ‰‹å¾…ç¢ºå®š - æ·ºè—è‰²èƒŒæ™¯
  let helperRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("å°å¹«æ‰‹å¾…ç¢ºå®š")
    .setBackground("#e3f2fd")
    .setFontColor("#1976d2")
    .setRanges([sheet.getRange(2, statusColumn, lastRow - 1, 1)])
    .build();
  
  // æ·»åŠ æ‰€æœ‰è¦å‰‡
  sheet.setConditionalFormatRules([
    highPriorityRule,
    mediumPriorityRule,
    lowPriorityRule,
    completedRule,
    canceledRule,
    helperRule
  ]);
}



/**
 * è‡ªå‹•å®šæ™‚å‚™ä»½ç³»çµ±
 * åŠŸèƒ½ï¼š
 * 1. å¯è¨­å®šæ¯æ—¥/æ¯é€±/æ¯æœˆè‡ªå‹•å‚™ä»½
 * 2. å‚™ä»½åˆ°æŒ‡å®š Google Drive è³‡æ–™å¤¾
 * 3. ä¿ç•™æ­·å²å‚™ä»½ç‰ˆæœ¬
 * 4. å¯è¨­å®šå‚™ä»½ä¿ç•™å¤©æ•¸
 */

// ç³»çµ±è¨­å®šå¸¸æ•¸
const BACKUP_SETTINGS = {
  // é è¨­å‚™ä»½è¨­å®š
  DEFAULT_BACKUP_FOLDER_NAME: "è©¦ç®—è¡¨å‚™ä»½",
  DEFAULT_RETENTION_DAYS: 30, // é è¨­ä¿ç•™30å¤©
  DEFAULT_BACKUP_SCHEDULE: "daily", // daily, weekly, monthly
  TIMEZONE: "Asia/Taipei" // è¨­å®šæ™‚å€
};

/**
 * å®‰è£å‚™ä»½ç³»çµ±è§¸ç™¼å™¨
 */
function installBackupTriggers() {
  // å…ˆåˆªé™¤æ‰€æœ‰ç¾æœ‰çš„å‚™ä»½è§¸ç™¼å™¨
  deleteAllBackupTriggers();
  
  // ç²å–ç”¨æˆ¶è¨­å®šçš„å‚™ä»½æ’ç¨‹
  const userProperties = PropertiesService.getUserProperties();
  const backupSchedule = userProperties.getProperty('backup_schedule') || BACKUP_SETTINGS.DEFAULT_BACKUP_SCHEDULE;
  
  // æ ¹æ“šæ’ç¨‹è¨­å®šè§¸ç™¼å™¨
  let trigger;
  switch(backupSchedule.toLowerCase()) {
    case "daily":
      // æ¯å¤©å‡Œæ™¨2é»åŸ·è¡Œå‚™ä»½
      trigger = ScriptApp.newTrigger('executeScheduledBackup')
        .timeBased()
        .everyDays(1)
        .atHour(2)
        .inTimezone(BACKUP_SETTINGS.TIMEZONE)
        .create();
      break;
      
    case "weekly":
      // æ¯é€±æ—¥å‡Œæ™¨2é»åŸ·è¡Œå‚™ä»½
      trigger = ScriptApp.newTrigger('executeScheduledBackup')
        .timeBased()
        .everyWeeks(1)
        .onWeekDay(ScriptApp.WeekDay.SUNDAY)
        .atHour(2)
        .inTimezone(BACKUP_SETTINGS.TIMEZONE)
        .create();
      break;
      
    case "monthly":
      // æ¯æœˆ1æ—¥å‡Œæ™¨2é»åŸ·è¡Œå‚™ä»½
      trigger = ScriptApp.newTrigger('executeScheduledBackup')
        .timeBased()
        .everyMonths(1)
        .onFirstDayOfMonth()
        .atHour(2)
        .inTimezone(BACKUP_SETTINGS.TIMEZONE)
        .create();
      break;
      
    default:
      throw new Error("ç„¡æ•ˆçš„å‚™ä»½æ’ç¨‹è¨­å®š");
  }
  
  Logger.log("å·²å®‰è£å‚™ä»½è§¸ç™¼å™¨: " + trigger.getUniqueId());
  return trigger;
}

/**
 * åˆªé™¤æ‰€æœ‰å‚™ä»½è§¸ç™¼å™¨
 */
function deleteAllBackupTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  let deletedCount = 0;
  
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'executeScheduledBackup') {
      ScriptApp.deleteTrigger(trigger);
      deletedCount++;
    }
  });
  
  Logger.log(`å·²åˆªé™¤ ${deletedCount} å€‹å‚™ä»½è§¸ç™¼å™¨`);
  return deletedCount;
}

/**
 * åŸ·è¡Œæ’å®šçš„å‚™ä»½ (ç”±è§¸ç™¼å™¨å‘¼å«)
 */
function executeScheduledBackup() {
  try {
    // ç²å–ç•¶å‰è©¦ç®—è¡¨
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const spreadsheetName = spreadsheet.getName();
    
    // åŸ·è¡Œå‚™ä»½
    const backupFile = backupSpreadsheet(spreadsheet);
    
    // æ¸…ç†èˆŠå‚™ä»½
    cleanupOldBackups(spreadsheetName);
    
    // è¨˜éŒ„å‚™ä»½æ—¥èªŒ
    logBackupActivity(spreadsheetName, "è‡ªå‹•å‚™ä»½æˆåŠŸ");
    
    return backupFile;
  } catch (error) {
    Logger.log("è‡ªå‹•å‚™ä»½å¤±æ•—: " + error.toString());
    logBackupActivity(spreadsheet.getName(), "è‡ªå‹•å‚™ä»½å¤±æ•—: " + error.toString());
    throw error;
  }
}

/**
 * æ‰‹å‹•åŸ·è¡Œå‚™ä»½
 */
function manualBackup() {
  try {
    // ç²å–ç•¶å‰è©¦ç®—è¡¨
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const spreadsheetName = spreadsheet.getName();
    
    // åŸ·è¡Œå‚™ä»½
    const backupFile = backupSpreadsheet(spreadsheet);
    
    // è¨˜éŒ„å‚™ä»½æ—¥èªŒ
    logBackupActivity(spreadsheetName, "æ‰‹å‹•å‚™ä»½æˆåŠŸ");
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    SpreadsheetApp.getUi().alert("å‚™ä»½æˆåŠŸ", 
      `è©¦ç®—è¡¨å·²æˆåŠŸå‚™ä»½è‡³: ${backupFile.getUrl()}`, 
      SpreadsheetApp.getUi().ButtonSet.OK);
    
    return backupFile;
  } catch (error) {
    Logger.log("æ‰‹å‹•å‚™ä»½å¤±æ•—: " + error.toString());
    SpreadsheetApp.getUi().alert("å‚™ä»½å¤±æ•—", 
      "å‚™ä»½éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: " + error.toString(), 
      SpreadsheetApp.getUi().ButtonSet.OK);
    throw error;
  }
}

/**
 * å‚™ä»½è©¦ç®—è¡¨
 * @param {Spreadsheet} spreadsheet è¦å‚™ä»½çš„è©¦ç®—è¡¨
 * @return {File} å‚™ä»½æª”æ¡ˆ
 */
function backupSpreadsheet(spreadsheet) {
  // ç²å–æˆ–å»ºç«‹å‚™ä»½è³‡æ–™å¤¾
  const backupFolder = getOrCreateBackupFolder();
  
  // å»ºç«‹å‚™ä»½æª”å (åŒ…å«æ—¥æœŸæ™‚é–“)
  const dateTimeString = Utilities.formatDate(new Date(), BACKUP_SETTINGS.TIMEZONE, "yyyyMMdd-HHmmss");
  const spreadsheetName = spreadsheet.getName();
  const backupName = `${spreadsheetName} å‚™ä»½ ${dateTimeString}`;
  
  // å»ºç«‹å‚™ä»½ (è¤‡è£½æ•´å€‹è©¦ç®—è¡¨)
  const backupFile = DriveApp.getFileById(spreadsheet.getId()).makeCopy(backupName, backupFolder);
  
  Logger.log(`å·²å»ºç«‹å‚™ä»½: ${backupFile.getUrl()}`);
  return backupFile;
}

/**
 * ç²å–æˆ–å»ºç«‹å‚™ä»½è³‡æ–™å¤¾
 * @return {Folder} å‚™ä»½è³‡æ–™å¤¾
 */
function getOrCreateBackupFolder() {
  const folderName = BACKUP_SETTINGS.DEFAULT_BACKUP_FOLDER_NAME;
  let folder;
  
  // æª¢æŸ¥æ˜¯å¦å·²æœ‰å‚™ä»½è³‡æ–™å¤¾
  const folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) {
    folder = folders.next();
  } else {
    // å»ºç«‹æ–°å‚™ä»½è³‡æ–™å¤¾
    folder = DriveApp.createFolder(folderName);
    Logger.log(`å·²å»ºç«‹å‚™ä»½è³‡æ–™å¤¾: ${folder.getUrl()}`);
  }
  
  return folder;
}

/**
 * æ¸…ç†èˆŠå‚™ä»½
 * @param {string} spreadsheetName è©¦ç®—è¡¨åç¨±
 */
function cleanupOldBackups(spreadsheetName) {
  // ç²å–å‚™ä»½è³‡æ–™å¤¾
  const backupFolder = getOrCreateBackupFolder();
  
  // ç²å–ç”¨æˆ¶è¨­å®šçš„ä¿ç•™å¤©æ•¸
  const userProperties = PropertiesService.getUserProperties();
  const retentionDays = parseInt(userProperties.getProperty('retention_days')) || BACKUP_SETTINGS.DEFAULT_RETENTION_DAYS;
  
  // è¨ˆç®—æˆªæ­¢æ—¥æœŸ
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
  
  // ç²å–å‚™ä»½è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰æª”æ¡ˆ
  const files = backupFolder.getFiles();
  let deletedCount = 0;
  
  while (files.hasNext()) {
    const file = files.next();
    const fileName = file.getName();
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç•¶å‰è©¦ç®—è¡¨çš„å‚™ä»½ä¸”è¶…éä¿ç•™æœŸé™
    if (fileName.includes(spreadsheetName + " å‚™ä»½")) {
      const fileDate = file.getLastUpdated();
      
      if (fileDate < cutoffDate) {
        // åˆªé™¤èˆŠå‚™ä»½
        file.setTrashed(true);
        deletedCount++;
        Logger.log(`å·²åˆªé™¤èˆŠå‚™ä»½: ${fileName}`);
      }
    }
  }
  
  Logger.log(`å·²æ¸…ç† ${deletedCount} å€‹èˆŠå‚™ä»½`);
  return deletedCount;
}

/**
 * è¨˜éŒ„å‚™ä»½æ´»å‹•
 * @param {string} spreadsheetName è©¦ç®—è¡¨åç¨±
 * @param {string} message è¨˜éŒ„è¨Šæ¯
 */
function logBackupActivity(spreadsheetName, message) {
  // ç²å–æˆ–å»ºç«‹æ—¥èªŒè©¦ç®—è¡¨
  const logSpreadsheet = getOrCreateLogSpreadsheet();
  const logSheet = logSpreadsheet.getSheetByName("å‚™ä»½æ—¥èªŒ") || logSpreadsheet.insertSheet("å‚™ä»½æ—¥èªŒ");
  
  // è¨­å®šæ—¥èªŒè¡¨é ­ (å¦‚æœä¸å­˜åœ¨)
  if (logSheet.getLastRow() === 0) {
    logSheet.appendRow(["æ™‚é–“", "è©¦ç®—è¡¨åç¨±", "æ´»å‹•é¡å‹", "è¨Šæ¯", "ç‹€æ…‹"]);
  }
  
  // æ·»åŠ æ—¥èªŒè¨˜éŒ„
  const timestamp = Utilities.formatDate(new Date(), BACKUP_SETTINGS.TIMEZONE, "yyyy/MM/dd HH:mm:ss");
  const activityType = message.includes("è‡ªå‹•") ? "è‡ªå‹•å‚™ä»½" : "æ‰‹å‹•å‚™ä»½";
  const status = message.includes("æˆåŠŸ") ? "æˆåŠŸ" : "å¤±æ•—";
  
  logSheet.appendRow([timestamp, spreadsheetName, activityType, message, status]);
  
  Logger.log(`å‚™ä»½æ—¥èªŒå·²è¨˜éŒ„: ${message}`);
}

/**
 * ç²å–æˆ–å»ºç«‹æ—¥èªŒè©¦ç®—è¡¨
 * @return {Spreadsheet} æ—¥èªŒè©¦ç®—è¡¨
 */
function getOrCreateLogSpreadsheet() {
  const logSpreadsheetName = "è©¦ç®—è¡¨å‚™ä»½ç³»çµ±æ—¥èªŒ";
  let logSpreadsheet;
  
  try {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ—¥èªŒè©¦ç®—è¡¨
    const files = DriveApp.getFilesByName(logSpreadsheetName);
    if (files.hasNext()) {
      logSpreadsheet = SpreadsheetApp.open(files.next());
    } else {
      // å»ºç«‹æ–°æ—¥èªŒè©¦ç®—è¡¨
      logSpreadsheet = SpreadsheetApp.create(logSpreadsheetName);
      const logSheet = logSpreadsheet.getActiveSheet();
      logSheet.setName("å‚™ä»½æ—¥èªŒ");
      logSheet.appendRow(["æ™‚é–“", "è©¦ç®—è¡¨åç¨±", "æ´»å‹•é¡å‹", "è¨Šæ¯", "ç‹€æ…‹"]);
      
      // ç§»å‹•åˆ°å‚™ä»½è³‡æ–™å¤¾
      const backupFolder = getOrCreateBackupFolder();
      const logFile = DriveApp.getFileById(logSpreadsheet.getId());
      backupFolder.addFile(logFile);
      DriveApp.getRootFolder().removeFile(logFile);
      
      Logger.log(`å·²å»ºç«‹æ—¥èªŒè©¦ç®—è¡¨: ${logSpreadsheet.getUrl()}`);
    }
    
    return logSpreadsheet;
  } catch (error) {
    Logger.log("ç²å–æ—¥èªŒè©¦ç®—è¡¨æ™‚å‡ºéŒ¯: " + error.toString());
    throw error;
  }
}

/**
 * é¡¯ç¤ºå‚™ä»½è¨­å®šå°è©±æ¡†
 */
function showBackupSettingsDialog() {
  // ç²å–ç•¶å‰è¨­å®š
  const userProperties = PropertiesService.getUserProperties();
  const currentSchedule = userProperties.getProperty('backup_schedule') || BACKUP_SETTINGS.DEFAULT_BACKUP_SCHEDULE;
  const currentRetentionDays = userProperties.getProperty('retention_days') || BACKUP_SETTINGS.DEFAULT_RETENTION_DAYS;
  
  const html = HtmlService.createHtmlOutput(`
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">å‚™ä»½ç³»çµ±è¨­å®š</h2>
      
      <div style="margin: 15px 0;">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">å‚™ä»½æ’ç¨‹ï¼š</label>
        <select id="backupSchedule" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="daily" ${currentSchedule === 'daily' ? 'selected' : ''}>æ¯æ—¥å‚™ä»½</option>
          <option value="weekly" ${currentSchedule === 'weekly' ? 'selected' : ''}>æ¯é€±å‚™ä»½</option>
          <option value="monthly" ${currentSchedule === 'monthly' ? 'selected' : ''}>æ¯æœˆå‚™ä»½</option>
        </select>
      </div>
      
      <div style="margin: 15px 0;">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">å‚™ä»½ä¿ç•™å¤©æ•¸ï¼š</label>
        <input type="number" id="retentionDays" value="${currentRetentionDays}" 
               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" 
               min="1" max="365">
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="saveSettings()" style="background-color: #4285f4; color: white; border: none; 
                padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
          å„²å­˜è¨­å®š
        </button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; 
                padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          å–æ¶ˆ
        </button>
      </div>
      
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
    </div>
    
    <script>
      function saveSettings() {
        const backupSchedule = document.getElementById('backupSchedule').value;
        const retentionDays = document.getElementById('retentionDays').value;
        
        if (!retentionDays || retentionDays < 1 || retentionDays > 365) {
          showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¿ç•™å¤©æ•¸ (1-365)', 'error');
          return;
        }
        
        google.script.run
          .withSuccessHandler(function() {
            showMessage('è¨­å®šå·²æˆåŠŸå„²å­˜ï¼', 'success');
            setTimeout(function() {
              google.script.host.close();
            }, 2000);
          })
          .withFailureHandler(function(error) {
            showMessage('å„²å­˜è¨­å®šæ™‚å‡ºéŒ¯: ' + error, 'error');
          })
          .saveBackupSettings(backupSchedule, retentionDays);
      }
      
      function showMessage(message, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        messageDiv.style.backgroundColor = type === 'error' ? '#ffebee' : '#e8f5e9';
        messageDiv.style.color = type === 'error' ? '#c62828' : '#2e7d32';
      }
    </script>
  `)
  .setWidth(400)
  .setHeight(350);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'å‚™ä»½ç³»çµ±è¨­å®š');
}

/**
 * å„²å­˜å‚™ä»½è¨­å®š
 * @param {string} backupSchedule å‚™ä»½æ’ç¨‹ (daily, weekly, monthly)
 * @param {number} retentionDays å‚™ä»½ä¿ç•™å¤©æ•¸
 */
function saveBackupSettings(backupSchedule, retentionDays) {
  // é©—è­‰è¼¸å…¥
  if (!['daily', 'weekly', 'monthly'].includes(backupSchedule)) {
    throw new Error("ç„¡æ•ˆçš„å‚™ä»½æ’ç¨‹è¨­å®š");
  }
  
  if (isNaN(retentionDays) || retentionDays < 1 || retentionDays > 365) {
    throw new Error("ç„¡æ•ˆçš„ä¿ç•™å¤©æ•¸è¨­å®š (å¿…é ˆä»‹æ–¼1-365)");
  }
  
  // å„²å­˜è¨­å®š
  const userProperties = PropertiesService.getUserProperties();
  userProperties.setProperty('backup_schedule', backupSchedule);
  userProperties.setProperty('retention_days', retentionDays.toString());
  
  // é‡æ–°å®‰è£è§¸ç™¼å™¨
  installBackupTriggers();
  
  Logger.log(`å·²æ›´æ–°å‚™ä»½è¨­å®š: æ’ç¨‹=${backupSchedule}, ä¿ç•™å¤©æ•¸=${retentionDays}`);
}

/**
 * é¡¯ç¤ºå‚™ä»½ç‹€æ…‹å°è©±æ¡†
 */
function showBackupStatusDialog() {
  // ç²å–ç•¶å‰è¨­å®š
  const userProperties = PropertiesService.getUserProperties();
  const currentSchedule = userProperties.getProperty('backup_schedule') || BACKUP_SETTINGS.DEFAULT_BACKUP_SCHEDULE;
  const currentRetentionDays = userProperties.getProperty('retention_days') || BACKUP_SETTINGS.DEFAULT_RETENTION_DAYS;
  
  // æª¢æŸ¥æ˜¯å¦æœ‰æ´»å‹•çš„å‚™ä»½è§¸ç™¼å™¨
  const hasActiveTrigger = checkActiveBackupTrigger();
  
  // ç²å–å‚™ä»½è³‡æ–™å¤¾ä¸­çš„å‚™ä»½æ•¸é‡
  const backupFolder = getOrCreateBackupFolder();
  const backupFiles = backupFolder.getFiles();
  let backupCount = 0;
  
  while (backupFiles.hasNext()) {
    backupFiles.next();
    backupCount++;
  }
  
  // ç²å–ç•¶å‰è©¦ç®—è¡¨åç¨±
  const spreadsheetName = SpreadsheetApp.getActiveSpreadsheet().getName();
  
  const html = HtmlService.createHtmlOutput(`
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">å‚™ä»½ç³»çµ±ç‹€æ…‹</h2>
      
      <div style="margin: 15px 0;">
        <h3 style="color: #5f6368; font-size: 16px; margin-bottom: 10px;">ç•¶å‰è¨­å®š</h3>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
          <p style="margin: 5px 0;"><strong>å‚™ä»½æ’ç¨‹ï¼š</strong> ${getScheduleDisplayName(currentSchedule)}</p>
          <p style="margin: 5px 0;"><strong>å‚™ä»½ä¿ç•™å¤©æ•¸ï¼š</strong> ${currentRetentionDays} å¤©</p>
          <p style="margin: 5px 0;"><strong>å‚™ä»½ç‹€æ…‹ï¼š</strong> ${hasActiveTrigger ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨'}</p>
        </div>
      </div>
      
      <div style="margin: 15px 0;">
        <h3 style="color: #5f6368; font-size: 16px; margin-bottom: 10px;">å‚™ä»½çµ±è¨ˆ</h3>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
          <p style="margin: 5px 0;"><strong>å‚™ä»½è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆæ•¸ï¼š</strong> ${backupCount}</p>
          <p style="margin: 5px 0;"><strong>ç•¶å‰è©¦ç®—è¡¨åç¨±ï¼š</strong> ${spreadsheetName}</p>
        </div>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="google.script.host.close()" style="background-color: #4285f4; color: white; border: none; 
                padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          é—œé–‰
        </button>
      </div>
    </div>
  `)
  .setWidth(400)
  .setHeight(400);
  
  SpreadsheetApp.getUi().showModalDialog(html, 'å‚™ä»½ç³»çµ±ç‹€æ…‹');
}

/**
 * æª¢æŸ¥æ˜¯å¦æœ‰æ´»å‹•çš„å‚™ä»½è§¸ç™¼å™¨
 * @return {boolean} æ˜¯å¦æœ‰æ´»å‹•çš„å‚™ä»½è§¸ç™¼å™¨
 */
function checkActiveBackupTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  
  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'executeScheduledBackup') {
      return true;
    }
  }
  
  return false;
}

/**
 * ç²å–æ’ç¨‹é¡¯ç¤ºåç¨±
 * @param {string} schedule æ’ç¨‹ä»£ç¢¼
 * @return {string} é¡¯ç¤ºåç¨±
 */
function getScheduleDisplayName(schedule) {
  switch(schedule) {
    case 'daily': return 'æ¯æ—¥';
    case 'weekly': return 'æ¯é€±';
    case 'monthly': return 'æ¯æœˆ';
    default: return schedule;
  }
}

/**
 * å»ºç«‹è‡ªå®šç¾©èœå–®
 */
function createBackupMenu() {
  const ui = SpreadsheetApp.getUi();
  
  const menu = ui.createMenu('ğŸ”§ å‚™ä»½ç³»çµ±')
    .addItem('ç«‹å³å‚™ä»½', 'manualBackup')
    .addItem('å‚™ä»½è¨­å®š', 'showBackupSettingsDialog')
    .addItem('å‚™ä»½ç‹€æ…‹', 'showBackupStatusDialog')
    .addSeparator()
    .addItem('å®‰è£å‚™ä»½è§¸ç™¼å™¨', 'installBackupTriggers')
    .addItem('ç§»é™¤å‚™ä»½è§¸ç™¼å™¨', 'deleteAllBackupTriggers');
    
  menu.addToUi();
}

/**
 * å®‰è£å‡½æ•¸ - åˆæ¬¡è¨­å®šæ™‚åŸ·è¡Œ
 */
function install() {
  // å»ºç«‹è‡ªå®šç¾©èœå–®
  createBackupMenu();
  
  // å®‰è£å‚™ä»½è§¸ç™¼å™¨
  installBackupTriggers();
  
  // å»ºç«‹å‚™ä»½è³‡æ–™å¤¾
  getOrCreateBackupFolder();
  
  // å»ºç«‹æ—¥èªŒè©¦ç®—è¡¨
  getOrCreateLogSpreadsheet();
  
  Logger.log("å‚™ä»½ç³»çµ±å®‰è£å®Œæˆ");
  SpreadsheetApp.getUi().alert("å‚™ä»½ç³»çµ±", "å‚™ä»½ç³»çµ±å·²æˆåŠŸå®‰è£ï¼", SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * ç³»çµ±æ—¥èªŒç®¡ç†
 * è¨˜éŒ„æ‰€æœ‰ç³»çµ±æ“ä½œï¼Œæä¾›çµ±ä¸€æŸ¥è©¢ç•Œé¢
 */

/**
 * å‰µå»ºç³»çµ±æ—¥èªŒè¡¨æ ¼
 */
function createSystemLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("ç³»çµ±æ—¥èªŒ");
  
  if (!sheet) {
    sheet = ss.insertSheet("ç³»çµ±æ—¥èªŒ");
    
    // è¨­å®šè¡¨é ­
    sheet.appendRow([
      "æ™‚é–“æˆ³è¨˜",
      "æ“ä½œé¡å‹", 
      "å€‹æ¡ˆå§“å",
      "æ“ä½œè©³æƒ…",
      "æ“ä½œçµæœ",
      "å¿ƒç†å¸«/è² è²¬äºº",
      "å‚™è¨»"
    ]);
    
    // æ ¼å¼åŒ–è¡¨é ­
    const headerRange = sheet.getRange(1, 1, 1, 7);
    headerRange.setBackground("#4285f4");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    
    // è¨­å®šåˆ—å¯¬
    sheet.setColumnWidth(1, 150); // æ™‚é–“æˆ³è¨˜
    sheet.setColumnWidth(2, 100); // æ“ä½œé¡å‹
    sheet.setColumnWidth(3, 120); // å€‹æ¡ˆå§“å
    sheet.setColumnWidth(4, 250); // æ“ä½œè©³æƒ…
    sheet.setColumnWidth(5, 80);  // æ“ä½œçµæœ
    sheet.setColumnWidth(6, 100); // å¿ƒç†å¸«/è² è²¬äºº
    sheet.setColumnWidth(7, 200); // å‚™è¨»
    
    // å‡çµè¡¨é ­
    sheet.setFrozenRows(1);
    
    Logger.log("ç³»çµ±æ—¥èªŒè¡¨æ ¼å·²å‰µå»º");
  }
  
  return sheet;
}

/**
 * è¨˜éŒ„ç³»çµ±æ´»å‹•
 * @param {string} operationType - æ“ä½œé¡å‹
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} details - æ“ä½œè©³æƒ…
 * @param {string} result - æ“ä½œçµæœ (æˆåŠŸ/å¤±æ•—)
 * @param {string} counselor - å¿ƒç†å¸«/è² è²¬äºº
 * @param {string} notes - å‚™è¨»
 */
function logSystemActivity(operationType, clientName, details, result = 'æˆåŠŸ', counselor = '', notes = '') {
  try {
    const sheet = createSystemLogSheet();
    const timestamp = new Date();
    
    // æ·»åŠ æ—¥èªŒè¨˜éŒ„
    sheet.appendRow([
      timestamp,
      operationType,
      clientName || '',
      details || '',
      result,
      counselor || '',
      notes || ''
    ]);
    
    // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
    if (sheet.getLastRow() > 2) {
      const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 7);
      dataRange.sort({column: 1, ascending: false});
    }
    
  } catch (error) {
    Logger.log("è¨˜éŒ„ç³»çµ±æ—¥èªŒæ™‚å‡ºéŒ¯: " + error.toString());
  }
}

/**
 * ç²å–ç³»çµ±æ—¥èªŒæ•¸æ“š (æ”¯æ´å¤šé¸æ“ä½œé¡å‹ç¯©é¸)
 * @param {string} startDate - é–‹å§‹æ—¥æœŸ (YYYY-MM-DD)
 * @param {string} endDate - çµæŸæ—¥æœŸ (YYYY-MM-DD) 
 * @param {Array} selectedOperationTypes - é¸ä¸­çš„æ“ä½œé¡å‹é™£åˆ—
 * @param {string} clientName - å€‹æ¡ˆå§“åç¯©é¸
 * @param {string} resultFilter - æ“ä½œçµæœç¯©é¸ (æˆåŠŸ/å¤±æ•—/ç©ºå­—ä¸²è¡¨ç¤ºå…¨éƒ¨)
 * @return {Array} æ—¥èªŒæ•¸æ“š
 */
function getSystemLogsWithMultipleTypes(startDate = '', endDate = '', selectedOperationTypes = [], clientName = '', resultFilter = '') {
  try {
    const sheet = createSystemLogSheet();
    
    if (sheet.getLastRow() <= 1) {
      return [];
    }
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 7).getValues();
    
    // ç¯©é¸æ•¸æ“š
    const filteredData = data.filter(row => {
      const timestamp = new Date(row[0]);
      const opType = row[1];
      const client = row[2];
      const result = row[4];
      
      // æ—¥æœŸç¯©é¸
      if (startDate) {
        const start = new Date(startDate);
        if (timestamp < start) return false;
      }
      
      if (endDate) {
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        if (timestamp > end) return false;
      }
      
      // æ“ä½œé¡å‹ç¯©é¸ï¼ˆå¤šé¸ï¼‰
      if (selectedOperationTypes.length > 0 && !selectedOperationTypes.includes(opType)) {
        return false;
      }
      
      // å€‹æ¡ˆå§“åç¯©é¸
      if (clientName && !client.includes(clientName)) {
        return false;
      }
      
      // æ“ä½œçµæœç¯©é¸
      if (resultFilter && result !== resultFilter) {
        return false;
      }
      
      return true;
    });
    
    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
    return filteredData.map(row => ({
      timestamp: Utilities.formatDate(new Date(row[0]), "Asia/Taipei", "yyyy/MM/dd HH:mm:ss"),
      operationType: row[1],
      clientName: row[2],
      details: row[3],
      result: row[4],
      counselor: row[5],
      notes: row[6]
    }));
    
  } catch (error) {
    Logger.log("ç²å–ç³»çµ±æ—¥èªŒæ™‚å‡ºéŒ¯: " + error.toString());
    return [];
  }
}



/**
 * ç²å–æ“ä½œçµ±è¨ˆ (æ”¯æ´å¤šé¸æ“ä½œé¡å‹)
 * @param {string} startDate - é–‹å§‹æ—¥æœŸ
 * @param {string} endDate - çµæŸæ—¥æœŸ
 * @param {Array} selectedOperationTypes - é¸ä¸­çš„æ“ä½œé¡å‹é™£åˆ—
 * @return {Object} çµ±è¨ˆæ•¸æ“š
 */
function getOperationStatisticsWithMultipleTypes(startDate, endDate, selectedOperationTypes = []) {
  try {
    const logs = getSystemLogsWithMultipleTypes(startDate, endDate, selectedOperationTypes, '', '');
    const stats = {};
    
    logs.forEach(log => {
      if (!stats[log.operationType]) {
        stats[log.operationType] = { total: 0, success: 0, failed: 0 };
      }
      
      stats[log.operationType].total++;
      if (log.result === 'æˆåŠŸ') {
        stats[log.operationType].success++;
      } else {
        stats[log.operationType].failed++;
      }
    });
    
    return stats;
  } catch (error) {
    Logger.log("ç²å–æ“ä½œçµ±è¨ˆæ™‚å‡ºéŒ¯: " + error.toString());
    return {};
  }
}

/**
 * å„²å­˜ç¯©é¸è¨­å®š
 */
function saveFilterSettings(settings) {
  try {
    const userProperties = PropertiesService.getUserProperties();
    userProperties.setProperty('logFilterSettings', JSON.stringify(settings));
    return { success: true };
  } catch (error) {
    Logger.log("å„²å­˜ç¯©é¸è¨­å®šæ™‚å‡ºéŒ¯: " + error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * è®€å–ç¯©é¸è¨­å®š
 */
function getFilterSettings() {
  try {
    const userProperties = PropertiesService.getUserProperties();
    const settings = userProperties.getProperty('logFilterSettings');
    return settings ? JSON.parse(settings) : null;
  } catch (error) {
    Logger.log("è®€å–ç¯©é¸è¨­å®šæ™‚å‡ºéŒ¯: " + error.toString());
    return null;
  }
}

/**
 * é¡¯ç¤ºç³»çµ±æ—¥èªŒæŸ¥è©¢å°è©±æ¡†
 */
function showSystemLogDialog() {
  // ç²å–æ“ä½œé¡å‹é¸é …
  const operationTypes = [
    "ç¬¬ä¸€æ¬¡é ç´„",
    "å€‹æ¡ˆçºŒç´„", 
    "ç¹³äº¤ä¿è­‰é‡‘",
    "å–æ¶ˆé ç´„",
    "èª¿æ•´é ç´„æ™‚é–“",
    "èª¿æ•´è«®å•†ç©ºé–“",
    "åœ˜é«”é ç´„",
    "å–æ¶ˆåœ˜é«”",
    "å¾…è¾¦äº‹é …",
    "ç³»çµ±è¨­å®š"
  ];
  
  // ç”Ÿæˆæ“ä½œé¡å‹çš„ checkbox HTML
  var operationCheckboxes = '';
  operationTypes.forEach(function(type) {
    operationCheckboxes += '<div class="form-check">' +
      '<input class="form-check-input" type="checkbox" value="' + type + '" id="op_' + type.replace(/\s+/g, '_') + '" checked>' +
      '<label class="form-check-label" for="op_' + type.replace(/\s+/g, '_') + '">' + type + '</label>' +
      '</div>';
  });
    
  // ç²å–å®¢æˆ¶åå–®
  const clients = getClientList();
  var clientOptions = '';
  clients.forEach(function(client) {
    clientOptions += '<option value="' + client + '">' + client + '</option>';
  });
  
  var html = '<!DOCTYPE html>' +
    '<html>' +
    '<head>' +
    '<base target="_top">' +
    '<meta charset="UTF-8">' +
    '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">' +
    '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">' +
    '<style>' +
    'body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }' +
    '.log-container { max-width: 1400px; margin: 0 auto; }' +
    '.filter-card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }' +
    '.log-table-container { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }' +
    '.table-scroll { max-height: 500px; overflow-y: auto; }' +
    '.table thead th { position: sticky; top: 0; background-color: #4285f4; color: white; z-index: 1; }' +
    '.operation-success { color: #28a745; font-weight: bold; }' +
    '.operation-failed { color: #dc3545; font-weight: bold; }' +
    '.stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; }' +
    '.stats-item { text-align: center; padding: 10px; }' +
    '.stats-number { font-size: 2rem; font-weight: bold; display: block; }' +
    '.stats-label { font-size: 0.9rem; opacity: 0.9; }' +
    '.result-filter-group { border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; background-color: #f8f9fa; }' +
    '.result-filter-group .form-check { margin-bottom: 5px; }' +
    '.result-filter-group .form-check:last-child { margin-bottom: 0; }' +
    '.operation-filter-group { border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; background-color: #f8f9fa; max-height: 200px; overflow-y: auto; }' +
    '.operation-filter-group .form-check { margin-bottom: 3px; }' +
    '.operation-filter-group .form-check:last-child { margin-bottom: 0; }' +
    '.filter-controls { margin-bottom: 10px; }' +
    '.filter-controls button { font-size: 0.8rem; padding: 2px 8px; margin-right: 5px; }' +
    '.filter-header { background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; cursor: pointer; user-select: none; transition: all 0.3s ease; }' +
    '.filter-header:hover { background: linear-gradient(135deg, #3367d6 0%, #2d8f47 100%); }' +
    '.filter-header h5 { margin: 0; display: flex; align-items: center; justify-content: space-between; }' +
    '.collapse-icon { transition: transform 0.3s ease; }' +
    '.collapsed .collapse-icon { transform: rotate(-90deg); }' +
    '.filter-content { padding: 20px; border-radius: 0 0 8px 8px; }' +
    '.quick-actions { background: #f8f9fa; padding: 10px 20px; border-top: 1px solid #dee2e6; border-radius: 0 0 8px 8px; }' +
    '.quick-actions .btn { margin-right: 10px; margin-bottom: 5px; }' +
    '</style>' +
    '</head>' +
    '<body>' +
    '<div class="log-container">' +
    '<h2 class="mb-4"><i class="bi bi-journal-text"></i> ç³»çµ±æ—¥èªŒç®¡ç†</h2>' +
    
    '<div class="stats-card" id="statsCard" style="display: none;">' +
    '<div class="row" id="statsContent"></div>' +
    '</div>' +
    
    '<div class="filter-card">' +
    '<div class="filter-header" onclick="toggleFilterCollapse()" id="filterHeader">' +
    '<h5><span><i class="bi bi-funnel me-2"></i>ç¯©é¸æ¢ä»¶</span>' +
    '<i class="bi bi-chevron-down collapse-icon" id="collapseIcon"></i></h5>' +
    '</div>' +
    
    '<div class="collapse show" id="filterCollapse">' +
    '<div class="filter-content">' +
    '<div class="row g-3">' +
    '<div class="col-md-2">' +
    '<label class="form-label">é–‹å§‹æ—¥æœŸ</label>' +
    '<input type="date" class="form-control" id="startDate">' +
    '</div>' +
    '<div class="col-md-2">' +
    '<label class="form-label">çµæŸæ—¥æœŸ</label>' +
    '<input type="date" class="form-control" id="endDate">' +
    '</div>' +
    '<div class="col-md-3">' +
    '<label class="form-label">æ“ä½œé¡å‹</label>' +
    '<div class="filter-controls">' +
    '<button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllOperations()">å…¨é¸</button>' +
    '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllOperations()">å…¨ä¸é¸</button>' +
    '<button type="button" class="btn btn-outline-info btn-sm" onclick="invertOperationSelection()">åé¸</button>' +
    '</div>' +
    '<div class="operation-filter-group" id="operationTypeGroup">' +
    operationCheckboxes +
    '</div>' +
    '</div>' +
    '<div class="col-md-2">' +
    '<label class="form-label">å€‹æ¡ˆå§“å</label>' +
    '<select class="form-select" id="clientName">' +
    '<option value="">å…¨éƒ¨</option>' +
    clientOptions +
    '</select>' +
    '</div>' +
    '<div class="col-md-2">' +
    '<label class="form-label">æ“ä½œçµæœ</label>' +
    '<div class="result-filter-group">' +
    '<div class="form-check">' +
    '<input class="form-check-input" type="radio" name="resultFilter" id="resultAll" value="">' +
    '<label class="form-check-label" for="resultAll">å…¨éƒ¨</label>' +
    '</div>' +
    '<div class="form-check">' +
    '<input class="form-check-input" type="radio" name="resultFilter" id="resultSuccess" value="æˆåŠŸ" checked>' +
    '<label class="form-check-label" for="resultSuccess">æˆåŠŸ</label>' +
    '</div>' +
    '<div class="form-check">' +
    '<input class="form-check-input" type="radio" name="resultFilter" id="resultFailed" value="å¤±æ•—">' +
    '<label class="form-check-label" for="resultFailed">å¤±æ•—</label>' +
    '</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    '<div class="quick-actions">' +
    '<button class="btn btn-primary" onclick="loadLogs()">' +
    '<i class="bi bi-search"></i> æŸ¥è©¢æ—¥èªŒ</button>' +
    '<button class="btn btn-info" onclick="showStatistics()">' +
    '<i class="bi bi-bar-chart"></i> é¡¯ç¤ºçµ±è¨ˆ</button>' +
    '<button class="btn btn-success" onclick="exportLogs()">' +
    '<i class="bi bi-download"></i> åŒ¯å‡ºæ—¥èªŒ</button>' +
    '<button class="btn btn-secondary" onclick="resetFilters()">' +
    '<i class="bi bi-arrow-counterclockwise"></i> é‡ç½®ç¯©é¸</button>' +
    '<button class="btn btn-warning" onclick="toggleFilterCollapse()">' +
    '<i class="bi bi-eye-slash"></i> æ”¶èµ·ç¯©é¸</button>' +
    '</div>' +
    '</div>' +
    '</div>' +
    
    '<div class="log-table-container">' +
    '<div class="table-scroll">' +
    '<table class="table table-hover mb-0" id="logTable">' +
    '<thead>' +
    '<tr>' +
    '<th style="width: 15%">æ™‚é–“</th>' +
    '<th style="width: 12%">æ“ä½œé¡å‹</th>' +
    '<th style="width: 12%">å€‹æ¡ˆå§“å</th>' +
    '<th style="width: 30%">æ“ä½œè©³æƒ…</th>' +
    '<th style="width: 8%">çµæœ</th>' +
    '<th style="width: 12%">è² è²¬äºº</th>' +
    '<th style="width: 11%">å‚™è¨»</th>' +
    '</tr>' +
    '</thead>' +
    '<tbody id="logTableBody">' +
    '<tr><td colspan="7" class="text-center">' +
    '<div class="p-4">' +
    '<i class="bi bi-journal-x" style="font-size: 3rem; color: #6c757d;"></i>' +
    '<p class="mt-2 text-muted">è«‹é¸æ“‡æŸ¥è©¢æ¢ä»¶ä¸¦é»æ“Šã€ŒæŸ¥è©¢æ—¥èªŒã€</p>' +
    '</div>' +
    '</td></tr>' +
    '</tbody>' +
    '</table>' +
    '</div>' +
    '</div>' +
    
    '<div id="loadingIndicator" style="display: none;">' +
    '<div class="d-flex justify-content-center p-4">' +
    '<div class="spinner-border text-primary" role="status">' +
    '<span class="visually-hidden">è¼‰å…¥ä¸­...</span>' +
    '</div>' +
    '</div>' +
    '</div>' +
    '</div>';

  html += '<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>' +
    '<script>' +
    'function saveCurrentFilters() {' +
    '  const settings = {' +
    '    startDate: document.getElementById("startDate").value,' +
    '    endDate: document.getElementById("endDate").value,' +
    '    clientName: document.getElementById("clientName").value,' +
    '    resultFilter: document.querySelector("input[name=\'resultFilter\']:checked").value,' +
    '    operationTypes: getSelectedOperationTypes(),' +
    '    isFilterCollapsed: !document.getElementById("filterCollapse").classList.contains("show")' +
    '  };' +
    '  google.script.run' +
    '    .withSuccessHandler(function(result) {' +
    '      if (!result.success) {' +
    '        console.error("å„²å­˜ç¯©é¸è¨­å®šå¤±æ•—:", result.error);' +
    '      }' +
    '    })' +
    '    .saveFilterSettings(settings);' +
    '}' +
    
    'function loadSavedFilters() {' +
    '  google.script.run' +
    '    .withSuccessHandler(function(settings) {' +
    '      if (settings) {' +
    '        if (settings.startDate) document.getElementById("startDate").value = settings.startDate;' +
    '        if (settings.endDate) document.getElementById("endDate").value = settings.endDate;' +
    '        if (settings.clientName) document.getElementById("clientName").value = settings.clientName;' +
    '        if (settings.resultFilter) {' +
    '          const radio = document.querySelector("input[name=\'resultFilter\'][value=\'" + settings.resultFilter + "\']");' +
    '          if (radio) radio.checked = true;' +
    '        }' +
    '        if (settings.operationTypes) {' +
    '          const checkboxes = document.querySelectorAll("#operationTypeGroup input[type=\'checkbox\']");' +
    '          checkboxes.forEach(function(checkbox) {' +
    '            checkbox.checked = settings.operationTypes.includes(checkbox.value);' +
    '          });' +
    '        }' +
    '        if (settings.isFilterCollapsed) {' +
    '          toggleFilterCollapse();' +
    '        }' +
    '        loadLogs();' +
    '      }' +
    '    })' +
    '    .getFilterSettings();' +
    '}' +

    'function loadLogs() {' +
    '  const startDate = document.getElementById("startDate").value;' +
    '  const endDate = document.getElementById("endDate").value;' +
    '  const selectedOperationTypes = getSelectedOperationTypes();' +
    '  const clientName = document.getElementById("clientName").value;' +
    '  const resultFilter = document.querySelector("input[name=\'resultFilter\']:checked").value;' +
    '  showLoading(true);' +
    '  google.script.run' +
    '    .withSuccessHandler(function(logs) {' +
    '      displayLogs(logs);' +
    '      showLoading(false);' +
    '      saveCurrentFilters();' +
    '    })' +
    '    .withFailureHandler(function(error) {' +
    '      console.error("è¼‰å…¥æ—¥èªŒå¤±æ•—:", error);' +
    '      showLoading(false);' +
    '      alert("è¼‰å…¥æ—¥èªŒæ™‚ç™¼ç”ŸéŒ¯èª¤: " + error);' +
    '    })' +
    '    .getSystemLogsWithMultipleTypes(startDate, endDate, selectedOperationTypes, clientName, resultFilter);' +
    '}' +

    'function displayLogs(logs) {' +
    '  const tbody = document.getElementById("logTableBody");' +
    '  tbody.innerHTML = "";' +
    '  if (logs.length === 0) {' +
    '    tbody.innerHTML = "<tr><td colspan=\'7\' class=\'text-center p-4 text-muted\'>æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„æ—¥èªŒè¨˜éŒ„</td></tr>";' +
    '    return;' +
    '  }' +
    '  logs.forEach(function(log) {' +
    '    const row = document.createElement("tr");' +
    '    const resultClass = log.result === "æˆåŠŸ" ? "operation-success" : "operation-failed";' +
    '    row.innerHTML = "<td>" + log.timestamp + "</td>" +' +
    '      "<td><span class=\'badge bg-primary\'>" + log.operationType + "</span></td>" +' +
    '      "<td>" + log.clientName + "</td>" +' +
    '      "<td>" + log.details + "</td>" +' +
    '      "<td><span class=\'" + resultClass + "\'>" + log.result + "</span></td>" +' +
    '      "<td>" + log.counselor + "</td>" +' +
    '      "<td>" + log.notes + "</td>";' +
    '    tbody.appendChild(row);' +
    '  });' +
    '}' +

    'function showStatistics() {' +
    '  const startDate = document.getElementById("startDate").value;' +
    '  const endDate = document.getElementById("endDate").value;' +
    '  const selectedOperationTypes = getSelectedOperationTypes();' +
    '  google.script.run' +
    '    .withSuccessHandler(function(stats) {' +
    '      displayStatistics(stats);' +
    '    })' +
    '    .withFailureHandler(function(error) {' +
    '      console.error("è¼‰å…¥çµ±è¨ˆå¤±æ•—:", error);' +
    '      alert("è¼‰å…¥çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: " + error);' +
    '    })' +
    '    .getOperationStatisticsWithMultipleTypes(startDate, endDate, selectedOperationTypes);' +
    '}' +

    'function displayStatistics(stats) {' +
    '  const statsCard = document.getElementById("statsCard");' +
    '  const statsContent = document.getElementById("statsContent");' +
    '  if (Object.keys(stats).length === 0) {' +
    '    statsCard.style.display = "none";' +
    '    return;' +
    '  }' +
    '  let totalOperations = 0;' +
    '  let totalSuccess = 0;' +
    '  let totalFailed = 0;' +
    '  let statsHtml = "";' +
    '  Object.keys(stats).forEach(function(type) {' +
    '    const stat = stats[type];' +
    '    totalOperations += stat.total;' +
    '    totalSuccess += stat.success;' +
    '    totalFailed += stat.failed;' +
    '    const successRate = ((stat.success / stat.total) * 100).toFixed(1);' +
    '    statsHtml += "<div class=\'col-md-4 col-lg-3\'>" +' +
    '      "<div class=\'stats-item\'>" +' +
    '      "<span class=\'stats-number\'>" + stat.total + "</span>" +' +
    '      "<div class=\'stats-label\'>" + type + "</div>" +' +
    '      "<small>æˆåŠŸç‡: " + successRate + "%</small>" +' +
    '      "</div>" +' +
    '      "</div>";' +
    '  });' +
    '  const overallSuccessRate = totalOperations > 0 ? ((totalSuccess / totalOperations) * 100).toFixed(1) : 0;' +
    '  statsHtml = "<div class=\'col-md-4 col-lg-3\'>" +' +
    '    "<div class=\'stats-item\'>" +' +
    '    "<span class=\'stats-number\'>" + totalOperations + "</span>" +' +
    '    "<div class=\'stats-label\'>ç¸½æ“ä½œæ•¸</div>" +' +
    '    "<small>æˆåŠŸç‡: " + overallSuccessRate + "%</small>" +' +
    '    "</div>" +' +
    '    "</div>" + statsHtml;' +
    '  statsContent.innerHTML = statsHtml;' +
    '  statsCard.style.display = "block";' +
    '}' +

    'function resetFilters() {' +
    '  document.getElementById("startDate").value = "";' +
    '  document.getElementById("endDate").value = "";' +
    '  document.getElementById("clientName").selectedIndex = 0;' +
    '  selectAllOperations();' +
    '  document.getElementById("resultSuccess").checked = true;' +
    '  document.getElementById("statsCard").style.display = "none";' +
    '  const tbody = document.getElementById("logTableBody");' +
    '  tbody.innerHTML = "<tr><td colspan=\'7\' class=\'text-center p-4 text-muted\'>è«‹é¸æ“‡æŸ¥è©¢æ¢ä»¶ä¸¦é»æ“Šã€ŒæŸ¥è©¢æ—¥èªŒã€</td></tr>";' +
    '  saveCurrentFilters();' +
    '}' +

    'function selectAllOperations() {' +
    '  const checkboxes = document.querySelectorAll("#operationTypeGroup input[type=\'checkbox\']");' +
    '  checkboxes.forEach(function(checkbox) { checkbox.checked = true; });' +
    '  saveCurrentFilters();' +
    '}' +

    'function deselectAllOperations() {' +
    '  const checkboxes = document.querySelectorAll("#operationTypeGroup input[type=\'checkbox\']");' +
    '  checkboxes.forEach(function(checkbox) { checkbox.checked = false; });' +
    '  saveCurrentFilters();' +
    '}' +

    'function invertOperationSelection() {' +
    '  const checkboxes = document.querySelectorAll("#operationTypeGroup input[type=\'checkbox\']");' +
    '  checkboxes.forEach(function(checkbox) { checkbox.checked = !checkbox.checked; });' +
    '  saveCurrentFilters();' +
    '}' +

    'function getSelectedOperationTypes() {' +
    '  const checkboxes = document.querySelectorAll("#operationTypeGroup input[type=\'checkbox\']:checked");' +
    '  return Array.from(checkboxes).map(function(checkbox) { return checkbox.value; });' +
    '}' +

    'function toggleFilterCollapse() {' +
    '  const filterCollapse = document.getElementById("filterCollapse");' +
    '  const filterHeader = document.getElementById("filterHeader");' +
    '  const collapseIcon = document.getElementById("collapseIcon");' +
    '  const warningBtn = document.querySelector(".btn-warning");' +
    '  if (filterCollapse.classList.contains("show")) {' +
    '    filterCollapse.classList.remove("show");' +
    '    filterHeader.classList.add("collapsed");' +
    '    collapseIcon.classList.remove("bi-chevron-down");' +
    '    collapseIcon.classList.add("bi-chevron-right");' +
    '    if (warningBtn) {' +
    '      warningBtn.innerHTML = "<i class=\'bi bi-eye\'></i> å±•é–‹ç¯©é¸";' +
    '    }' +
    '  } else {' +
    '    filterCollapse.classList.add("show");' +
    '    filterHeader.classList.remove("collapsed");' +
    '    collapseIcon.classList.remove("bi-chevron-right");' +
    '    collapseIcon.classList.add("bi-chevron-down");' +
    '    if (warningBtn) {' +
    '      warningBtn.innerHTML = "<i class=\'bi bi-eye-slash\'></i> æ”¶èµ·ç¯©é¸";' +
    '    }' +
    '  }' +
    '  saveCurrentFilters();' +
    '}' +

    'function showLoading(show) {' +
    '  document.getElementById("loadingIndicator").style.display = show ? "block" : "none";' +
    '  document.getElementById("logTable").style.display = show ? "none" : "table";' +
    '}' +

    'document.addEventListener("DOMContentLoaded", function() {' +
    '  loadSavedFilters();' +
    '});' +
    '</script>' +
    '</body>' +
    '</html>';

  const ui = HtmlService.createHtmlOutput(html)
    .setWidth(1400)
    .setHeight(800);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ç³»çµ±æ—¥èªŒç®¡ç†');
}


/**
 * åŒ¯å‡ºç³»çµ±æ—¥èªŒ (æ”¯æ´å¤šé¸æ“ä½œé¡å‹)
 * @param {string} startDate - é–‹å§‹æ—¥æœŸ
 * @param {string} endDate - çµæŸæ—¥æœŸ  
 * @param {Array} selectedOperationTypes - é¸ä¸­çš„æ“ä½œé¡å‹é™£åˆ—
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {string} resultFilter - æ“ä½œçµæœç¯©é¸
 * @return {string} åŒ¯å‡ºæª”æ¡ˆçš„URL
 */
function exportSystemLogsWithMultipleTypes(startDate, endDate, selectedOperationTypes, clientName, resultFilter) {
  try {
    // ç²å–æ—¥èªŒæ•¸æ“š
    const logs = getSystemLogsWithMultipleTypes(startDate, endDate, selectedOperationTypes, clientName, resultFilter);
    
    if (logs.length === 0) {
      SpreadsheetApp.getUi().alert("æ²’æœ‰å¯åŒ¯å‡ºçš„æ—¥èªŒè¨˜éŒ„");
      return null;
    }
    
    // å‰µå»ºæ–°çš„è©¦ç®—è¡¨
    const exportSpreadsheet = SpreadsheetApp.create("ç³»çµ±æ—¥èªŒåŒ¯å‡º_" + Utilities.formatDate(new Date(), "Asia/Taipei", "yyyyMMdd_HHmmss"));
    const exportSheet = exportSpreadsheet.getActiveSheet();
    exportSheet.setName("ç³»çµ±æ—¥èªŒ");
    
    // è¨­å®šè¡¨é ­
    const headers = ["æ™‚é–“", "æ“ä½œé¡å‹", "å€‹æ¡ˆå§“å", "æ“ä½œè©³æƒ…", "æ“ä½œçµæœ", "è² è²¬äºº", "å‚™è¨»"];
    exportSheet.appendRow(headers);
    
    // æ ¼å¼åŒ–è¡¨é ­
    const headerRange = exportSheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground("#4285f4");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    
    // æ·»åŠ æ•¸æ“š
    logs.forEach(log => {
      exportSheet.appendRow([
        log.timestamp,
        log.operationType,
        log.clientName,
        log.details,
        log.result,
        log.counselor,
        log.notes
      ]);
    });
    
    // è‡ªå‹•èª¿æ•´åˆ—å¯¬
    exportSheet.autoResizeColumns(1, headers.length);
    
    // æ·»åŠ ç¯©é¸æ¢ä»¶èªªæ˜
    exportSheet.appendRow([]);
    exportSheet.appendRow(["ç¯©é¸æ¢ä»¶:", "", "", "", "", "", ""]);
    exportSheet.appendRow(["é–‹å§‹æ—¥æœŸ:", startDate || "ç„¡é™åˆ¶", "", "", "", "", ""]);
    exportSheet.appendRow(["çµæŸæ—¥æœŸ:", endDate || "ç„¡é™åˆ¶", "", "", "", "", ""]);
    exportSheet.appendRow(["æ“ä½œé¡å‹:", selectedOperationTypes.length > 0 ? selectedOperationTypes.join(', ') : "å…¨éƒ¨", "", "", "", "", ""]);
    exportSheet.appendRow(["å€‹æ¡ˆå§“å:", clientName || "å…¨éƒ¨", "", "", "", "", ""]);
    exportSheet.appendRow(["æ“ä½œçµæœ:", resultFilter || "å…¨éƒ¨", "", "", "", "", ""]);
    
    return exportSpreadsheet.getUrl();
  } catch (error) {
    Logger.log("åŒ¯å‡ºç³»çµ±æ—¥èªŒæ™‚å‡ºéŒ¯: " + error.toString());
    throw error;
  }
}

/**
 * é¡¯ç¤ºä»Šæ—¥æ´»å‹•æ‘˜è¦
 */
function showTodayActivitySummary() {
  const today = Utilities.formatDate(new Date(), "Asia/Taipei", "yyyy-MM-dd");
  const logs = getSystemLogs(today, today);
  
  if (logs.length === 0) {
    SpreadsheetApp.getUi().alert("ä»Šæ—¥æ´»å‹•æ‘˜è¦", "ä»Šæ—¥å°šç„¡ç³»çµ±æ´»å‹•è¨˜éŒ„", SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  
  // çµ±è¨ˆä»Šæ—¥æ´»å‹•
  const summary = {};
  logs.forEach(log => {
    const type = log.operationType;
    if (!summary[type]) {
      summary[type] = { count: 0, clients: [] };
    }
    summary[type].count++;
    if (log.clientName && !summary[type].clients.includes(log.clientName)) {
      summary[type].clients.push(log.clientName);
    }
  });
  
  // ç”Ÿæˆæ‘˜è¦å…§å®¹
  let summaryHtml = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">ğŸ“… ä»Šæ—¥æ´»å‹•æ‘˜è¦ (${today})</h2>
      <div style="margin: 20px 0;">
  `;
  
  Object.keys(summary).forEach(type => {
    const data = summary[type];
    summaryHtml += `
      <div style="margin: 15px 0; padding: 15px; border-left: 4px solid #4285f4; background-color: #f8f9fa;">
        <h3 style="margin: 0 0 10px 0; color: #333;">${type}</h3>
        <p style="margin: 5px 0;"><strong>æ“ä½œæ¬¡æ•¸ï¼š</strong>${data.count} æ¬¡</p>
        ${data.clients.length > 0 ? `<p style="margin: 5px 0;"><strong>æ¶‰åŠå€‹æ¡ˆï¼š</strong>${data.clients.join(', ')}</p>` : ''}
      </div>
    `;
  });
  
  summaryHtml += `
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="google.script.host.close()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          é—œé–‰
        </button>
      </div>
    </div>
  `;
  
  const ui = HtmlService.createHtmlOutput(summaryHtml)
    .setWidth(500)
    .setHeight(400);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'ä»Šæ—¥æ´»å‹•æ‘˜è¦');
}

/**
 * é¡¯ç¤ºæ“ä½œçµ±è¨ˆå ±è¡¨å°è©±æ¡†
 */
function showOperationStatisticsDialog() {
  const html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #4285f4;">ğŸ“Š æ“ä½œçµ±è¨ˆå ±è¡¨</h2>
      
      <div style="margin: 15px 0;">
        <label style="font-weight: bold;">çµ±è¨ˆæœŸé–“ï¼š</label><br>
        <input type="date" id="statsStartDate" style="width: 45%; padding: 8px; margin: 5px 2% 5px 0; border: 1px solid #ddd; border-radius: 4px;">
        <input type="date" id="statsEndDate" style="width: 45%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="generateStatistics()" style="background-color: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">
          ç”Ÿæˆçµ±è¨ˆå ±è¡¨
        </button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          é—œé–‰
        </button>
      </div>
      
      <div id="statisticsResult" style="margin-top: 20px;"></div>
    </div>
    
    <script>
      // é é¢è¼‰å…¥æ™‚è¨­å®šé è¨­æ—¥æœŸï¼ˆæœ¬æœˆï¼‰
      document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('statsStartDate').value = formatDate(firstDay);
        document.getElementById('statsEndDate').value = formatDate(today);
      });
      
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      }
      
      function generateStatistics() {
        const startDate = document.getElementById('statsStartDate').value;
        const endDate = document.getElementById('statsEndDate').value;
        
        if (!startDate || !endDate) {
          alert('è«‹é¸æ“‡çµ±è¨ˆæœŸé–“');
          return;
        }
        
        google.script.run
          .withSuccessHandler(function(stats) {
            displayStatisticsResult(stats, startDate, endDate);
          })
          .withFailureHandler(function(error) {
            alert('ç”Ÿæˆçµ±è¨ˆå ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error);
          })
          .getOperationStatistics(startDate, endDate);
      }
      
      function displayStatisticsResult(stats, startDate, endDate) {
        const resultDiv = document.getElementById('statisticsResult');
        
        if (Object.keys(stats).length === 0) {
          resultDiv.innerHTML = '<p style="text-align: center; color: #666;">è©²æœŸé–“å…§ç„¡æ“ä½œè¨˜éŒ„</p>';
          return;
        }
        
        let html = \`<h3 style="color: #4285f4;">çµ±è¨ˆæœŸé–“ï¼š\${startDate} è‡³ \${endDate}</h3>\`;
        html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
        html += '<thead><tr style="background-color: #f8f9fa;"><th style="border: 1px solid #ddd; padding: 10px;">æ“ä½œé¡å‹</th><th style="border: 1px solid #ddd; padding: 10px;">ç¸½æ¬¡æ•¸</th><th style="border: 1px solid #ddd; padding: 10px;">æˆåŠŸæ¬¡æ•¸</th><th style="border: 1px solid #ddd; padding: 10px;">å¤±æ•—æ¬¡æ•¸</th><th style="border: 1px solid #ddd; padding: 10px;">æˆåŠŸç‡</th></tr></thead>';
        html += '<tbody>';
        
        let totalOps = 0, totalSuccess = 0, totalFailed = 0;
        
        Object.keys(stats).forEach(type => {
          const stat = stats[type];
          const successRate = ((stat.success / stat.total) * 100).toFixed(1);
          
          totalOps += stat.total;
          totalSuccess += stat.success;
          totalFailed += stat.failed;
          
          html += \`<tr>
            <td style="border: 1px solid #ddd; padding: 8px;">\${type}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">\${stat.total}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #28a745;">\${stat.success}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #dc3545;">\${stat.failed}</td>
            <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">\${successRate}%</td>
          </tr>\`;
        });
        
        // æ·»åŠ ç¸½è¨ˆè¡Œ
        const overallSuccessRate = ((totalSuccess / totalOps) * 100).toFixed(1);
        html += \`<tr style="background-color: #e9ecef; font-weight: bold;">
          <td style="border: 1px solid #ddd; padding: 8px;">ç¸½è¨ˆ</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">\${totalOps}</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #28a745;">\${totalSuccess}</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #dc3545;">\${totalFailed}</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">\${overallSuccessRate}%</td>
        </tr>\`;
        
        html += '</tbody></table>';
        
        resultDiv.innerHTML = html;
      }
    </script>
  `;
  
  const ui = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(500);
    
  SpreadsheetApp.getUi().showModalDialog(ui, 'æ“ä½œçµ±è¨ˆå ±è¡¨');
}

/**
 * åˆå§‹åŒ–æ—¥èªŒç³»çµ±
 */
function initializeLogSystem() {
  try {
    // å‰µå»ºç³»çµ±æ—¥èªŒè¡¨æ ¼
    createSystemLogSheet();
    
    // è¨˜éŒ„ç³»çµ±åˆå§‹åŒ–æ—¥èªŒ
    logSystemActivity(
      "ç³»çµ±è¨­å®š",
      "",
      "æ—¥èªŒç³»çµ±åˆå§‹åŒ–å®Œæˆ",
      "æˆåŠŸ",
      "",
      "ç³»çµ±æ—¥èªŒè¡¨æ ¼å·²å‰µå»º"
    );
    
    SpreadsheetApp.getUi().alert("åˆå§‹åŒ–å®Œæˆ", "æ—¥èªŒç³»çµ±å·²æˆåŠŸåˆå§‹åŒ–ï¼", SpreadsheetApp.getUi().ButtonSet.OK);
    Logger.log("æ—¥èªŒç³»çµ±åˆå§‹åŒ–å®Œæˆ");
    
  } catch (error) {
    Logger.log("åˆå§‹åŒ–æ—¥èªŒç³»çµ±æ™‚å‡ºéŒ¯: " + error.toString());
    SpreadsheetApp.getUi().alert("åˆå§‹åŒ–å¤±æ•—", "æ—¥èªŒç³»çµ±åˆå§‹åŒ–å¤±æ•—: " + error.toString(), SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

/**
 * æ¸…ç†èˆŠæ—¥èªŒè¨˜éŒ„
 * @param {number} daysToKeep - ä¿ç•™å¤©æ•¸ï¼Œé è¨­90å¤©
 */
function cleanupOldLogs(daysToKeep = 90) {
  try {
    const sheet = createSystemLogSheet();
    
    if (sheet.getLastRow() <= 1) {
      return 0;
    }
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
    
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 7).getValues();
    let deletedCount = 0;
    
    // å¾å¾Œå¾€å‰åˆªé™¤èˆŠè¨˜éŒ„
    for (let i = data.length - 1; i >= 0; i--) {
      const logDate = new Date(data[i][0]);
      if (logDate < cutoffDate) {
        sheet.deleteRow(i + 2);
        deletedCount++;
      }
    }
    
    // è¨˜éŒ„æ¸…ç†æ“ä½œ
    if (deletedCount > 0) {
      logSystemActivity(
        "ç³»çµ±è¨­å®š",
        "",
        `æ¸…ç†èˆŠæ—¥èªŒè¨˜éŒ„ï¼Œåˆªé™¤${deletedCount}ç­†è¨˜éŒ„`,
        "æˆåŠŸ",
        "",
        `ä¿ç•™æœ€è¿‘${daysToKeep}å¤©çš„è¨˜éŒ„`
      );
    }
    
    Logger.log(`å·²æ¸…ç† ${deletedCount} ç­†èˆŠæ—¥èªŒè¨˜éŒ„`);
    return deletedCount;
    
  } catch (error) {
    Logger.log("æ¸…ç†èˆŠæ—¥èªŒè¨˜éŒ„æ™‚å‡ºéŒ¯: " + error.toString());
    throw error;
  }
}

/**
 * è‡ªå‹•æ–°å¢å°å¹«æ‰‹å¾…è¾¦äº‹é …
 * @param {string} operationType - æ“ä½œé¡å‹
 * @param {string} clientName - å€‹æ¡ˆå§“å
 * @param {Object} appointmentDetails - é ç´„è©³æƒ…
 */
function createHelperTodoItem(operationType, clientName, appointmentDetails) {
  try {
    // 1. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå¾…è¾¦ï¼ˆé˜²é‡è¤‡ï¼‰
    if (isDuplicateTodo(clientName, operationType, appointmentDetails)) {
      console.log(`å·²å­˜åœ¨ç›¸åŒå¾…è¾¦ï¼Œè·³éæ–°å¢ï¼š${clientName} - ${operationType}`);
      return;
    }

    // 2. çµ„ç¹”å‚™è¨»å…§å®¹
    const notes = formatTodoNotes(operationType, appointmentDetails);

    // 3. å»ºç«‹å¾…è¾¦é …ç›®
    const todoItem = {
      clientName: clientName,
      status: "å°å¹«æ‰‹å¾…ç¢ºå®š",
      notes: notes,
      deadline: "", // ç•™ç©º
      priority: "ä½", // çµ±ä¸€ä½å„ªå…ˆç´š
      assignedTo: "å°å¹«æ‰‹",
      createdDate: new Date().toISOString().split('T')[0],
      operationType: operationType, // ç”¨æ–¼é‡è¤‡æª¢æŸ¥
      appointmentDateTime: `${appointmentDetails.date} ${appointmentDetails.time}` // ç”¨æ–¼é‡è¤‡æª¢æŸ¥
    };

    // 4. æ–°å¢åˆ° viewClientTodos ç³»çµ±
    addTodoToSystem(todoItem);
    
    console.log(`âœ… å·²æ–°å¢å°å¹«æ‰‹å¾…è¾¦ï¼š${clientName} - ${operationType}`);
    
  } catch (error) {
    console.error('æ–°å¢å°å¹«æ‰‹å¾…è¾¦å¤±æ•—:', error);
  }
}

/**
 * æª¢æŸ¥æ˜¯å¦ç‚ºé‡è¤‡å¾…è¾¦
 */
function isDuplicateTodo(clientName, operationType, appointmentDetails) {
  try {
    const appointmentDateTime = `${appointmentDetails.date} ${appointmentDetails.time}`;
    
    // å¾ç¾æœ‰å¾…è¾¦ç³»çµ±ä¸­æŸ¥è©¢
    const existingTodos = getClientTodos();
    
    return existingTodos.some(todo => 
      todo.clientName === clientName &&
      todo.status === "å°å¹«æ‰‹å¾…ç¢ºå®š" &&
      todo.notes.includes(operationType) &&
      todo.notes.includes(appointmentDetails.date)
    );
  } catch (error) {
    Logger.log(`æª¢æŸ¥é‡è¤‡å¾…è¾¦æ™‚å‡ºéŒ¯ï¼š${error.toString()}`);
    return false; // å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œå…è¨±æ–°å¢
  }
}

function formatTodoNotes(operationType, appointmentDetails) {
  let notes = `æ“ä½œé¡å‹ï¼š${operationType}\n\n`;
  
  // ç¢ºä¿æ­£ç¢ºå–å¾—å€‹æ¡ˆåç¨±
  const clientName = appointmentDetails.clientName || appointmentDetails.name || 'æœªçŸ¥å€‹æ¡ˆ';
  
  // ç²å–å€‹æ¡ˆæ­·å²è¨˜éŒ„
  const clientHistory = getClientServiceHistory(clientName);
  const serviceType = appointmentDetails.serviceType || 'æœªçŸ¥æœå‹™';
  const currentServiceCount = clientHistory[serviceType] || 1;
  
  // æ ¼å¼åŒ–æ¨™é¡Œ
  notes += `ï¼ˆ${serviceType} ${currentServiceCount}ï¼‰${clientName}ï¼ˆ${appointmentDetails.therapist}ï¼‰- ${appointmentDetails.room}\n`;
  
  // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
  if (appointmentDetails.date) {
    const appointmentDate = new Date(appointmentDetails.date);
    const formattedDate = formatDateWithWeekday(appointmentDate);
    notes += `${formattedDate}â‹…${appointmentDetails.time}\n`;
  }
  
  // è©³ç´°è³‡è¨Š
  notes += `æœå‹™æ–¹æ¡ˆ: ${serviceType}\n`;
  notes += `è«®å•†å¸«: ${appointmentDetails.therapist}\n`;
  notes += `è«®å•†å®¤: ${appointmentDetails.room}\n\n`;
  
  // å€‹æ¡ˆæ­·å²è¨˜éŒ„
  notes += `å€‹æ¡ˆæ­·å²æœå‹™è¨˜éŒ„ï¼š\n`;
  if (Object.keys(clientHistory).length > 0) {
    for (const [type, count] of Object.entries(clientHistory)) {
      notes += `${type}: ${count}æ¬¡\n`;
    }
  } else {
    notes += `æš«ç„¡æ­·å²è¨˜éŒ„\n`;
  }
  
  return notes;
}



/**
 * æ–°å¢å¾…è¾¦åˆ°ç³»çµ±
 */
function addTodoToSystem(todoItem) {
  try {
    // ä½¿ç”¨æ‚¨ç¾æœ‰çš„ addClientTodo å‡½æ•¸
    const formData = {
      clientName: todoItem.clientName,
      status: todoItem.status,
      notes: todoItem.notes,
      deadline: todoItem.deadline,
      priority: todoItem.priority,
      assignedTo: todoItem.assignedTo
    };
    
    const result = addClientTodo(formData);
    
    if (result.success) {
      Logger.log(`æˆåŠŸæ–°å¢å°å¹«æ‰‹å¾…è¾¦ï¼š${todoItem.clientName}`);
    } else {
      Logger.log(`æ–°å¢å°å¹«æ‰‹å¾…è¾¦å¤±æ•—ï¼š${result.message}`);
    }
    
    return result;
  } catch (error) {
    Logger.log(`æ–°å¢å°å¹«æ‰‹å¾…è¾¦æ™‚å‡ºéŒ¯ï¼š${error.toString()}`);
    return { success: false, message: error.toString() };
  }
}

/**
 * ç²å–ç¾æœ‰å¾…è¾¦æ¸…å–®
 */
function getClientTodos() {
  try {
    const data = getTodoData();
    return formatTodoData(data);
  } catch (error) {
    Logger.log(`ç²å–å¾…è¾¦æ¸…å–®æ™‚å‡ºéŒ¯ï¼š${error.toString()}`);
    return [];
  }
}

/**
 * æ“ä½œé¡å‹å°æ‡‰è¡¨
 */
const OPERATION_TYPES = {
  FIRST_APPOINTMENT: "é ç´„æª¢æ ¸",
  RENEWAL: "çºŒç´„æª¢æ ¸", 
  GROUP_RESERVATION: "åœ˜é«”æª¢æ ¸",
  DEPOSIT_PAYMENT: "é‡‘æµæª¢æ ¸",
  CANCELLATION: "å–æ¶ˆæª¢æ ¸"
};

/**
 * é¡¯ç¤ºé ç´„è¬›åº§å°è©±æ¡† (å…¨æ–°ä»‹é¢ç‰ˆ)
 */
function showWorkshopReservationDialog() {
  const counselors = getCounselorList();
  const counselorOptions = counselors.map(counselor => `<option value="${counselor}">${counselor}</option>`).join('');
  
  var html = `
    <div style="padding: 20px; font-family: Arial, sans-serif;">
      <h2 style="color: #8E44AD;">é ç´„è¬›åº§</h2>
      <p style="font-size: 14px; color: #666;">è«‹å¡«å¯«ä»¥ä¸‹è¬›åº§è³‡è¨Šï¼Œæ‰€æœ‰æ¬„ä½çš†ç‚ºé¸å¡«ã€‚</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="font-weight: bold;">å–®ä½ï¼š</label>
          <input type="text" id="unitName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-weight: bold;">è¬›è€…ï¼š</label>
          <select id="speaker" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">è«‹é¸æ“‡è¬›è€…</option>
            ${counselorOptions}
          </select>
        </div>
        <div>
          <label style="font-weight: bold;">è¯ç¹«çª—å£ï¼š</label>
          <input type="text" id="contactPerson" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-weight: bold;">è¯ç¹«é›»è©±ï¼š</label>
          <input type="text" id="contactPhone" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-weight: bold;">é˜é»è²»ï¼š</label>
          <input type="text" id="hourlyFee" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div>
          <label style="font-weight: bold;">å…¶ä»–è£œåŠ©è²»ç”¨ï¼š</label>
          <input type="text" id="otherFees" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
      </div>

      <div style="margin-top: 15px;">
        <label style="font-weight: bold;">å‚™è¨»ï¼š</label>
        <textarea id="notes" style="width: 100%; height: 60px; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
      </div>
      
      <div id="sessionsContainer">
        <h3 style="color: #8E44AD; margin-top: 20px;">è¬›åº§å ´æ¬¡</h3>
        <div id="sessionsList">
          </div>
        <div style="margin: 15px 0; text-align: center;">
          <button onclick="addNewSession()" style="background-color: #34a853; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">+ æ–°å¢å ´æ¬¡</button>
        </div>
      </div>
      
      <div style="margin: 20px 0; text-align: center;">
        <button onclick="submitWorkshopReservation()" style="background-color: #8E44AD; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç¢ºèªé ç´„</button>
        <button onclick="google.script.host.close()" style="background-color: #f1f1f1; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
      </div>
      <div id="message" style="margin-top: 15px; padding: 10px; display: none; border-radius: 4px;"></div>
      
      ${generateLoadingIndicatorHTML()}
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() { addNewSession(); });

      function addNewSession() {
        const list = document.getElementById('sessionsList');
        const sessionItem = document.createElement('div');
        sessionItem.className = 'session-item';
        sessionItem.style = 'border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 10px; position: relative;';
        sessionItem.innerHTML = \`
          <button onclick="this.parentElement.remove()" style="position: absolute; top: 5px; right: 5px; background-color: #db4437; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1;">Ã—</button>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>æ—¥æœŸï¼š</label><input type="date" class="session-date" style="width: 100%; padding: 8px;"></div>
            <div><label>åœ°é»ï¼š</label><input type="text" class="session-location" style="width: 100%; padding: 8px;"></div>
            <div><label>é–‹å§‹æ™‚é–“ï¼š</label><select class="session-start-hour">${generateHourOptions()}</select>:<select class="session-start-minute"><option value="00">00</option><option value="30">30</option></select></div>
            <div><label>çµæŸæ™‚é–“ï¼š</label><select class="session-end-hour">${generateHourOptions()}</select>:<select class="session-end-minute"><option value="00">00</option><option value="30">30</option></select></div>
          </div>
        \`;
        list.appendChild(sessionItem);
      }

      function submitWorkshopReservation() {
        const workshopData = {
          unitName: document.getElementById('unitName').value,
          speaker: document.getElementById('speaker').value,
          contactPerson: document.getElementById('contactPerson').value,
          contactPhone: document.getElementById('contactPhone').value,
          hourlyFee: document.getElementById('hourlyFee').value,
          otherFees: document.getElementById('otherFees').value,
          notes: document.getElementById('notes').value,
          sessions: []
        };

        const sessionItems = document.querySelectorAll('.session-item');
        if (sessionItems.length === 0) {
          showMessage('è«‹è‡³å°‘æ–°å¢ä¸€å€‹è¬›åº§å ´æ¬¡', 'error');
          return;
        }

        for (let i = 0; i < sessionItems.length; i++) {
          const item = sessionItems[i];
          const date = item.querySelector('.session-date').value;
          const location = item.querySelector('.session-location').value;
          const startTime = item.querySelector('.session-start-hour').value + ':' + item.querySelector('.session-start-minute').value;
          const endTime = item.querySelector('.session-end-hour').value + ':' + item.querySelector('.session-end-minute').value;
          
          if (!date || !startTime || !endTime || !location) {
            showMessage('è«‹å®Œæ•´å¡«å¯«æ¯ä¸€å€‹å ´æ¬¡çš„æ—¥æœŸã€æ™‚é–“å’Œåœ°é»', 'error');
            return;
          }
          workshopData.sessions.push({ date, location, startTime, endTime });
        }
        
        showLoading();
        google.script.run
          .withSuccessHandler(result => {
            hideLoading();
            if (result.success) {
              showMessage('è¬›åº§é ç´„å·²æˆåŠŸå»ºç«‹ï¼', 'success');
              setTimeout(() => google.script.host.close(), 2000);
            } else {
              showMessage(result.message || 'é ç´„å»ºç«‹å¤±æ•—', 'error');
            }
          })
          .withFailureHandler(error => {
            hideLoading();
            showMessage('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'error');
          })
          .processWorkshopReservation(workshopData);
      }

      function showMessage(message, type) { /* ... æ­¤å‡½å¼å…§å®¹ä¸è®Š ... */ }
    </script>
  `;

  var ui = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(650);
  SpreadsheetApp.getUi().showModalDialog(ui, 'é ç´„è¬›åº§');
}

/**
 * è™•ç†è¬›åº§é ç´„è«‹æ±‚ (å…¨æ–°é‚è¼¯)
 * @param {Object} workshopData - åŒ…å«æ‰€æœ‰è¬›åº§è³‡è¨Šçš„ç‰©ä»¶
 * @return {Object} è™•ç†çµæœ
 */
function processWorkshopReservation(workshopData) {
  try {
    const sheet = ensureWorkshopSheet(); // ç¢ºä¿ç›®æ¨™å·¥ä½œè¡¨å­˜åœ¨
    const now = new Date();
    
    // éæ­·æ‰€æœ‰å ´æ¬¡ä¾†å»ºç«‹ç´€éŒ„å’Œæ—¥æ›†äº‹ä»¶
    workshopData.sessions.forEach((session, index) => {
      const sessionDate = new Date(session.date);
      
      // å‰µå»ºæ—¥æ›†äº‹ä»¶
      const event = createWorkshopCalendarEvent(workshopData, session, index + 1);
      const eventId = event ? event.getId() : "å‰µå»ºå¤±æ•—";

      // åœ¨ã€Œè¬›åº§ç™»éŒ„è³‡æ–™ã€å·¥ä½œè¡¨ä¸­æ–°å¢ä¸€ç­†ç´€éŒ„
      sheet.appendRow([
        now,
        workshopData.unitName,
        workshopData.contactPerson,
        workshopData.contactPhone,
        sessionDate,
        `${session.startTime}-${session.endTime}`,
        workshopData.speaker,
        workshopData.hourlyFee,
        workshopData.otherFees,
        workshopData.notes,
        eventId
      ]);
    });
    
    // è¨˜éŒ„æˆåŠŸæ—¥èªŒ
    logSystemActivity("è¬›åº§é ç´„", workshopData.unitName, `é ç´„ ${workshopData.sessions.length} å ´è¬›åº§æˆåŠŸ`, "æˆåŠŸ", workshopData.speaker);

    return { success: true };
  } catch (error) {
    Logger.log("è™•ç†è¬›åº§é ç´„æ™‚å‡ºç¾éŒ¯èª¤ï¼š" + error.toString());
    logSystemActivity("è¬›åº§é ç´„", workshopData.unitName, `è¬›åº§é ç´„å¤±æ•—: ${error.toString()}`, "å¤±æ•—", workshopData.speaker);
    return { success: false, message: 'è™•ç†é ç´„æ™‚å‡ºç¾éŒ¯èª¤: ' + error.toString() };
  }
}

/**
 * å‰µå»ºè¬›åº§æ—¥æ›†äº‹ä»¶ (å…¨æ–°è³‡è¨Šç‰ˆ)
 * @param {Object} workshopData - åŒ…å«è¬›åº§ä¸»è¦è³‡è¨Šçš„ç‰©ä»¶
 * @param {Object} session - åŒ…å«å–®ä¸€å ´æ¬¡çš„æ—¥æœŸã€æ™‚é–“å’Œåœ°é»
 * @param {number} sessionNumber - å ´æ¬¡ç·¨è™Ÿ
 * @return {CalendarEvent|null} å‰µå»ºçš„æ—¥æ›†äº‹ä»¶
 */
function createWorkshopCalendarEvent(workshopData, session) {
  try {
    const config = getSystemConfig();
    const calendar = CalendarApp.getCalendarById(config.calendarId);
    
    const [startHours, startMinutes] = session.startTime.split(':').map(Number);
    const [endHours, endMinutes] = session.endTime.split(':').map(Number);
    
    const startTime = new Date(session.date);
    startTime.setHours(startHours, startMinutes, 0);
    
    const endTime = new Date(session.date);
    endTime.setHours(endHours, endMinutes, 0);
    
    const title = `ã€è¬›åº§ã€‘${workshopData.unitName} (${workshopData.speaker})`;
    
    // å»ºç«‹åŒ…å«æ‰€æœ‰è©³ç´°è³‡è¨Šçš„æ—¥æ›†äº‹ä»¶æè¿°
    let description = `å–®ä½: ${workshopData.unitName || 'æœªæä¾›'}\n`;
    description += `è¬›è€…: ${workshopData.speaker || 'æœªæä¾›'}\n`;
    description += `åœ°é»: ${session.location}\n\n`;
    description += `--- è¯ç¹«è³‡è¨Š ---\n`;
    description += `è¯ç¹«çª—å£: ${workshopData.contactPerson || 'æœªæä¾›'}\n`;
    description += `è¯ç¹«é›»è©±: ${workshopData.contactPhone || 'æœªæä¾›'}\n\n`;
    description += `--- è²»ç”¨è³‡è¨Š ---\n`;
    description += `é˜é»è²»: ${workshopData.hourlyFee || 'æœªæä¾›'}\n`;
    description += `å…¶ä»–è£œåŠ©è²»ç”¨: ${workshopData.otherFees || 'ç„¡'}\n\n`;
    description += `--- å‚™è¨» ---\n${workshopData.notes || 'ç„¡'}`;
    
    const event = calendar.createEvent(title, startTime, endTime, {
      description: description,
      location: session.location,
    });
    
    if (event) {
      event.setColor(CalendarApp.EventColor.MAUVE); // è¨­å®šç‚ºç´«è‰²
      Logger.log("è¬›åº§æ—¥æ›†äº‹ä»¶å‰µå»ºæˆåŠŸï¼Œä¸¦å·²è¨­å®šé¡è‰²ã€‚");
    }
    
    return event;
  } catch (error) {
    Logger.log("å‰µå»ºè¬›åº§æ—¥æ›†äº‹ä»¶éŒ¯èª¤ï¼š" + error.toString());
    return null;
  }
}

/**
 * ã€å…¨æ–°é€šç”¨å‡½å¼ã€‘å¾ç³»çµ±è¨­å®šå·¥ä½œè¡¨ä¸­ï¼Œæ ¹æ“šå€å¡Šæ¨™é¡Œç²å–å…¶ä¸‹æ–¹çš„é¸é …åˆ—è¡¨
 * @param {string} sectionName - è¦è®€å–çš„å€å¡Šæ¨™é¡Œ (ä¾‹å¦‚ "æœå‹™æ–¹æ¡ˆ", "å¿ƒç†å¸«")
 * @return {Array<string>} è©²å€å¡Šçš„é¸é …åˆ—è¡¨
 */
function getListFromSettings(sectionName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName("ç³»çµ±è¨­å®š");
    
    if (!settingsSheet) {
      // å¦‚æœæ‰¾ä¸åˆ°è¨­å®šè¡¨ï¼Œæä¾›ä¸€å€‹ UI æç¤º
      SpreadsheetApp.getUi().alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åç‚º 'ç³»çµ±è¨­å®š' çš„å·¥ä½œè¡¨ã€‚");
      return [];
    }
    
    const data = settingsSheet.getDataRange().getValues();
    const listItems = [];
    let inTargetSection = false;

    // å¾ç¬¬äºŒè¡Œé–‹å§‹éæ­· (è·³éæ¨™é¡Œ)
    for (let i = 1; i < data.length; i++) {
      const currentCellA = data[i][0].trim(); // ç•¶å‰è¡ŒAæ¬„ä½ (å€å¡Šæ¨™é¡Œ)
      const currentCellB = data[i][1].trim(); // ç•¶å‰è¡ŒBæ¬„ä½ (é¸é …å€¼)

      if (currentCellA !== "") {
        // Aæ¬„æœ‰å€¼ï¼Œä»£è¡¨é€™æ˜¯ä¸€å€‹å€å¡Šçš„é–‹å§‹
        if (inTargetSection) {
          // å¦‚æœæˆ‘å€‘åŸæœ¬å·²ç¶“åœ¨ç›®æ¨™å€å¡Šå…§ï¼Œç¾åœ¨åˆé‡åˆ°æ–°çš„å€å¡Šæ¨™é ­ï¼Œ
          // è¡¨ç¤ºç›®æ¨™å€å¡Šå·²ç¶“çµæŸï¼Œå¯ä»¥åœæ­¢è®€å–ã€‚
          break; 
        }
        if (currentCellA === sectionName) {
          // æ‰¾åˆ°äº†æˆ‘å€‘æƒ³è¦çš„å€å¡Šï¼Œé–‹å§‹è®€å–ã€‚
          inTargetSection = true;
        }
      } else if (inTargetSection && currentCellB !== "") {
        // Aæ¬„æ˜¯ç©ºçš„ï¼Œä¸”æˆ‘å€‘æ­£è™•æ–¼ç›®æ¨™å€å¡Šå…§ï¼Œé€™è¡¨ç¤ºé€™æ˜¯ä¸€å€‹é¸é …ã€‚
        listItems.push(currentCellB);
      }
    }
    
    if (listItems.length === 0) {
        Logger.log(`åœ¨ 'ç³»çµ±è¨­å®š' ä¸­æ‰¾ä¸åˆ°å€å¡Š "${sectionName}" æˆ–è©²å€å¡Šä¸‹æ²’æœ‰ä»»ä½•é …ç›®ã€‚`);
    }

    return listItems;
  } catch (error) {
    Logger.log(`å¾ç³»çµ±è¨­å®šç²å– '${sectionName}' åˆ—è¡¨æ™‚å‡ºéŒ¯: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`è®€å–è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    return []; // ç™¼ç”ŸéŒ¯èª¤æ™‚è¿”å›ç©ºé™£åˆ—
  }
}

/**
 * ç¢ºä¿ã€Œè¬›åº§ç™»éŒ„è³‡æ–™ã€å·¥ä½œè¡¨å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å‰µå»ºå®ƒ
 * @return {Sheet} è¬›åº§ç™»éŒ„è³‡æ–™å·¥ä½œè¡¨ç‰©ä»¶
 */
function ensureWorkshopSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = "è¬›åº§ç™»éŒ„è³‡æ–™";
  let sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    const headers = [
      "æ™‚é–“æˆ³è¨˜", "å–®ä½", "è¯ç¹«çª—å£", "é›»è©±", "è¬›åº§æ—¥æœŸ", 
      "è¬›åº§æ™‚é–“", "è¬›è€…", "é˜é»è²»", "å…¶ä»–è£œåŠ©è²»ç”¨", "å‚™è¨»", "æ—¥æ›†äº‹ä»¶ID"
    ];
    sheet.appendRow(headers);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");
    sheet.setFrozenRows(1);
  }
  return sheet;
}
